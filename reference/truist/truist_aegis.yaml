# =============================================================================
# Aegis Rules Configuration - Truist
# Targeted for Technical Checklist Compliance
# Author: Rakesh Kumar (Rakesh.Kumar@ibm.com)
# Date: 2026-01-18
# =============================================================================

# =============================================================================
# RULE TYPES QUICK REFERENCE
# =============================================================================
# 
# UNIVERSAL RULE TYPES (Apply to ANY text-based project)
# -------------------------------------------------------------------------
# 1.  GENERIC_TOKEN_SEARCH_REQUIRED      - Ensures required tokens exist in files
# 2.  GENERIC_TOKEN_SEARCH_FORBIDDEN     - Ensures forbidden tokens do NOT exist in files
# 3.  XML_XPATH_EXISTS                   - Validates required XPath expressions exist in XML
# 4.  XML_XPATH_NOT_EXISTS               - Validates forbidden XPath expressions do NOT exist in XML
# 5.  XML_ATTRIBUTE_EXISTS               - Ensures required XML attributes exist with correct values
# 6.  XML_ATTRIBUTE_NOT_EXISTS           - Ensures forbidden XML attributes do NOT exist
# 7.  XML_ELEMENT_CONTENT_REQUIRED       - Validates required content exists within XML elements
# 8.  XML_ELEMENT_CONTENT_FORBIDDEN      - Validates forbidden content does NOT exist within XML elements
# 9.  POM_VALIDATION_REQUIRED            - Ensures required POM elements exist (parent, dependencies, plugins, properties)
# 10. POM_VALIDATION_FORBIDDEN           - Ensures forbidden POM elements do NOT exist (dependencies, plugins)
# 11. JSON_VALIDATION_REQUIRED           - Validates required JSON elements exist (e.g., mule-artifact.json, package.json)
# 12. JSON_VALIDATION_FORBIDDEN          - Validates forbidden JSON elements do NOT exist
#
# CONFIG RULE TYPES (Standard Types - Apply to Configuration Projects)
# -------------------------------------------------------------------------
# 1.  MANDATORY_SUBSTRING_CHECK          - Ensures required substrings exist in config files (.properties, .policy)
# 2.  MANDATORY_PROPERTY_VALUE_CHECK     - Validates required properties exist with correct values
# 3.  OPTIONAL_PROPERTY_VALUE_CHECK      - Validates property values IF the property exists
# 4.  GENERIC_TOKEN_SEARCH               - Advanced token search with REGEX support and environment filtering
#
# CONDITIONAL STANDARDS (Universal "If-Then" Engine)
# -------------------------------------------------------------------------
# 1.  CONDITIONAL_CHECK       - Logic engine. Runs 'onSuccess' only if 'preconditions' are met.
# 
# COMMON TRIGGERS (Can be used in 'preconditions'):
# - PROJECT_CONTEXT           - Trigger by Project Name patterns (e.g., contains '-exp-').
# - FILE_EXISTS               - Trigger by file presence (e.g., 'secure-properties.xml').
# - XML_XPATH_EXISTS          - Trigger by XML content (e.g., check for DB/MQ connectors).
# - MANDATORY_PROPERTY_VALUE_CHECK - Trigger by property existence or specific value.
# 
# NOTE: *ANY* check type above can be used as a trigger for the conditional engine!
#
# =============================================================================
# MESSAGE TOKENS
# =============================================================================
# You can use the following tokens in successMessage and errorMessage:
# - {RULE_ID}         : The ID of the rule being executed.
# - {DEFAULT_MESSAGE} : The technical details of the check result. (Alias: {CORE_DETAILS})
# - {CHECKED_FILES}   : The list of files processed by the check. (Alias: {SCANNED_FILES})
# - {FOUND_ITEMS}     : The specific forbidden items found (e.g. 'toApplicationCode', forbidden keys).
# - {MATCHING_FILES}  : The list of files that *passed* the check condition (Success Messages).
# - {PROPERTY_RESOLVED}: Shows if any properties were resolved (e.g. ${app.port} → 8081).
# - {FAILURES}        : The raw list of failure reasons (often contained in DEFAULT_MESSAGE).
# =============================================================================

# =============================================================================
# PROPERTY RESOLUTION
# =============================================================================
# Aegis can resolve property placeholders in XML attributes, XML element content,
# and JSON values before validation. This allows rules to work seamlessly with
# externalized configurations across multiple technologies.
#
# SUPPORTED RULE TYPES:
# - XML_ATTRIBUTE_EXISTS (Attributes)
# - XML_ELEMENT_CONTENT_REQUIRED / FORBIDDEN (Text Content)
# - JSON_VALIDATION_REQUIRED / FORBIDDEN (Values)
#
# SUPPORTED TECHNOLOGIES:
# - Mule:        ${property} or p('property')
# - Spring Boot: ${property}
# - TIBCO:       %%property%% or $_property
# - Python:      ${VAR}
# - Node.js:     process.env.VAR
# - Kubernetes:  $(VAR)
#
# EXAMPLE:
# XML: <version>${app.version}</version>
# Property File: app.version=1.0.0
# Result: Aegis resolves ${app.version} → 1.0.0 before checking
# =============================================================================

config:
  environments:
  - SBX
  - TDV
  - TDV1
  - ATDV
  - IBF
  - MNE
  - PITE
  - ITE
  - PREP
  - DRL
  - PROD
  - DR
  - TRN
  
  # Project type definitions for rule filtering
  projectTypes:
    CODE:
      description: "Mule application projects with source code"
      detectionCriteria:
        markerFiles: ["pom.xml", "mule-artifact.json"]
        excludePatterns: [".*_config.*"]
    
    CONFIG:
      description: "Configuration projects with properties and policies"
      detectionCriteria:
        namePattern: ".*_config.*"
  
  # Identifies valid projects and configuration locations
  projectIdentification:
    # Locates the folder containing environment-specific property files
    configFolder:
      namePattern: .*_config.*  # Regex to match config folder name
    
    # Defines criteria to identify a valid project root for scanning
    targetProject:
      matchMode: ALL  # ALL: Must contain all markers (if multiple logic applies), usually behaves as 'contains at least one of' for list
      markerFiles:    # Existence of ANY of these files marks the folder as a project
      - pom.xml
      - mule-artifact.json

    # Directories to exclude from scanning to improve performance and reduce noise
    ignoredFolders:
      exactNames:     # Exact folder names to skip
      - Aegis-reports
      - rakesh
      - target
      - bin
      - build
      - .git
      - .idea
      - .vscode
      - node_modules
      - __MACOSX
      prefixes:       # Folder names starting with these prefixes to skip
      - .
      - Aegis-reports
      - aegis-report
      - aegis-report-config

    # Files to exclude from scanning globally
    ignoredFiles:
      exactNames: 
      - log4j2-test.xml
      - log4j2.xml
      prefixes:
      - temp_
      
rules:

  # ---------------------------------------------------------------------------
  # POM.XML VALIDATION
  # ---------------------------------------------------------------------------

  # BANK-023: Parent POM
  - id: "RULE-001"
    name: "Validate Parent POM Version"
    description: "Ensures the parent POM version matches the required value"
    appliesTo: ["CODE"]  # Only applies to CODE projects
    enabled: true
    severity: HIGH
    successMessage: "✓ Parent POM version is valid (3.0.0+)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Parent POM version is invalid. Must be com.truist.eapi:MuleParentPom >= 3.0.0\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_REQUIRED' with 'validationType: PARENT' allows you to enforce
    # specific parent POM coordinates and strict minimum versions.
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PARENT
        parent:
          groupId: com.truist.eapi
          artifactId: MuleParentPom
          minVersion: 3.0.0

  # BANK-024: POM Properties
  - id: "BANK-024"
    name: "Validate POM Properties"
    description: "Ensures critical properties satisfy minimum versions."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Critical POM properties (runtime, plugin, cicd,munit) are valid\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Critical POM properties check failed. Ensure mule.maven.plugin.version>=4.6.0, app.runtime>=4.9.LTS, cicd.mule.version>=4.9.LTS, munit.version>=3.5.0\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_REQUIRED' with 'validationType: PROPERTIES' enforces Maven properties.
    # - 'minVersion': Handles semantic versioning logic (e.g. "4.9.LTS" parsing).
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PROPERTIES
        properties:
        - name: mule.maven.plugin.version
          minVersion: 4.6.0
        - name: app.runtime
          minVersion: "4.9.LTS"
        - name: cicd.mule.version
          minVersion: "4.9.LTS"
        - name: munit.version
          minVersion: "3.5.0"

  # BANK-026: Forbidden Plugins
  - id: "BANK-026"
    name: "Forbid Restricted Plugins"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No restricted plugins found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden plugin found (maven-clean, maven-compiler, or munit-maven)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_FORBIDDEN' ensures specific plugins are NOT present.
    # Checks 'plugins' section of pom.xml.
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: PLUGINS
        forbiddenPlugins:
        - groupId: org.apache.maven.plugins
          artifactId: maven-clean-plugin
        - groupId: org.apache.maven.plugins
          artifactId: maven-compiler-plugin

  # BANK-027: Forbidden Dependencies
  - id: "BANK-027"
    name: "Forbid Restricted/Legacy Dependencies"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No restricted or legacy dependencies found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden dependency found (mule-core-ee, javax.mail, or ojdbc8)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_FORBIDDEN' ensures specific dependencies are NOT present.
    # Checks 'dependencies' section of pom.xml.
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: DEPENDENCIES
        forbiddenDependencies:
        - groupId: com.mulesoft.mule.runtime
          artifactId: mule-core-ee
        - groupId: com.mulesoft.mule.runtime.modules
          artifactId: mule-module-spring-config-ee
        - groupId: javax.mail
          artifactId: mail
        - groupId: com.oracle.database.jdbc
          artifactId: ojdbc8
        - groupId: org.springframework.security
          artifactId: spring-security-web
        - groupId: org.springframework.security
          artifactId: spring-security-ldap    

  # BANK-029: Required Dependency
  - id: "BANK-029"
    name: "Adhere to eapimuleutilities Dependency"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ eapimuleutilities dependency found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Missing required dependency: eapimuleutilities\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Enforces the presence of a mandatory dependency (eapimuleutilities).
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: DEPENDENCIES
        dependencies:
        - groupId: com.truist.eapi.crypto
          artifactId: eapimuleutilities

  # BANK-028: Shared Libs
  - id: "BANK-028"
    name: "Forbid Shared Libraries"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No shared libraries found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden shared library found (spring-security)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Scans 'pom.xml' as a text file for forbidden tokens (Shared Libraries).
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["pom.xml"]
        tokens: ["spring-security-ldap", "spring-security-web"]



  # ---------------------------------------------------------------------------
  # MULE ARTIFACT VALIDATION
  # ---------------------------------------------------------------------------

  # MULE-ARTIFACT-VALIDATION: mule-artifact.json validation
  - id: "MULE-ARTIFACT-VALIDATION"
    name: "Validate mule-artifact.json"
    description: "Enforces minMuleVersion 4.9.7, Java 17, and secureProperties."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ mule-artifact.json is valid (Version: 4.9.7, Java: 17)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ mule-artifact.json failed validation. Check minMuleVersion (4.9.7), javaSpecificationVersions (17), or secureProperties\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'JSON_VALIDATION_REQUIRED' enforces structure and values in JSON files.
    # - 'minVersions': Checks semantic versions (e.g. 4.9.7 >= 4.9.0).
    # - 'requiredFields': Checks strict equality for values (e.g. javaVersion == "17").
    # - 'requiredElements': Checks only for existence of a key.
    - type: JSON_VALIDATION_REQUIRED
      params:
        filePattern: mule-artifact.json
        exactVersions:
          minMuleVersion: 4.9.7
        requiredFields:
          javaSpecificationVersions: "17"
        requiredElements:
        - secureProperties


  # ---------------------------------------------------------------------------
  # CODE & IMPLEMENTATION VALIDATION (XML, Java, Config)
  # ---------------------------------------------------------------------------

  # BANK-002: Logger Attributes
  - id: "BANK-002"
    name: "Forbid Legacy Logger Attributes"
    description: "Ensures toApplicationCode and fromApplicationCode are NOT used."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy logger attributes found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden attribute found in Logger\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # This rule uses 'XML_ATTRIBUTE_NOT_EXISTS' for identifying forbidden attributes on specific elements.
    # - Advantages: cleaner configuration than raw XPath.
    # - Alternative: You could use 'XML_XPATH_NOT_EXISTS' with "//set-payload[@toApplicationCode]" but that requires more XML knowledge.
    - type: XML_ATTRIBUTE_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        elements: ["set-payload"]
        forbiddenAttributes: ["toApplicationCode", "fromApplicationCode"]

  # BANK-004: Require jce-encrypt Token (Conditional)
  - id: "BANK-004"
    name: "Require jce-encrypt Token"
    description: "If <crypto:jce-config> appears, it must use type='JKS' (hardcoded or resolved property)."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ JCE Token configuration is valid (or not present)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ JCE Token invalid. <crypto:jce-config> must have type='JKS' (found: {FOUND_ITEMS})\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: CONDITIONAL_CHECK
      params:
        logic: AND
        preconditions:
          - type: XML_XPATH_EXISTS
            params:
              matchMode: ANY_FILE
              xpath: "//*[local-name()='jce-config']"
              filePattern: "**/*.xml"
            description: "Check if jce-config exists"
        onSuccess:
          - type: XML_XPATH_EXISTS
            params:
              xpath: "//*[local-name()='jce-config']/@type"
              expectedValue: "JKS"
              filePattern: "**/*.xml"
              resolveProperties: true
            description: "Ensure type is JKS"

  # BANK-005: SOAP Version
  - id: "BANK-005"
    name: "Validate SOAP Version"
    description: "If apikit-soap:config exists, soapVersion must NOT be SOAP11 or SOAP12 (Deprecated)."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ SOAP configuration is valid (No deprecated versions found)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Invalid SOAP version detected. SOAP11 and SOAP12 are forbidden.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' - Forbidden Logic.
    # Precondition: Checks if 'apikit-soap:config' exists using XML XPath.
    # OnSuccess: Uses XML XPath to forbid specific attribute values (@soapVersion='SOAP_11' etc).
    # This avoids Regex and ensures strict XML structure validation.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: XML_XPATH_EXISTS
          params:
            matchMode: ANY_FILE
            filePatterns: ["src/main/mule/*.xml"]
            # Trigger if any <config> with soapVersion exists (ignoring namespace)
            xpath: "//*[local-name()='config' and @soapVersion]"
          description: "Check if apikit-soap:config exists"
        onSuccess:
        # Check 1: Forbid SOAP11 (with property resolution)
        - type: XML_XPATH_NOT_EXISTS
          params:
            filePatterns: ["src/main/mule/*.xml"]
            xpath: "//*[local-name()='config']/@soapVersion"
            forbiddenValue: "SOAP11"
            resolveProperties: true
          description: "Forbid SOAP11"
        # Check 2: Forbid SOAP12 (with property resolution)
        - type: XML_XPATH_NOT_EXISTS
          params:
            filePatterns: ["src/main/mule/*.xml"]
            xpath: "//*[local-name()='config']/@soapVersion"
            forbiddenValue: "SOAP12"
            resolveProperties: true
          description: "Forbid SOAP12"

  # BANK-031: jce-encrypt-pbe
  - id: "BANK-031"
    name: "Forbid jce-encrypt-pbe Token"
    description: "Detects usage of legacy jce-encrypt-pbe."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy jce-encrypt-pbe tokens found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Found forbidden legacy token (jce-encrypt-pbe)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/mule/*.xml"]
        tokens: ["jce-encrypt-pbe"]
        ignoreComments: true

  # BANK-033: ApiMethod
  - id: "BANK-033"
    name: "Verify apimethod variable has encryptedRequestPath"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ apimethod variable logic is correct\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ apimethod variable logic missing encryptedRequestPath\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Verifies that a specific 'set-variable' logic exists.
    # - Checks if variableName='apimethod' AND its value contains 'vars.encryptedRequestPath'.
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='set-variable' and @variableName='apimethod' and contains(@value, 'vars.encryptedRequestPath')]"
  
  # BANK-036: Autodiscovery
  - id: "BANK-036"
    name: "Require API Autodiscovery"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Autodiscovery is enabled\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Autodiscovery is not enabled\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Simple XML check to ensure the 'autodiscovery' element is present in the configuration.
    # Essential for API Manager integration.
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='autodiscovery']"

  # BANK-040: Java 17 Errors
  - id: "BANK-040"
    name: "Java 8 to 17 Error Class Fields Migration Check"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy error field usages (Java 8/Mule 3X) found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy Java 8 error field usages detected. These fields are removed in Mule 4/Java 17\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Uses REGEX to detect Java 8/Mule 3 error handling patterns forbidden in Java 17/Mule 4.
    # Ref: Migration Guide - Error Object Structure
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/**/*.xml", "src/main/**/*.dwl", "src/main/**/*.java" ]
        tokens: 
        # Mule Message Wrapper (Removed)
        - "error\\.muleMessage"
        - "error\\.muleMessage\\.typedValue"
        - "error\\.muleMessage\\.payload"
        - "error\\.muleMessage\\.attributes\\.StatusCode"
        
        # Error Type String Conversions (Changed)
        - "error\\.errorType\\.asString"
        - "error\\.errorType\\.parentErrorType\\.asString"
        
        # Exception/Cause (Reorganized)
        - "error\\.exception\\.cause"
        - "error\\.exception\\.cause\\.detailMessage"
        - "error\\.exception\\.cause\\.Message"
        - "error\\.exception\\.errorMessage\\.typedValue"
        
        # Other
        - "error\\.errors"
        
        # CONFIG_NOTE: 
        # isRegex: true -> Enables regex pattern matching for tokens.
        # matchMode: ALL_FILES -> Ensures ALL scanned files must pass the check (i.e., contain NO forbidden tokens).
        # (Do not use matchMode: REGEX, it is invalid and defaults to ALL_FILES).
        matchMode: ALL_FILES
        isRegex: true
        ignoreComments: true

  # BANK-019: DLP XML
  - id: "BANK-019"
    name: "Forbid DLP Code Logic"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP logic found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DLP logic detected in HTTP Proxy\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'GENERIC_TOKEN_SEARCH_FORBIDDEN' detects forbidden DLP tokens.
    # - 'resolveProperties: true': Resolves values like ${prot.dlp} before searching.
    # - 'wholeWord: true': Ensures "north.bound.dlp.flag" doesn't match "1north.bound.dlp.flag".
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        resolveProperties: true
        wholeWord: true # Set to 'true' to match exact words (prevents '1north...' from matching 'north...'). Set to 'false' for substring mode.
        failureMessage: "DLP flag choice found"
        filePatterns:
        - "**/http-proxy.xml"
        - "**/*.xml"
        tokens:
        - "north.bound.dlp.flag"
        - "south.bound.dlp.flag"
        - "wmq.dlp.requestqueue"
        #- "raks.dlp.queue"
        ignoreComments: true

  # BANK-020: DLP Properties
  - id: "BANK-020"
    name: "Forbid DLP Properties"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP properties found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DLP property detected (dlp.flag or dlp.requestqueue)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Same strategy as BANK-019 but targeting .properties files.
    # - 'wholeWord: true': Prevents false positives.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        wholeWord: true # Set to 'true' to match exact words. Set to 'false' for substring mode.
        filePatterns: ["**/*.properties"]
        tokens: ["north.bound.dlp.flag", "south.bound.dlp.flag", "wmq.dlp.requestqueue"]
        ignoreComments: true

  # BANK-021: SQL Security
  - id: "BANK-021"
    name: "Enforce SQL Server DB connection String Security"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ SQL Server DB Connection Strings are securely configured (or none found)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ SQL Server DB Connection String missing ';encrypt=false;trustServerCertificate=false'\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Refactored to 'CONDITIONAL_CHECK' to strictly enforce SQL security when SQL is used.
    # 1. Trigger: If 'jdbc:sqlserver' is used in ANY file (Precondition).
    # 2. Check: Then NO file may contain an INSECURE connection string (OnSuccess -> Forbidden).
    #    - Regex Negative Lookahead (?!...) ensures we strictly catch lines MISSING validation.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["**/*.properties"]
            tokens: ["jdbc:sqlserver"]
            matchMode: ANY_FILE # Trigger if at least one file uses SQL Server
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
          params:
            filePatterns: ["**/*.properties"]
            # Regex: Match jdbc:sqlserver line that DOES NOT contain 'encrypt=false'
            # Split into two tokens so it fails if EITHER is missing.
            tokens: 
              - "jdbc:sqlserver(?!.*encrypt=false).*"
              - "jdbc:sqlserver(?!.*trustServerCertificate=false).*"
            matchMode: REGEX
            isRegex: true
            ignoreComments: true
            failureMessage: "Found SQL Server DB Connection String (missing 'encrypt=false' and/or 'trustServerCertificate=false')"

  # DB2 AppId
  - id: "DB2 AppId"
    name: "Enforce DB2 Connection URL contains ApplicationId"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: MEDIUM
    successMessage: "✓ DB2 Connection URL ApplicationId is present\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DB2 Connection URL ApplicationId is missing\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' with Negative Logic (FORBIDDEN).
    # 1. Trigger: If 'jdbc:db2' exists.
    # 2. Check: Fail if any line contains 'jdbc:db2' BUT missing 'ApplicationId=' (using Negative Lookahead).
      - type: "CONDITIONAL_CHECK"
        params:
          preconditions:
            - type: "GENERIC_TOKEN_SEARCH_REQUIRED"
              params:
                filePatterns: ["**/*.properties"]
                tokens: ["jdbc:db2"]
                wholeWord: false
          onSuccess:
            - type: "GENERIC_TOKEN_SEARCH_FORBIDDEN"
              params:
                filePatterns: ["**/*.properties"]
                # Regex: Match jdbc:db2 line that DOES NOT contain 'ApplicationId=' (Case Insensitive)
                tokens: ["jdbc:db2(?!.*(?i)ApplicationId=).*"]
                matchMode: REGEX
                isRegex: true
                failureMessage: "Found DB2 Connection URL missing 'ApplicationId'"

  # Legacy DB2 VIPs
  - id: "Legacy DB2 VIPs"
    name: "Forbid Legacy DB2 VIPs"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy DB2 VIPs found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy DB2 VIP connection detected. Migrate to DVIPA (dsndb0e/h)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Detects hardcoded legacy connection strings in property files.
    # Blocking these ensures teams migrate to the new DVIPA standard.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/*.properties"]
        tokens: ["db2contppvip.truist-tst.com:50000", "db2contstvip.truist-tst.com:50000", "wil-db2contstvip.bbtnet.com:50000"]

  # MQ Cipher Suite Validation in Code
  - id: "MQ Cipher Suite Validation in Code"
    name: "Validate MQ Cipher Suite in Code"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ MQ Cipher Suite is correct (or not applicable)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ MQ Cipher Suite is incorrect. Must be TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' runs nested rules ('onSuccess') ONLY if 'preconditions' match.
    # - Usage: "If IBM MQ is used (precondition from xml), THEN enforce Cipher Suite property (onSuccess)."
    # - Precondition checks XML for 'ibm-mq:config'.
    # - OnSuccess uses Regex Negative Lookahead to forbidden improper ciphers in .properties.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["src/main/mule/*.xml"]
            tokens: ["ibm-mq:config"]
            matchMode: SUBSTRING
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
          params:
            filePatterns: ["src/main/resources/**/*.properties"]
            # FAIL if we find 'ibm.mq.cipherSuite=' followed by ANYTHING other than our safe cipher.
            tokens: ["ibm\\.mq\\.cipherSuite\\s*=(?!\\s*TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384).*"]
            matchMode: REGEX
            isRegex: true

  # MQ Cipher Suite Validation in Config
  - id: "MQ Cipher Suite Validation in Config"
    name: "Validate MQ Cipher Suite in Config"
    description: "Ensures ibm.mq.cipherSuite uses the secure value IF it is defined."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ MQ Cipher Suite is correct (or not defined)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ MQ Cipher Suite is incorrect. Must be TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # This rule runs on CONFIG projects where we cannot check for <ibm-mq:config> existence.
    # It strictly validates the property value IF the key exists.
    # Uses GENERIC_TOKEN_SEARCH_FORBIDDEN with Negative Lookahead Regex.
    # - Matches if: 'ibm.mq.cipherSuite=' found AND value is NOT the required string.
    # - Passes if: Key not found OR Key found with correct value.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/*.properties"]
        tokens: ["ibm\\.mq\\.cipherSuite\\s*=(?!\\s*TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384).*"]
        matchMode: REGEX
        isRegex: true

  # ---------------------------------------------------------------------------
  # POLICY & ENVIRONMENT VALIDATION (Config Files)
  # ---------------------------------------------------------------------------

  # Header Injection Policy Validation in Config
  - id: "Header Injection Policy Validation in Config"
    name: "Header Injection Policy (WARN mode logging)"
    appliesTo: ["CONFIG"]  # Only applies to CONFIG projects
    enabled: true
    severity: HIGH
    successMessage: "✓ Header Injection policy configured correctly (WARN mode logging)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Header Injection policy values must be 'WARN mode logging'\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'MANDATORY_PROPERTY_VALUE_CHECK' validates configuration values across ALL environments.
    # - Ensures 'x-tfc-request-out' is set to 'WARN'.
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        environments: ['ALL']
        properties:
        - name: headerinjection.policy.inboundheadermap.x-tfc-request-out
          values: ['WARN']
        - name: headerinjection.policy.inboundheadermap.x-tfc-response-in
          values: ['WARN']

  # BANK-008: Legacy Auth
  - id: "BANK-008"
    name: "Forbid Legacy Auth Policies"
    description: "Detects old AAA or Basic Auth policies."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy Auth policies found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy Auth policy detected (Truist-AAA or TruistBasicAuthnPolicy). Upgrade to CompositeAuth\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Uses simple token search to find deprecated policy names in XML/Policy files.
    # 'matchMode' defaults to 'SUBSTRING', finding any instance of these strings.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        tokens: ["Truist-AAA-SOAP", "Truist-AAA-HTTP", "TruistBasicAuthnPolicy"]

  # BANK-109: Policy Versions
  - id: "BANK-109"
    name: "Enforce Policy Versions"
    description: "Validates all Truist policy versions."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ All policy versions are correct\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Policy version mismatch found (Check report for details)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Validates exact version numbers for internal policies in config files.
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        environments: ['ALL']
        properties:
        - name: truist.compositeauthn.policy.version
          values: ['3.0.0']
        - name: truist.authz.policy.version
          values: ['3.0.0']
        - name: noname.policy.version
          values: ['5.1.0']
        - name: ratelimit.policy.version
          values: ['1.4.1']
        - name: headerinjection.policy.version
          values: ['1.3.2']
        - name: headerremoval.policy.version
          values: ['1.1.2']
        - name: truist.wssencdec.policy.version
          values: ['3.0.0']
        - name: truist.jsonencdec.policy.version
          values: ['3.0.0']

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparison Branch Analysis - GitAnalyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .border-purple { border-color: #6f42c1 !important; }
        .text-purple { color: #6f42c1 !important; }
        .btn-outline-purple {
            color: #6f42c1;
            border-color: #6f42c1;
        }
        .btn-outline-purple:hover {
            color: #fff;
            background-color: #6f42c1;
            border-color: #6f42c1;
        }
        .form-control, .form-select {
            border-color: #6f42c1 !important;
            /* font-weight: normal; Default is normal */
        }
        .form-label {
            font-weight: bold;
        }
        .btn {
            font-weight: bold;
        }
        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25);
            border-color: #6f42c1;
        }
    </style>
</head>
<body class="bg-light">
    
    <div class="raks-frame">
        <!-- Header -->
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light brand-header mb-0 flex-shrink-0">
            <div class="container-fluid position-relative">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="assets/images/logo.png" alt="Logo" class="d-inline-block align-text-top me-2" height="40">
                    ApiGuard Portal - GitAnalyzer
                </a>
                
                <!-- Centered Title -->
                <div class="position-absolute start-50 translate-middle-x d-none d-lg-block">
                    <h5 class="fw-bold text-purple mb-0">Comparison Analysis Tool</h5>
                </div>

                <div class="d-flex ms-auto">
                    <a href="guide.html" class="btn btn-purple me-2 d-flex align-items-center" target="_blank">
                        <span class="me-2">üìò</span> Guide / Help
                    </a>
                    <button type="button" class="btn btn-outline-purple me-2 d-flex align-items-center" onclick="clearForm()">
                        <span class="me-2">üóëÔ∏è</span> Clear Form
                    </button>
                    <a href="/" class="btn btn-outline-light ghost-btn">Dashboard</a>
                </div>
            </div>
        </nav>

        <!-- Split Layout -->
        <div class="split-container">
            <!-- Left Panel: Configuration -->
            <div class="split-left" id="leftPanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold text-purple">Analysis Config</h5>
                    <!-- Provider & Token Compact -->
                    <div class="input-group input-group-sm w-auto shadow-sm">
                        <span class="input-group-text bg-white text-purple"><i class="bi bi-shield-lock-fill"></i></span>
                        <select class="form-select border-start-0" id="gitProviderSelect" style="max-width: 100px;">
                             <option value="gitlab">GitLab</option>
                             <option value="github">GitHub</option>
                        </select>
                        <input type="password" class="form-control" id="gitTokenInput" placeholder="Token Optional" style="max-width: 120px;">
                    </div>
                </div>

                <form id="analysisForm">
                    <!-- Section 1: Discovery -->
                    <div class="sub-frame mb-3">
                        <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">1. Repository Discovery</h6>
                        <div class="mb-2">
                            <label class="form-label small fw-bold">Git Group / Organization</label>
                            <input type="text" class="form-control form-control-sm" id="groupName" placeholder="e.g. raks-group">
                        </div>
                        <div class="mb-2">
                             <label class="form-label small fw-bold">Filter (Regex)</label>
                             <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="repoFilter" placeholder="e.g. .*service.*">
                                <button type="button" class="btn btn-sub-action" id="fetchReposBtn">Fetch</button>
                             </div>
                        </div>
                        
                        <!-- Repo List -->
                        <div id="repoListContainer" class="border rounded bg-white p-2 d-none" style="max-height: 120px; overflow-y: auto;">
                            <div class="text-muted small text-center fst-italic py-2">Fetched repositories...</div>
                        </div>
                    </div>

                    <!-- Section 2: Analysis Scope -->
                    <div class="sub-frame mb-4">
                        <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">2. Analysis Scope</h6>
                        
                        <div class="mb-3">
                            <label for="codeRepo" class="form-label small fw-bold">Code Repository</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="codeRepo" placeholder="Select above or type" required>
                                <button type="button" class="btn btn-sub-action" id="fetchBranchesBtn">Branches</button>
                            </div>
                        </div>

                            <label class="form-label small fw-bold">Branch Comparison</label>
                            <div class="d-flex align-items-end gap-2 mb-3">
                                <div class="w-50">
                                    <label class="form-label x-small text-muted mb-1">Base (Destination)</label>
                                    <select class="form-select form-select-sm" id="sourceBranchSelect"></select>
                                </div>
                                <div class="mb-1">
                                    <button type="button" class="btn btn-sub-action py-0 px-2" id="swapBranchesBtn" title="Swap" style="height: 31px;">
                                        <i class="bi bi-arrow-left-right"></i>
                                    </button>
                                </div>
                                <div class="w-50">
                                    <label class="form-label x-small text-muted mb-1">Feature (Source)</label>
                                    <select class="form-select form-select-sm" id="targetBranchSelect"></select>
                                </div>
                            </div>

                        <!-- Config Repo -->
                        <div class="mb-3">
                            <div class="form-check form-switch mb-1">
                                <input class="form-check-input" type="checkbox" id="enableConfigRepo" checked>
                                <label class="form-check-label small fw-bold" for="enableConfigRepo">Analyze Config Repository</label>
                            </div>
                            <div id="configSection" class="ps-2 border-start border-3 border-light transition-all">
                                <div class="input-group input-group-sm mb-2">
                                     <input type="text" class="form-control" id="configRepo" placeholder="owner/repo_config">
                                     <button class="btn btn-sub-action" type="button" id="fetchConfigBranchesBtn">Branches</button>
                                </div>
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="configSourceSelect">
                                            <option value="" selected>Config Base</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="configTargetSelect">
                                            <option value="" selected>Config Feature</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="form-label small fw-bold">File Ignore (Glob)</label>
                            <textarea class="form-control form-control-sm font-monospace" id="ignorePatterns" rows="2" placeholder=".gitignore patterns..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Content Ignore (Regex)</label>
                            <textarea class="form-control form-control-sm" id="contentPatterns" rows="2" placeholder="e.g. regex:DEBUG_LOG"></textarea>
                        </div>
                        

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="ignoreAttributeOrder" style="border: 1px solid #663399;">
                            <label class="form-check-label small fw-bold d-flex align-items-center" for="ignoreAttributeOrder">
                                Smart XML Compare
                                <span class="ms-1" data-bs-toggle="tooltip" data-bs-placement="right" title="Ignores insignificant whitespace and attribute order for cleaner XML diffs.">
                                    <i class="bi bi-info-circle text-muted" style="cursor:help;"></i>
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn btn-purple text-white w-100 py-2 shadow-sm" id="analyzeBtn">Run Analysis</button>
                    </div>
                </form>
            </div>

            <!-- Resizer -->
            <div class="resizer" id="dragMe"></div>

            <!-- Right Panel: Results -->
            <div class="split-right" id="rightPanel">
                <!-- Initial Placeholder -->
                <div id="resultsPlaceholder" class="text-center mt-5 text-muted">
                    <img src="assets/images/logo.png" height="100" class="mb-3">
                    <h4>Ready to Analyze</h4>
                    <p>Configure repository details on the left and click "Run Analysis".</p>
                </div>

                <!-- Results Section (Hidden by default) -->
                <div id="resultsSection" class="d-none animate-fade-in">
                     <div class="d-flex justify-content-between align-items-center mb-4">
                         <h4 class="text-purple fw-bold">Analysis Report</h4>
                         <span class="badge bg-light text-dark border"><span id="reportTime"></span></span>
                     </div>

                    <!-- Dashboard Stats -->
                    <div class="row g-4 mb-4">
                    <!-- Dashboard Stats (Compact) -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="dashboard-card-sm card-purple text-center d-flex flex-column justify-content-center">
                                <i class="bi bi-layers-fill fs-4 text-purple opacity-50 mb-1"></i>
                                <h6 class="text-purple small mb-0 fw-bold">Total Files</h6>
                                <h3 class="fw-bold text-purple mb-0" id="totalFiles">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card-sm card-code text-center d-flex flex-column justify-content-center">
                                <i class="bi bi-code-slash fs-4 text-secondary opacity-50 mb-1"></i>
                                <h6 class="text-purple small mb-0 fw-bold">Code Changes</h6>
                                <h3 class="fw-bold text-purple mb-0" id="codeChanges">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="dashboard-card-sm card-config text-center d-flex flex-column justify-content-center">
                                <i class="bi bi-gear fs-4 text-info opacity-50 mb-1"></i>
                                <h6 class="text-purple small mb-0 fw-bold">Config Changes</h6>
                                <h3 class="fw-bold text-purple mb-0" id="configChanges">0</h3>
                            </div>
                        </div>
                        <!-- Severity Chart -->
                        <div class="col-md-3">
                            <div class="dashboard-card-sm card-purple p-1 d-flex align-items-center justify-content-center">
                                <div style="height: 90px; width: 100%;">
                                     <canvas id="severityChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <!-- Detailed Changes -->
                    <div class="card shadow-sm mb-5 border-purple">
                        <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Detailed File Changes</h5>
                            <button class="btn btn-sub-action" onclick="exportToCSV()">Export CSV</button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 align-middle">
                                    <thead class="bg-light">
                                        <tr class="text-purple small fw-bold text-uppercase">
                                            <th>Type</th>
                                            <th>File Path</th>
                                            <th>Status</th>
                                            <th>Valid Lines</th>
                                            <th>Ignored Lines</th>
                                            <th>Severity</th>
                                            <th>Diff</th>
                                        </tr>
                                    </thead>
                                    <tbody id="filesTableBody">
                                        <!-- Rows injected via JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Footer -->
        </div>
    
        <!-- Footer -->
        <footer class="raks-footer text-center mt-auto flex-shrink-0 w-100">
            <div class="container" id="footerText">
                &copy; 2026 RAKS - Enterprise API Solution Suite - ApiGuard
            </div>
        </footer>
    </div>
    <!-- End Raks Frame -->
    
    <!-- Hover Diff Popup -->
    <div id="diffPreviewPopup" class="diff-preview-popup">
        <div class="diff-preview-header">
            <span>Diff Preview</span>
            <small class="text-muted">Click row for full view</small>
        </div>
        <div id="diffPreviewContent" class="diff-preview-body p-2">
            <!-- Content Injected Here -->
        </div>
    </div>
    
    <script>
        // --- Modal Logic ---
        const analyzingModal = new bootstrap.Modal(document.getElementById('analyzingModal'));
        
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Show Analyzing Modal
            analyzingModal.show();
            
            // Gather Data
            const data = {
                provider: document.getElementById('gitProviderSelect').value,
                token: document.getElementById('gitTokenInput').value,
                group: document.getElementById('groupName').value,
                repoFilter: document.getElementById('repoFilter').value,
                codeRepo: document.getElementById('codeRepo').value,
                sourceBranch: document.getElementById('sourceBranchSelect').value,
                targetBranch: document.getElementById('targetBranchSelect').value,
                
                configRepo: document.getElementById('enableConfigRepo').checked ? document.getElementById('configRepo').value : null,
                configSourceBranch: document.getElementById('configSourceSelect').value,
                configTargetBranch: document.getElementById('configTargetSelect').value,
                
                ignorePatterns: document.getElementById('ignorePatterns').value.split('\n').filter(l => l.trim().length > 0),
                contentPatterns: document.getElementById('contentPatterns').value,
                ignoreAttributeOrder: document.getElementById('ignoreAttributeOrder').checked
            };
            
            try {
                const response = await fetch('/api/analyze', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) throw new Error((await response.json()).error || 'Analysis failed');
                
                const report = await response.json();
                
                // Show Success State in Modal
                document.getElementById('analyzingBody').classList.add('d-none');
                document.getElementById('analysisSuccessBody').classList.remove('d-none');
                
                // Wait for User to Click "View Results" which dismisses modal
                // But we need to render results first or when dismissed
                renderReport(report);
                
            } catch (err) {
                // Close modal and show error
                analyzingModal.hide();
                alert('Analysis Error: ' + err.message);
            }
        });
        
        // Reset Modal on Hide
        document.getElementById('analyzingModal').addEventListener('hidden.bs.modal', () => {
             document.getElementById('analyzingBody').classList.remove('d-none');
             document.getElementById('analysisSuccessBody').classList.add('d-none');
        });

        function renderReport(report) {
             document.getElementById('totalFiles').innerText = report.totalFiles;
             document.getElementById('codeChanges').innerText = report.codeChanges;
             document.getElementById('configChanges').innerText = report.configChanges;
             document.getElementById('reportTime').innerText = report.timestamp;
             
             // Render Table
             const tbody = document.getElementById('filesTableBody');
             tbody.innerHTML = '';
             report.details.forEach(d => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                    <td><span class="badge ${d.type === 'CODE' ? 'bg-code' : 'bg-config'}">${d.type}</span></td>
                    <td class="small font-monospace text-break">${d.file}</td>
                    <td><span class="badge ${d.status === 'MODIFIED' ? 'bg-modified' : (d.status === 'NEW' ? 'bg-success' : 'bg-deleted')}">${d.status}</span></td>
                    <td>${d.validLines}</td>
                    <td>${d.ignoredLines}</td>
                    <td><span class="badge ${d.severity === 'CRITICAL' ? 'bg-critical' : (d.severity === 'HIGH' ? 'bg-danger' : 'bg-secondary')}">${d.severity}</span></td>
                    <td>
                        <button class="btn btn-sm ghost-btn py-0 diff-btn" data-diff="${encodeURIComponent(d.diff)}">View</button>
                    </td>
                 `;
                 
                 // Hover Preview Logic
                 const diffBtn = tr.querySelector('.diff-btn');
                 diffBtn.addEventListener('mouseenter', (e) => {
                     showDiffPreview(e, decodeURIComponent(d.diff));
                     diffPopup.style.display = 'block';
                 });
                 diffBtn.addEventListener('mouseleave', () => {
                     diffPopup.style.display = 'none';
                 });
                 diffBtn.addEventListener('mousemove', (e) => {
                     diffPopup.style.top = (e.pageY + 15) + 'px';
                     diffPopup.style.left = (e.pageX + 15) + 'px';
                 });
                 diffBtn.addEventListener('click', () => {
                      showModalDiff(d.file, decodeURIComponent(d.diff));
                 });
                 
                 tbody.appendChild(tr);
             });
             
             // Update Chart
             updateChart(report.severityCounts);
             
             // Show Resuls
             document.getElementById('resultsPlaceholder').classList.add('d-none');
             document.getElementById('resultsSection').classList.remove('d-none');
        }

        // --- Chart Logic ---
        let severityChartInstance = null;
        function updateChart(counts) {
            const ctx = document.getElementById('severityChart').getContext('2d');
            if(severityChartInstance) severityChartInstance.destroy();
            
            severityChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'High', 'Low', 'Info'],
                    datasets: [{
                        data: [counts.CRITICAL || 0, counts.HIGH || 0, counts.LOW || 0, counts.INFO || 0],
                        backgroundColor: ['#ff4500', '#dc3545', '#ffc107', '#0dcaf0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    cutout: '70%'
                }
            });
        }
        
        function showModalDiff(file, diff) {
             document.getElementById('diffModalTitle').innerText = "File Diff: " + file;
             const targetElement = document.getElementById('diffContainer');
             const diff2htmlUi = new Diff2HtmlUI(targetElement, diff, {
                drawFileList: false,
                matching: 'lines',
                outputFormat: 'side-by-side',
             });
             diff2htmlUi.draw();
             new bootstrap.Modal(document.getElementById('diffModal')).show();
        }

        // Fetch UI Config (Footer & Header)
        fetch('/api/config/ui')
            .then(r => r.json())
            .then(c => {
                if (c['ui.footer.text']) document.getElementById('footerText').innerText = c['ui.footer.text'];
                // Clean Header Title Implementation
                if (c['ui.header.analysis']) {
                    const headerTitle = document.querySelector('.position-absolute h5');
                    if(headerTitle) headerTitle.innerText = c['ui.header.analysis'];
                }
            })
            .catch(e => console.error(e));
    </script>
    
    <!-- Diff Modal -->
    <div class="modal fade" id="diffModal" tabindex="-1" aria-labelledby="diffModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title font-monospace small" id="diffModalTitle">File Diff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="diffContainer" class="p-3"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Analyzing Status Modal -->
    <div class="modal fade" id="analyzingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-left: 5px solid #663399 !important;">
                <div class="modal-body text-center p-5" id="analyzingBody">
                    <div class="spinner-border text-purple mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="fw-bold text-purple">Analyzing Repositories...</h5>
                    <p class="text-muted mb-0">Please wait while we compare branches and generate the report.</p>
                </div>
                <!-- Success State (Hidden initially) -->
                 <div class="modal-body text-center p-5 d-none" id="analysisSuccessBody">
                     <i class="bi bi-check-circle-fill text-success display-1 mb-3"></i>
                     <h4 class="fw-bold text-success">Analysis Complete!</h4>
                     <p class="text-muted">The report has been generated successfully.</p>
                     <button type="button" class="btn btn-purple btn-lg px-5 mt-3" data-bs-dismiss="modal">View Results</button>
                 </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header brand-header">
                    <h5 class="modal-title fw-bold" id="helpModalTitle">GitAnalyzer - User Guide & Documentation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- About -->
                    <section class="mb-5">
                        <h4 class="text-purple border-bottom pb-2 mb-3">1. Overview</h4>
                        <p class="lead text-muted">GitAnalyzer is a specialized tool for performing semantic-aware comparisons between Git branches. Unlike standard diff tools, it distinguishes between "meaningful" code changes and "noise" (formatting, attribute reordering, or ignored content), making it ideal for auditing migrations, configuration updates, and release verification.</p>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-light h-100">
                                    <h6 class="fw-bold">Semantic Difference</h6>
                                    <p class="small mb-0">Detects real logic changes while ignoring superficial ordering differences in XML or JSON.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-light h-100">
                                    <h6 class="fw-bold">Dual-Repo Analysis</h6>
                                    <p class="small mb-0">Simultaneously analyzes code repositories and their associated configuration repositories.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 border rounded bg-light h-100">
                                    <h6 class="fw-bold">Audit Ready</h6>
                                    <p class="small mb-0">Generates comprehensive reports with categorized severity and exportable evidence.</p>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Configuration -->
                    <section class="mb-5">
                        <h4 class="text-purple border-bottom pb-2 mb-3">2. Configuration Guide</h4>
                        
                        <div class="accordion" id="helpAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#helpConfig">
                                        Analysis Configuration
                                    </button>
                                </h2>
                                <div id="helpConfig" class="accordion-collapse collapse show" data-bs-parent="#helpAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-bordered table-sm">
                                            <thead class="table-light"><tr><th>Field</th><th>Description</th></tr></thead>
                                            <tbody>
                                                <tr><td class="fw-bold">Git Provider</td><td>Select your hosting provider (GitLab/GitHub). Enter a Personal Access Token (PAT) if accessing private repositories.</td></tr>
                                                <tr><td class="fw-bold">Repository Discovery</td><td>Use Regex filters (e.g. <code>.*service.*</code>) to find relevant repositories within a Group/Org.</td></tr>
                                                <tr><td class="fw-bold">Analysis Scope</td><td>Select the Code Repository. Define <strong>Base Branch</strong> (Destination, e.g. <code>master</code>) and <strong>Feature Branch</strong> (Source, e.g. <code>feature/login</code>).</td></tr>
                                                <tr><td class="fw-bold">Config Repository</td><td>Toggle "Analyze Config Repository" to include external config. The tool attempts to auto-match config branches (e.g. code <code>wip</code> -> config <code>wip</code>).</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#helpIgnore">
                                        Advanced Filtering & Smart Compare
                                    </button>
                                </h2>
    <!-- Highlight.js CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" />
    <!-- Diff2Html CSS (Bundle) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/diff2html/bundles/css/diff2html.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Highlight.js & Diff2Html (Bundle) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/diff2html/bundles/js/diff2html-ui.min.js"></script>

    <script>
        // --- Persistence Logic ---
        const STORE_KEY_PROVIDER = 'git_analyzer_provider';
        const STORE_KEY_TOKEN = 'git_analyzer_token';

        const providerSelect = document.getElementById('gitProviderSelect');
        const tokenInput = document.getElementById('gitTokenInput');

        // Restore Provider/Token
        if (providerSelect && tokenInput) {
             const savedProvider = localStorage.getItem(STORE_KEY_PROVIDER);
             if (savedProvider) providerSelect.value = savedProvider;
    
             const savedToken = localStorage.getItem(STORE_KEY_TOKEN);
             if (savedToken) tokenInput.value = savedToken;
    
             providerSelect.addEventListener('change', () => localStorage.setItem(STORE_KEY_PROVIDER, providerSelect.value));
             tokenInput.addEventListener('input', () => localStorage.setItem(STORE_KEY_TOKEN, tokenInput.value));
        }

        // Restore Form Fields
        // Removed apiName from persistence
        const FIELDS_TO_PERSIST = ['groupName', 'repoFilter', 'codeRepo', 'configRepo', 'ignorePatterns'];
        
        FIELDS_TO_PERSIST.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const val = localStorage.getItem('git_analysis_' + id);
                if (val) el.value = val;
                
                el.addEventListener('input', () => {
                    localStorage.setItem('git_analysis_' + id, el.value);
                });
            }
        });

        // Config Toggle Button Logic
        const configBtn = document.getElementById('toggleConfigBtn');
        const collapseEl = document.getElementById('setupCollapse');
        if (configBtn && collapseEl) {
            collapseEl.addEventListener('shown.bs.collapse', () => {
                configBtn.textContent = 'Hide Config';
            });
            collapseEl.addEventListener('hidden.bs.collapse', () => {
                configBtn.textContent = 'Show Config';
            });
        }

        // Helper to get Headers
        function getGitHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            if (providerSelect) headers['X-Git-Provider'] = providerSelect.value;
            if (tokenInput && tokenInput.value.trim()) headers['X-Git-Token'] = tokenInput.value.trim();
            return headers;
        }

        let availableRepositories = []; // Cache to store fetched repos

        // --- Fetch Repos Logic ---
        document.getElementById('fetchReposBtn').addEventListener('click', async () => {
             const group = document.getElementById('groupName').value;
             const filter = document.getElementById('repoFilter').value;
             const btn = document.getElementById('fetchReposBtn');
             const originalText = btn.textContent;
             
             btn.classList.add('disabled');
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fetching...';
             
             try {
                let url = '/api/download/list'; // Reuse Bulk API
                const params = new URLSearchParams();
                if (group) params.append('group', group);
                if (filter) params.append('filter', filter);
                
                const response = await fetch(url + '?' + params.toString(), { headers: getGitHeaders() });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch repositories');
                }
                
                // Update Cache
                availableRepositories = data.repositories || [];
                
                const container = document.getElementById('repoListContainer');
                container.innerHTML = '';
                container.classList.remove('d-none');

                if (availableRepositories.length > 0) {
                    availableRepositories.forEach((repo, index) => {
                        const div = document.createElement('div');
                        div.className = 'form-check';
                        // Create unique ID
                        const id = 'repo_' + index;
                        div.innerHTML = `
                            <input class="form-check-input repo-radio" type="radio" name="selectedRepo" id="${id}" value="${repo}">
                            <label class="form-check-label small" for="${id}">${repo}</label>
                        `;
                        container.appendChild(div);
                        
                        // Event Listener for Selection
                        div.querySelector('input').addEventListener('change', (e) => {
                             if(e.target.checked) {
                                 const selected = e.target.value;
                                 document.getElementById('codeRepo').value = selected;
                                 localStorage.setItem('git_analysis_codeRepo', selected);
                                 
                                 // Auto-Detect Config Repo
                                 const configName = selected + "_config";
                                 const configMatch = availableRepositories.find(r => r === configName); // Strict Exact Match from list
                                 
                                 const configInput = document.getElementById('configRepo');
                                 if (configMatch) {
                                     configInput.value = configMatch;
                                     // Highlight effect
                                     configInput.classList.add('border-warning', 'bg-warning-subtle');
                                     setTimeout(() => {
                                          configInput.classList.remove('border-warning', 'bg-warning-subtle');
                                     }, 2000);
                                     localStorage.setItem('git_analysis_configRepo', configMatch);
                                 } else {
                                     configInput.value = '';
                                     localStorage.removeItem('git_analysis_configRepo');
                                 }
                             }
                        });
                    });
                } else {
                    container.innerHTML = '<div class="text-muted small text-center p-2">No repositories found.</div>';
                }
             } catch (err) {
                 alert('Error fetching repositories: ' + err.message);
                 console.error(err);
             } finally {
                 btn.classList.remove('disabled');
                 btn.textContent = originalText;
             }
        });

        // --- Fetch Branches Logic ---
        document.getElementById('fetchBranchesBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const repo = document.getElementById('codeRepo').value;
            if (!repo) {
                alert("Please enter or select a Code Repository first.");
                return;
            }
            
            const btn = document.getElementById('fetchBranchesBtn');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fetching...';
            
            try {
                const response = await fetch('/api/download/branches?repo=' + encodeURIComponent(repo), {
                    headers: getGitHeaders()
                });
                const branches = await response.json(); // API returns List<String>
                
                // Helper to populate select
                const populateSelect = (elementId, selectedValue) => {
                    const select = document.getElementById(elementId);
                    select.innerHTML = '';
                    if (branches && branches.length > 0) {
                        branches.forEach(br => {
                            const opt = document.createElement('option');
                            opt.value = br;
                            opt.textContent = br;
                            select.appendChild(opt);
                        });
                        if (selectedValue && branches.includes(selectedValue)) {
                            select.value = selectedValue;
                        }
                    } else {
                         const opt = document.createElement('option');
                         opt.text = "No branches found";
                         select.appendChild(opt);
                    }
                };
                
                // Smart Selection Logic
                // branches is the array
                let sourceVal = branches.includes('master') ? 'master' : (branches.includes('main') ? 'main' : branches[0]);
                
                // For target, prefer 'develop', then any branch != sourceVal
                let targetVal = branches.includes('develop') ? 'develop' : null;
                if (!targetVal && branches.length > 1) {
                    targetVal = branches.find(b => b !== sourceVal) || sourceVal;
                } else if (!targetVal) {
                    targetVal = sourceVal;
                }

                populateSelect('sourceBranchSelect', sourceVal);
                populateSelect('targetBranchSelect', targetVal);

            } catch(err) {
                 alert('Error fetching branches: ' + err.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        });

        // --- Swap Branches Logic ---
        document.getElementById('swapBranchesBtn').addEventListener('click', () => {
             // Swap Code Branches
             const s = document.getElementById('sourceBranchSelect');
             const t = document.getElementById('targetBranchSelect');
             const temp = s.value;
             s.value = t.value;
             t.value = temp;
             
             // Swap Config Branches
             const cs = document.getElementById('configSourceSelect');
             const ct = document.getElementById('configTargetSelect');
             const tempC = cs.value;
             cs.value = ct.value;
             ct.value = tempC;
        });
        
        // --- Config Toggle Logic ---
        const configCheckbox = document.getElementById('enableConfigRepo');
        const configSection = document.getElementById('configSection');
        
        function updateConfigVisibility() {
            if (configCheckbox.checked) {
                configSection.classList.remove('opacity-50', 'pe-none');
            } else {
                configSection.classList.add('opacity-50', 'pe-none');
            }
        }
        configCheckbox.addEventListener('change', updateConfigVisibility);
        // Initial state
        updateConfigVisibility();

        // --- Config Fetch Branches ---
        document.getElementById('fetchConfigBranchesBtn').addEventListener('click', async () => {
            const btn = document.getElementById('fetchConfigBranchesBtn');
            const repo = document.getElementById('configRepo').value.trim();
            if (!repo) { alert('Please enter a Config Repository first'); return; }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            try {
                const url = `/api/download/branches?repo=${encodeURIComponent(repo)}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('Status ' + response.status);
                
                const branches = await response.json();
                
                // Helper to populate
                const populate = (id) => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = '<option value="" selected>Default (Same as Code Repo)</option>';
                    branches.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.text = b;
                        sel.appendChild(opt);
                    });
                    return sel;
                };
                
                const cSource = populate('configSourceSelect');
                const cTarget = populate('configTargetSelect');
                
                // --- Smart Auto-Select Logic ---
                const codeBase = document.getElementById('sourceBranchSelect').value;
                const codeFeature = document.getElementById('targetBranchSelect').value;
                
                // 1. Sync Config Base with Code Base (e.g. master -> master)
                if (codeBase && branches.includes(codeBase)) {
                    cSource.value = codeBase;
                }
                
                // 2. Sync Config Feature with Code Feature (e.g. wip -> wip OR wipnew)
                if (codeFeature) {
                    if (branches.includes(codeFeature)) {
                        cTarget.value = codeFeature;
                    } else {
                        // Heuristic: Fuzzy Match or Single Candidate
                        const selectedBase = cSource.value;
                        const candidates = branches.filter(b => b !== selectedBase);
                        
                        // Strategy A: Starts With (e.g. wip -> wipnew)
                        const fuzzy = candidates.find(b => b.startsWith(codeFeature));
                        if (fuzzy) {
                            cTarget.value = fuzzy;
                        } 
                        // Strategy B: Only one branch left (and it's distinct from base)
                        else if (candidates.length === 1) {
                            cTarget.value = candidates[0];
                        }
                    }
                }
                
            } catch(err) {
                 alert('Error fetching config branches: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // --- Analysis Logic ---
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('analyzeBtn');
            const originalText = btn.textContent;
            
            const codeRepo = document.getElementById('codeRepo').value;
            
            // Config Repo Logic
            let configRepo = null;
            let configSource = null;
            let configTarget = null;
            
            if (document.getElementById('enableConfigRepo').checked) {
                configRepo = document.getElementById('configRepo').value;
                configSource = document.getElementById('configSourceSelect').value;
                configTarget = document.getElementById('configTargetSelect').value;
            }

            // Auto-derive API name if needed
            let apiName = '';
            if (codeRepo) {
                const parts = codeRepo.split('/');
                apiName = parts[parts.length - 1]; // Use last part of repo
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analyzing...';

            try {

            const payload = {
                apiName: apiName || 'Manual Analysis',
                codeRepo: codeRepo,
                configRepo: configRepo,
                sourceBranch: document.getElementById('sourceBranchSelect').value,
                targetBranch: document.getElementById('targetBranchSelect').value,
                configSource: configSource,
                configTarget: configTarget,
                filePatterns: document.getElementById('ignorePatterns').value,
                contentPatterns: document.getElementById('contentPatterns').value,
                ignoreAttributeOrder: document.getElementById('ignoreAttributeOrder').checked
            };

            // Capture branch names for Diff Title
            const sBranch = document.getElementById('sourceBranchSelect').value;
            const tBranch = document.getElementById('targetBranchSelect').value;
            window.currentAnalysisBranches = { source: sBranch, target: tBranch };
            
            // showLoading(true); // This line seems to be cut off or misplaced in the original instruction. Assuming it was meant to be before the fetch call.
            const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: getGitHeaders(),
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Analysis Request Failed');
                
                const result = await response.json();
                
                // Collapse Input Card
                // Collapse Input Card (Manual DOM manipulation to avoid Bootstrap API errors)
                // Collapse Input Card
                const collapseEl = document.getElementById('setupCollapse');
                if (collapseEl) {
                    // Use Bootstrap API to ensure events fire, or manually update button
                    collapseEl.classList.remove('show');
                    const toggleBtn = document.getElementById('toggleConfigBtn');
                    if (toggleBtn) toggleBtn.textContent = 'Show Config';
                }
                
                renderResults(result);

            } catch (err) {
                alert('Error: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });


        // --- Fetch Repos Logic ---
        document.getElementById('fetchReposBtn').addEventListener('click', async () => {
             const group = document.getElementById('groupName').value.trim();
             const filter = document.getElementById('repoFilter').value.trim();
             const btn = document.getElementById('fetchReposBtn');
             
             if(!group) { alert('Please enter a Git Group / Organization'); return; }

             const originalText = btn.textContent;
             btn.disabled = true;
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
             
             try {
                let url = `/api/download/list?group=${encodeURIComponent(group)}`;
                if(filter) url += `&filter=${encodeURIComponent(filter)}`;
                
                const resp = await fetch(url, { headers: getGitHeaders() });
                if(!resp.ok) throw new Error(`Fetch failed: ${resp.status}`);
                
                const data = await resp.json();
                const container = document.getElementById('repoListContainer');
                container.classList.remove('d-none');
                container.innerHTML = ''; 

                if(data.repositories && data.repositories.length > 0) {
                    data.repositories.forEach((r, idx) => {
                        const div = document.createElement('div');
                        div.className = 'small py-1 border-bottom d-flex align-items-center';
                        div.innerHTML = `
                             <div class="form-check m-0">
                                <input class="form-check-input" type="radio" name="repoRadio" id="repo_${idx}" value="${r}">
                                <label class="form-check-label text-break" for="repo_${idx}" style="cursor:pointer">
                                    <i class="bi bi-git me-1 text-purple"></i>${r}
                                </label>
                            </div>
                        `;
                        // Click on div selects radio
                        div.addEventListener('click', (e) => {
                             // Prevent double toggle if clicking label/input directly
                             if(e.target.tagName !== 'INPUT' && e.target.tagName !== 'LABEL') {
                                 const radio = div.querySelector('input[type="radio"]');
                                 radio.checked = true;
                                 radio.dispatchEvent(new Event('change'));
                             }
                        });
                        
                        div.querySelector('input').addEventListener('change', () => {
                             const codeRepo = document.getElementById('codeRepo');
                             codeRepo.value = r;
                             codeRepo.dispatchEvent(new Event('input')); // Trigger auto-populate
                             
                             // Highlight
                             Array.from(container.children).forEach(c => c.classList.remove('bg-light', 'fw-bold'));
                             div.classList.add('bg-light', 'fw-bold');
                        });
                        
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-muted text-center small mt-2">No repositories found.</div>';
                }
             } catch(e) {
                 console.error(e);
                 alert('Error fetching repositories: ' + e.message);
             } finally {
                 // Ensure we query the button again to set properties if reference lost
                 const safeBtn = document.getElementById('fetchReposBtn');
                 if(safeBtn) {
                    safeBtn.disabled = false;
                    safeBtn.textContent = 'Fetch'; // Hard reset to ensure text clears
                 }
             }
        });

        // --- Resizer Logic ---
        const resizer = document.getElementById('dragMe');
        const leftPanel = document.getElementById('leftPanel');
        let x = 0;
        let leftWidth = 0;

        const mouseDownHandler = function (e) {
            x = e.clientX;
            leftWidth = leftPanel.getBoundingClientRect().width;
            resizer.classList.add('resizing');
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.body.style.userSelect = 'none';
        };

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - x;
            const newLeftWidth = leftWidth + dx;
            if (newLeftWidth > 250 && newLeftWidth < 800) {
                 leftPanel.style.width = `${newLeftWidth}px`;
            }
        };

        const mouseUpHandler = function () {
            resizer.classList.remove('resizing');
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.body.style.removeProperty('user-select');
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
        
        // --- Hover Preview Logic ---
        const diffPopup = document.getElementById('diffPreviewPopup');
        const diffContentDiv = document.getElementById('diffPreviewContent');

        function showDiffPreview(e, content) {
            if(!content) return;
            
            // Refined Logic & Coloring
            const lines = content.split('\n');
            let innerHTML = '<div class="small fw-bold text-purple mb-2 border-bottom pb-1">Diff Preview</div>';
            
            let count = 0;
            for(let line of lines) {
                if (count >= 15) {
                    innerHTML += '<div class="text-muted small mt-1">... (Click for full diff)</div>';
                    break;
                }
                
                // Skip git headers
                if (line.startsWith('diff --git') || line.startsWith('index ') || 
                    line.startsWith('new file') || line.startsWith('deleted file') ||
                    line.startsWith('---') || line.startsWith('+++') || line.startsWith('@@')) {
                    continue;
                }

                if (line.startsWith('+')) {
                    innerHTML += `<div class="diff-add-high" style="white-space: pre-wrap;">${line.replace(/</g, '&lt;')}</div>`;
                    count++;
                } else if (line.startsWith('-')) {
                    innerHTML += `<div class="diff-del-high" style="white-space: pre-wrap;">${line.replace(/</g, '&lt;')}</div>`;
                    count++;
                } else if (line.trim().length > 0) { // Show context lines if valid
                    innerHTML += `<div class="text-muted" style="white-space: pre-wrap;">${line.replace(/</g, '&lt;')}</div>`;
                    count++;
                }
            }
            
            diffContentDiv.innerHTML = innerHTML; // Use innerHTML for colors
            
            // Position
            const rect = e.target.getBoundingClientRect();
            diffPopup.style.display = 'block';
            diffPopup.style.top = (rect.top + window.scrollY + 10) + 'px'; // Slightly higher
            // Align right if too close to edge
            if (window.innerWidth - rect.right < 600) {
                 diffPopup.style.left = (rect.left - 600) + 'px';
            } else {
                 diffPopup.style.left = (rect.left + 20) + 'px';
            }
        }

        function hideDiffPreview() {
            diffPopup.style.display = 'none';
        }

        let currentResults = null;
        let diffDetails = {}; // Store diffs map
        let severityChart = null;


        function renderResults(data) {
            currentResults = data;
            document.getElementById('resultsPlaceholder').classList.add('d-none');
            document.getElementById('resultsSection').classList.remove('d-none');
            document.getElementById('reportTime').textContent = new Date().toLocaleString('en-US', { timeZoneName: 'short' });
            
            // Filter Stats (Exclude NONE severity from counts if they are Smart Matched/Ignored)
            // Assuming NONE implies it was filtered out by smart logic or has no meaningful changes
            const meaningfulFiles = data.modifiedFiles.filter(f => f.severity !== 'NONE');
            const codeFiles = meaningfulFiles.filter(f => f.type === 'CODE');
            const configFiles = meaningfulFiles.filter(f => f.type === 'CONFIG');

            document.getElementById('totalFiles').textContent = meaningfulFiles.length; // Show meaningful count
            document.getElementById('codeChanges').textContent = codeFiles.length;
            document.getElementById('configChanges').textContent = configFiles.length;

            const tbody = document.getElementById('filesTableBody');
            tbody.innerHTML = '';
            diffDetails = {}; // Reset

            if (data.modifiedFiles && data.modifiedFiles.length > 0) {
                data.modifiedFiles.forEach((file, index) => {
                    const fileId = 'file_' + index;
                    diffDetails[fileId] = file.diffContent; // content

                    let statusBadge = '<span class="badge bg-modified">MODIFIED</span>';
                    let rowClass = '';
                    
                    if (file.severity === 'NONE') {
                        statusBadge = '<span class="badge bg-secondary opacity-50">SMART MATCHED</span>';
                        rowClass = 'table-light text-muted opacity-75'; // Dimmed row
                    } else {
                        if (file.newFile) statusBadge = '<span class="badge bg-success">NEW</span>';
                        if (file.deletedFile) statusBadge = '<span class="badge bg-deleted">DELETED</span>';
                    }

                    let severityClass = 'bg-secondary';
                    if (file.severity === 'LOW') severityClass = 'bg-info text-dark';
                    if (file.severity === 'MEDIUM') severityClass = 'bg-warning text-dark';
                    if (file.severity === 'CRITICAL') severityClass = 'bg-critical';
                    if (file.severity === 'NONE') severityClass = 'bg-light text-muted border'; // Visually distinct
                
                    let typeBadge = `<span class="badge bg-secondary">${file.type}</span>`;
                    if (file.type === 'CODE') typeBadge = '<span class="badge bg-code"><i class="bi bi-code-slash me-1"></i>CODE</span>';
                    if (file.type === 'CONFIG') typeBadge = '<span class="badge bg-config"><i class="bi bi-gear me-1"></i>CONFIG</span>';

                    const tr = document.createElement('tr');
                    if(rowClass) tr.className = rowClass;
                    
                    tr.innerHTML = `
                        <td>${typeBadge}</td>
                        <td class="small fw-bold font-monospace text-primary text-truncate" style="max-width: 250px;" title="${file.path}">
                            ${file.path}
                        </td>
                        <td>${statusBadge}</td>
                        <td class="small text-success">+${file.validChangedLines}</td>
                        <td class="small text-muted">${file.ignoredLines}</td>
                        <td><span class="badge ${severityClass}">${file.severity}</span></td>
                        <td>
                            <button class="btn btn-sm btn-sub-action py-0" 
                                onclick="showDiff('${fileId}', '${file.path}')"
                                onmouseenter="showDiffPreview(event, diffDetails['${fileId}'])"
                                onmouseleave="hideDiffPreview()"
                            >View Diff</button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } else {
                 tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No changes found matching the criteria.</td></tr>';
            }


            renderCharts(data);
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({behavior: 'smooth'});
        }

        // Initialize Tooltips & Fetch UI Config
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

            // Fetch UI Config
            fetch('/api/config/ui')
                .then(response => response.json())
                .then(config => {
                    if (config['ui.header.analysis']) {
                        const headerTitle = document.querySelector('.navbar .position-absolute h5');
                        if (headerTitle) headerTitle.textContent = config['ui.header.analysis'];
                    }
                    if (config['ui.footer.text']) {
                        const footerText = document.getElementById('footerText');
                        if (footerText) footerText.innerHTML = config['ui.footer.text']; // Use innerHTML for HTML entities like &copy;
                    }
                })
                .catch(err => console.error('Error loading UI config:', err));
        });

        function clearForm() {
            if(confirm("Are you sure you want to clear all inputs?")) {
                document.getElementById('analysisForm').reset();
                // Clear dropdowns manually if needed or other specific UI states
                document.getElementById('repoListContainer').classList.add('d-none');
                document.getElementById('repoListContainer').innerHTML = '';
            }
        }

        function renderCharts(data) {
             const ctx = document.getElementById('severityChart').getContext('2d');
             
             if (severityChart) {
                 severityChart.destroy();
             }

             const config = {
                 type: 'doughnut',
                 data: {
                     labels: ['Critical', 'Medium', 'Low'],
                     datasets: [{
                         data: [
                             data.modifiedFiles.filter(f => f.severity === 'CRITICAL').length,
                             data.modifiedFiles.filter(f => f.severity === 'MEDIUM').length,
                             data.modifiedFiles.filter(f => f.severity === 'LOW').length
                         ],
                         backgroundColor: ['#ff4500', '#ffc107', '#0dcaf0'],
                         hoverOffset: 4
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         legend: {
                             position: 'bottom',
                             labels: { usePointStyle: true, boxWidth: 8 }
                         }
                     }
                 }
             };
             
             severityChart = new Chart(ctx, config);
        }

        // --- Auto-Populate Config Repo Logic ---
        // Listen for Code Repo Change
        const codeRepoInput = document.getElementById('codeRepo');
        const configRepoInput = document.getElementById('configRepo');
        
        // Helper to detect change (input or selection)
        const updateConfigRepo = () => {
             const val = codeRepoInput.value.trim();
             if (val && !configRepoInput.value) { // Only if config is empty
                 configRepoInput.value = val + '_config';
             }
        };

        codeRepoInput.addEventListener('input', updateConfigRepo);
        codeRepoInput.addEventListener('change', updateConfigRepo);
        
        // Also trigger when a radio is selected (since we use a hidden radio logic)
        // We already have a listener on line 1010 that updates codeRepo.value. 
        // We can hook into the codeRepo 'change' event or manually call it there.
        // Let's rely on the input/change listener above, but ensure the radio logic dispatches a change event.
        
        // --- Analysis Submit / Modal Logic ---
        document.getElementById('analysisForm').addEventListener('submit', async (e) => {
             e.preventDefault();
             
             // Show Modal
             const modalEl = document.getElementById('analysisModal');
             const modal = new bootstrap.Modal(modalEl, {backdrop: 'static', keyboard: false});
             modal.show();
             
             // Reset UI in Modal
             document.getElementById('analysisSpinner').classList.remove('d-none');
             document.getElementById('analysisSuccess').classList.add('d-none');
             
             const formData = new FormData(e.target);
             const params = new URLSearchParams(formData);

             try {
                 const response = await fetch('/api/analyze?' + params.toString(), {
                     method: 'POST'
                 });
                 if (!response.ok) throw new Error('Analysis failed: ' + await response.text());
                 
                 const data = await response.json();
                 
                 // Show Success in Modal
                 document.getElementById('analysisSpinner').classList.add('d-none');
                 document.getElementById('analysisSuccess').classList.remove('d-none');
                 
                 // Render Results
                 renderResults(data);
                 
                 // Close Modal after brief delay
                 setTimeout(() => {
                     modal.hide();
                 }, 1000);
                 
             } catch (err) {
                 console.error(err);
                 alert('Error: ' + err.message);
                 modal.hide();
             }
        });

        function exportCSV() {
             if (!currentResults || !currentResults.modifiedFiles) {
                 alert("No data to export");
                 return;
             }
             
             const headers = ["Type", "File Path", "Status", "Valid Lines", "Ignored Lines", "Severity"];
             const rows = currentResults.modifiedFiles.map(f => [
                 f.type,
                 f.path,
                 f.newFile ? 'NEW' : (f.deletedFile ? 'DELETED' : 'MODIFIED'),
                 f.validChangedLines,
                 f.ignoredLines,
                 f.severity
             ]);
             
             let csvContent = "data:text/csv;charset=utf-8," 
                 + headers.join(",") + "\n" 
                 + rows.map(e => e.join(",")).join("\n");
                 
             const encodedUri = encodeURI(csvContent);
             const link = document.createElement("a");
             link.setAttribute("href", encodedUri);
             link.setAttribute("download", "analysis_report_" + new Date().getTime() + ".csv");
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
        }

        // --- Diff Modal Logic ---
        const diffModalVar = new bootstrap.Modal(document.getElementById('diffModal'));

        function showDiff(fileId, path) {
             const content = diffDetails[fileId];
             document.getElementById('diffModalTitle').textContent = path;
             
             const container = document.getElementById('diffModalContent');
             if(content) {
                 container.innerHTML = content;
             } else {
                 container.innerText = "No diff content available.";
             }
             
             diffModalVar.show();
        }
    </script>

    <!-- Diff View Modal -->
    <div class="modal fade" id="diffModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" style="height: 90vh;">
            <div class="modal-content h-100">
                <div class="modal-header bg-light opacity-100"> <!-- ensure visibility -->
                    <h5 class="modal-title font-monospace small" id="diffModalTitle">File Diff</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0 bg-white">
                    <pre class="m-0 p-3 h-100" id="diffModalContent" style="font-size: 0.85em; overflow: auto; white-space: pre-wrap;"></pre>
                </div>
            </div>
        </div>
    </div>
</body>
</html>



<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raks API Discovery & Governance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #663399; /* Corporate Purple */
            --secondary-color: #03dac6;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --header-bg: #663399;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); }
        header { background-color: var(--header-bg); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .brand { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .tabs { display: flex; gap: 1rem; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #e0e0e0; cursor: pointer; border-radius: 4px; font-weight: 500; transition: all 0.2s; }
        .tab.active { background: var(--primary-color); color: white; }

        .card { background: var(--card-bg); border-radius: 8px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; border: 2px solid var(--primary-color); }
        .card h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Breadcrumbs */
        .breadcrumbs { background: #f0f0f0; padding: 10px 15px; border-radius: 4px; margin-bottom: 20px; font-size: 0.9rem; border-left: 4px solid var(--primary-color); }
        .breadcrumbs strong { color: var(--primary-color); }
        .breadcrumbs span { color: #666; margin: 0 5px; }

        /* Wizard Steps */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        
        button { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: background 0.3s; }
        button:hover { background-color: #4a148c; }
        button.secondary { background-color: #757575; }
        button.small { padding: 5px 10px; font-size: 0.8rem; }
        
        /* Grid/List View */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; max-height: 400px; overflow-y: auto; padding: 5px; }
        .grid-container.list-view { grid-template-columns: 1fr; }
        
        .grid-item { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
        .list-view .grid-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        
        .grid-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-color: var(--primary-color); }
        .list-view .grid-item:hover { transform: none; background-color: #f9f9f9; }
        
        .grid-item.selected { background-color: #f3e5f5; border-color: var(--primary-color); border-width: 2px; }
        
        .grid-item h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .grid-item p { margin: 0; font-size: 0.9rem; color: #666; word-break: break-all; }
        
        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f9f9f9; color: #555; }
        
        .progress-bar-container { width: 100%; background-color: #ddd; border-radius: 4px; margin-top: 10px; height: 10px; overflow: hidden; display: none; }
        .progress-bar { height: 100%; background-color: var(--secondary-color); width: 0%; transition: width 0.3s; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 8px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; font-weight: bold; color: #666; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px; color: white; }
        .badge.mule { background-color: #00a1df; }
        .badge.spring { background-color: #6db33f; }
        .badge.python { background-color: #ffe873; color: #333; }
        .badge.tibco { background-color: #ce000c; }
        
        .view-controls { display: flex; gap: 5px; align-items: center; }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <img src="assets/logo.svg" alt="Raks Logo" style="height: 30px;">
        Raks API Discovery
    </div>
    <div>
        <a href="guide.html" target="_blank" style="color: white; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 5px; border: 1px solid white; padding: 5px 10px; border-radius: 4px;">
            üìò Guide / Help
        </a>
    </div>
</header>

<div class="container">
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('discovery')">üîç API Discovery</div>
        <div class="tab" onclick="switchTab('correlation')">üîó Traffic Correlation</div>
        <div class="tab" onclick="switchTab('history')">üìú Scan History</div>
    </div>

    <!-- TAB: DISCOVERY (WIZARD) -->
    <div id="tab-discovery" class="tab-content">
        <div class="card">
            
            <!-- Step 1: Connect -->
            <div id="step-1" class="wizard-step active">
                <h2>Step 1: Connect to GitLab</h2>
                <div class="form-group">
                    <label>GitLab URL</label>
                    <input type="text" id="gitlabUrl" value="https://gitlab.com">
                </div>
                <div class="form-group">
                    <label>Access Token (Private Token)</label>
                    <!-- Pre-populated token as requested -->
                    <input type="password" id="gitlabToken" value="glpat-8xWKilsBixw-i6hMcR1FvW86MQp1OmplYXcwCw.01.120yhiotd">
                </div>
                <p style="font-size: 0.9rem; color: #666; margin-top: -10px; margin-bottom: 15px;">
                    <em>Note: To scan your personal projects, you can enter your Username as the "Group" in the next steps (or just fetch groups normally if available).</em>
                </p>
                <button onclick="fetchGroups()">Fetch Groups &rarr;</button>
            </div>

            <!-- Step 2: Select Group -->
            <div id="step-2" class="wizard-step">
                <h2>Step 2: Select a Group</h2>
                <div class="breadcrumbs" id="bc-step-2">Connected to GitLab <span>&gt;</span> <strong>Select Group</strong></div>
                
                <button class="secondary" onclick="prevStep(1)">&larr; Back</button>
                <p>Select the group you want to scan.</p>
                
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                     <input type="text" id="manualGroupInput" placeholder="Or enter Group Name/ID (e.g. raksjnu)">
                     <button onclick="manualGroupSelect()" style="padding: 5px 10px; font-size: 0.9rem;">Go</button>
                </div>
                <div id="groups-grid" class="grid-container"></div>
            </div>

            <!-- Step 3: Select Projects -->
            <div id="step-3" class="wizard-step">
                <h2>
                    Step 3: Select Projects
                    <div class="view-controls">
                        <button class="small secondary" onclick="setViewMode('grid')" title="Grid View">Tiles</button>
                        <button class="small secondary" onclick="setViewMode('list')" title="List View">List</button>
                    </div>
                </h2>
                <div class="breadcrumbs" id="bc-step-3">GitLab <span>&gt;</span> <span id="bc-group-name">Group</span> <span>&gt;</span> <strong>Select Projects</strong></div>
                
                <button class="secondary" onclick="prevStep(2)">&larr; Back</button>
                <p>Select one or more projects to include in the scan.</p>
                
                <div style="margin-bottom: 10px;">
                    <button onclick="selectAllProjects()">Select All</button>
                    <button class="secondary" onclick="deselectAllProjects()">Deselect All</button>
                </div>
                
                <div id="projects-grid" class="grid-container"></div>
                
                <br>
                <button onclick="nextStep(4)">Configure Scan &rarr;</button>
            </div>

            <!-- Step 4: Configure & Run -->
            <div id="step-4" class="wizard-step">
                <h2>Step 4: Scan Configuration</h2>
                <div class="breadcrumbs" id="bc-step-4">GitLab <span>&gt;</span> <span id="bc-group-name-4">Group</span> <span>&gt;</span> Projects Selected <span>&gt;</span> <strong>Configure</strong></div>
                
                <button class="secondary" onclick="prevStep(3)">&larr; Back</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Scan Mode</label>
                    <select id="scanMode">
                        <option value="full">Full Analysis (Code + Metadata)</option>
                        <option value="metadata">Metadata Only (Fast - Owner, Certs, Docs)</option>
                    </select>
                </div>
                
                <div id="scan-review">
                    <p><strong>Selected Target:</strong> <span id="review-target-count">0</span> Projects</p>
                </div>

                <button onclick="startWizardScan()">üöÄ Start Scan</button>
                
                <div id="scan-progress-container" class="progress-bar-container">
                    <div id="scan-progress-bar" class="progress-bar"></div>
                </div>
                <div id="scan-status-text" style="margin-top: 10px; font-style: italic;"></div>
            </div>
        </div>
    </div>

    <!-- TAB: CORRELATION -->
    <div id="tab-correlation" class="tab-content" style="display:none;">
        <div class="card">
            <h2>Traffic Correlation Engine</h2>
            <p>Paste network traffic logs (IPs, Hostnames, or Domains) to find which Repository they belong to.</p>
            <div class="form-group">
                <textarea id="trafficInput" rows="10" placeholder="192.168.1.50&#10;api.finance.raks.com&#10;payment-service-prod"></textarea>
            </div>
            <button onclick="runCorrelation()">Analyze Traffic</button>
            <div id="correlation-results" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- TAB: HISTORY -->
    <div id="tab-history" class="tab-content" style="display:none;">
        <div class="card">
            <h2>Scan History</h2>
            
             <div class="stats-container" style="display:flex; gap:20px; align-items:center; margin-bottom: 20px;">
                <div class="stat-card" style="background:#eee; padding:10px; border-radius:4px;">
                    <div class="value" id="total-scans" style="font-weight:bold;font-size:1.2rem;">0</div>
                    <div class="label" style="font-size:0.8rem;">Total Scans</div>
                </div>
                <div class="stat-card" style="background:#eee; padding:10px; border-radius:4px;">
                    <div class="value" id="ignored-count" style="font-weight:bold;font-size:1.2rem;">0</div>
                    <div class="label" style="font-size:0.8rem;">Ignored Items</div>
                </div>
            </div>

            <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="secondary" onclick="exportWorkspace()">üíæ Export Workspace</button>
                <button class="secondary" onclick="document.getElementById('import-file').click()">üìÇ Import Workspace</button>
                <input type="file" id="import-file" style="display: none;" onchange="importWorkspace(this)">
            </div>

            <button onclick="loadHistory()">Refresh List</button>
            <table id="history-table">
                <thead><tr><th>Scan ID</th><th>Date</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
 
 </div>
 
 <!-- RESULTS MODAL -->
 <div id="resultsModal" class="modal">
     <div class="modal-content">
         <span class="close-btn" onclick="document.getElementById('resultsModal').style.display='none'">&times;</span>
         <h2 id="modalTitle">Scan Results</h2>
         <div id="modalBody"></div>
         <button onclick="document.getElementById('resultsModal').style.display='none'" style="margin-top:20px;">Close</button>
     </div>
 </div>
 
 <script>
     let currentStep = 1;
     let selectedGroup = null;
     let selectedProjects = [];
     let gitlabToken = '';
     
     // --- UI Controls ---
     function switchTab(tabName) {
         document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
         document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
         document.getElementById('tab-' + tabName).style.display = 'block';
         event.currentTarget.classList.add('active');
         if(tabName === 'history') loadHistory();
     }

     function setViewMode(mode) {
         const grid = document.getElementById('projects-grid');
         if(mode === 'list') grid.classList.add('list-view');
         else grid.classList.remove('list-view');
     }

     function showStep(step) {
         document.querySelectorAll('.wizard-step').forEach(d => d.classList.remove('active'));
         document.getElementById('step-' + step).classList.add('active');
         currentStep = step;
     }
     function nextStep(step) { showStep(step); }
     function prevStep(step) { showStep(step); }

     // --- API Utils ---
     function getApiPath(endpoint) {
        return window.location.pathname.includes('apiguard') 
            ? '/apiguard/apidiscovery/api' + endpoint 
            : '/api' + endpoint; // local fallback
     }

     // --- Wizard Flow ---
     async function fetchGroups() {
         const token = document.getElementById('gitlabToken').value;
         const url = document.getElementById('gitlabUrl').value;
         if(!token) return alert("Please enter a GitLab Token");
         gitlabToken = token;

         try {
             const res = await fetch(`${getApiPath('/gitlab/groups')}?token=${encodeURIComponent(token)}&baseUrl=${encodeURIComponent(url)}`);
             if(!res.ok) throw new Error("Failed to fetch groups. Check Token/Network.");
             const groups = await res.json();
             
             const grid = document.getElementById('groups-grid');
             grid.innerHTML = '';
             groups.forEach(g => {
                 const div = document.createElement('div');
                 div.className = 'grid-item';
                 div.innerHTML = `<h3>${g.name}</h3><p>${g.full_path}</p>`;
                 div.onclick = () => selectGroup(g);
                 grid.appendChild(div);
             });
             nextStep(2);
         } catch(e) {
             console.error(e);
             alert("Error: " + e.message);
         }
     }

     function manualGroupSelect() {
         const groupName = document.getElementById('manualGroupInput').value;
         if(!groupName) return alert("Enter a group name");
         selectGroup({ id: groupName, name: groupName, full_path: groupName });
     }
 
     async function selectGroup(group) {
         selectedGroup = group;
         // Update Breadcrumbs
         document.getElementById('bc-group-name').innerText = group.name;
         document.getElementById('bc-group-name-4').innerText = group.name;
         
         const token = document.getElementById('gitlabToken').value;
         try {
             const res = await fetch(`${getApiPath('/gitlab/projects')}?token=${encodeURIComponent(token)}&groupId=${group.id}`);
             const projects = await res.json();
             
             const grid = document.getElementById('projects-grid');
             grid.innerHTML = '';
             selectedProjects = [];
             
             if(projects.length === 0) grid.innerHTML = '<p>No projects found.</p>';

             projects.forEach(p => {
                 const div = document.createElement('div');
                 div.className = 'grid-item';
                 div.innerHTML = `
                     <div>
                        <h3>${p.name}</h3>
                        <p>${p.path_with_namespace || p.web_url}</p>
                     </div>
                     <button class="secondary small" onclick="event.stopPropagation(); ignoreItem('${p.http_url_to_repo}', this)">üö´ Ignore</button>
                 `;
                 div.dataset.id = p.id;
                 div.onclick = () => toggleProjectSelection(div, p);
                 grid.appendChild(div);
             });
             nextStep(3);
         } catch(e) {
             alert("Error fetching projects: " + e.message);
         }
     }
 
     function toggleProjectSelection(el, project) {
         if(el.classList.contains('selected')) {
             el.classList.remove('selected');
             selectedProjects = selectedProjects.filter(p => p.id !== project.id);
         } else {
             el.classList.add('selected');
             selectedProjects.push(project);
         }
         
         // Update selected count display if needed (added a badge logic or bottom bar could be cool)
         document.getElementById('review-target-count').innerText = selectedProjects.length;
     }
     
     function selectAllProjects() {
         document.querySelectorAll('#projects-grid .grid-item').forEach(el => {
            if (!el.classList.contains('selected')) el.click();
         });
     }
     
     function deselectAllProjects() {
         document.querySelectorAll('#projects-grid .grid-item').forEach(el => {
            if (el.classList.contains('selected')) el.click();
         });
     }
 
     async function startWizardScan() {
         if(selectedProjects.length === 0) return alert("No projects selected!");
         const token = document.getElementById('gitlabToken').value;
         const scanMode = document.getElementById('scanMode').value;
         
         document.getElementById('scan-progress-container').style.display = 'block';
         const progressBar = document.getElementById('scan-progress-bar');
         const statusText = document.getElementById('scan-status-text');
 
         let completed = 0;
         statusText.innerText = `Starting scan for ${selectedProjects.length} projects...`;
 
         for(const proj of selectedProjects) {
             statusText.innerText = `Scanning ${proj.name} (${scanMode})...`;
             try {
                 await fetch(getApiPath('/scan'), {
                     method: 'POST',
                     body: JSON.stringify({ 
                         source: proj.http_url_to_repo, 
                         token: token,
                         group: selectedGroup.name,
                         mode: scanMode // Backend needs to support this
                     })
                 });
                 completed++;
                 progressBar.style.width = ((completed / selectedProjects.length) * 100) + '%';
             } catch(e) {
                 console.error(e);
                 statusText.innerText += ` Failed: ${proj.name}`;
             }
         }
         
         statusText.innerText = "All scans initiated! Check Scan History tab.";
         // Force reload history
         setTimeout(() => switchTab('history'), 2000);
     }
 
     // --- Correlation & History ---
     async function runCorrelation() {
         const input = document.getElementById('trafficInput').value;
         if(!input.trim()) return alert("Enter some traffic data");
         
         try {
             const res = await fetch(getApiPath('/correlate'), { method: 'POST', body: input });
             const results = await res.json();
             
             const container = document.getElementById('correlation-results');
             if(results.length === 0) {
                 container.innerHTML = "<h3>No matches found in scanned repositories.</h3>";
                 return;
             }
             
             let html = "<h3>Correlation Matches:</h3><table><tr><th>Traffic Item</th><th>Matched Repo</th><th>Confidence</th></tr>";
             results.forEach(r => {
                 html += `<tr><td>${r.traffic_item}</td><td><b>${r.matched_repo}</b></td><td>${r.confidence}</td></tr>`;
             });
             html += "</table>";
             container.innerHTML = html;
         } catch (e) { alert("Correlation error: " + e); }
     }
 
     async function ignoreItem(url, btnElement) {
         if(!confirm("Ignore this item?")) return;
         await fetch(getApiPath('/ignore'), { method: 'POST', body: url });
         // Visual removal
         if(btnElement) {
           const card = btnElement.closest('.grid-item');
           if(card) {
               card.style.opacity = '0.5';
               card.style.pointerEvents = 'none';
               // If selected, deselect
               if(card.classList.contains('selected')) card.click();
           }
         }
     }
 
     async function loadHistory() {
         try {
             const res = await fetch(getApiPath('/scans/list'));
             if(!res.ok) throw new Error("API Error");
             const list = await res.json();
             
             const tbody = document.querySelector('#history-table tbody');
             tbody.innerHTML = '';
             
             if(list.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="3">No scans found.</td></tr>';
             }

             list.forEach(item => {
                 const tr = document.createElement('tr');
                 tr.innerHTML = `
                     <td>${item.name}</td>
                     <td>${new Date(item.lastModified).toLocaleString()}</td>
                     <td><button onclick="viewScan('${item.name}')">View Report</button></td>
                 `;
                 tbody.appendChild(tr);
             });
 
             document.getElementById('total-scans').innerText = list.length;
             
             // Ignored stats
             const iRes = await fetch(getApiPath('/ignore'));
             const ignored = await iRes.json();
             document.getElementById('ignored-count').innerText = ignored.length || 0;
         } catch(e) {
             console.error("Load History Failed", e);
             document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="3">Error loading history. Ensure backend is running.</td></tr>';
         }
     }
 
     async function viewScan(scanName) {
         const res = await fetch(`${getApiPath('/scans/view')}?scanName=${scanName}`);
         const reports = await res.json();
         
         const modal = document.getElementById('resultsModal');
         const body = document.getElementById('modalBody');
         body.innerHTML = '';
         
         reports.forEach(r => {
            let techBadge = `<span class="badge ${r.technology.toLowerCase().includes('mule') ? 'mule' : 'spring'}">${r.technology}</span>`;
            body.innerHTML += `<div class="card" style="margin-bottom:10px; padding:10px; border:1px solid #ddd;">
                 <h3>${techBadge} ${r.repoName || 'Unknown Repo'}</h3>
                 <p><strong>Score:</strong> ${r.governanceScore}/100</p>
                 ${r.metadata ? '<p><strong>Metadata:</strong> <pre style="background:#eee;padding:5px;">' + JSON.stringify(r.metadata, null, 2) + '</pre></p>' : ''}
            </div>`;
         });
         
         modal.style.display = 'flex';
     }
 
     // Export/Import
     async function exportWorkspace() {
         const res = await fetch(getApiPath('/state'));
         const json = await res.json();
         const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json, null, 2));
         const anchor = document.createElement('a');
         anchor.href = dataStr;
         anchor.download = "apidiscovery_workspace.json";
         document.body.appendChild(anchor);
         anchor.click();
         anchor.remove();
     }
     
     async function importWorkspace(input) {
         const file = input.files[0];
         if(!file) return;
         const reader = new FileReader();
         reader.onload = async function(e) {
             const json = e.target.result;
             await fetch(getApiPath('/state'), { method: 'POST', body: json });
             location.reload();
         };
         reader.readAsText(file);
     }
     
     window.onclick = function(event) {
          if (event.target == document.getElementById('resultsModal')) {
              document.getElementById('resultsModal').style.display = "none";
          }
      }
 </script>
 </body>
 </html>

# =============================================================================
# Aegis Rules Configuration - Raks
# Targeted for Technical Checklist Compliance
# Author: Rakesh Kumar (Rakesh.Kumar@ibm.com)
# Date: 2026-01-18
# =============================================================================

# =============================================================================
# RULE TYPES QUICK REFERENCE
# =============================================================================
# 
# UNIVERSAL RULE TYPES (Apply to ANY text-based project)
# -------------------------------------------------------------------------
# 1.  GENERIC_TOKEN_SEARCH_REQUIRED      - Ensures required tokens exist in files
# 2.  GENERIC_TOKEN_SEARCH_FORBIDDEN     - Ensures forbidden tokens do NOT exist in files
# 3.  XML_XPATH_EXISTS                   - Validates required XPath expressions exist in XML
# 4.  XML_XPATH_NOT_EXISTS               - Validates forbidden XPath expressions do NOT exist in XML
# 5.  XML_ATTRIBUTE_EXISTS               - Ensures required XML attributes exist with correct values
# 6.  XML_ATTRIBUTE_NOT_EXISTS           - Ensures forbidden XML attributes do NOT exist
# 7.  XML_ELEMENT_CONTENT_REQUIRED       - Validates required content exists within XML elements
# 8.  XML_ELEMENT_CONTENT_FORBIDDEN      - Validates forbidden content does NOT exist within XML elements
# 9.  POM_VALIDATION_REQUIRED            - Ensures required POM elements exist (parent, dependencies, plugins, properties)
# 10. POM_VALIDATION_FORBIDDEN           - Ensures forbidden POM elements do NOT exist (dependencies, plugins)
# 11. JSON_VALIDATION_REQUIRED           - Validates required JSON elements exist (e.g., mule-artifact.json, package.json)
# 12. JSON_VALIDATION_FORBIDDEN          - Validates forbidden JSON elements do NOT exist
#
# CONFIG RULE TYPES (Standard Types - Apply to Configuration Projects)
# -------------------------------------------------------------------------
# 1.  MANDATORY_SUBSTRING_CHECK          - Ensures required substrings exist in config files (.properties, .policy)
# 2.  MANDATORY_PROPERTY_VALUE_CHECK     - Validates required properties exist with correct values
# 3.  OPTIONAL_PROPERTY_VALUE_CHECK      - Validates property values IF the property exists
# 4.  GENERIC_TOKEN_SEARCH               - Advanced token search with REGEX support and environment filtering
#
# CONDITIONAL STANDARDS (Universal "If-Then" Engine)
# -------------------------------------------------------------------------
# 1.  CONDITIONAL_CHECK       - Logic engine. Runs 'onSuccess' only if 'preconditions' are met.
# 
# COMMON TRIGGERS (Can be used in 'preconditions'):
# - PROJECT_CONTEXT           - Trigger by Project Name patterns (e.g., contains '-exp-').
# - FILE_EXISTS               - Trigger by file presence (e.g., 'secure-properties.xml').
# - XML_XPATH_EXISTS          - Trigger by XML content (e.g., check for DB/MQ connectors).
# - MANDATORY_PROPERTY_VALUE_CHECK - Trigger by property existence or specific value.
# 
# NOTE: *ANY* check type above can be used as a trigger for the conditional engine!
#
# =============================================================================
# MESSAGE TOKENS
# =============================================================================
# You can use the following tokens in successMessage and errorMessage:
# - {RULE_ID}         : The ID of the rule being executed.
# - {DEFAULT_MESSAGE} : The technical details of the check result. (Alias: {CORE_DETAILS})
# - {CHECKED_FILES}   : The list of files processed by the check. (Alias: {SCANNED_FILES})
# - {FOUND_ITEMS}     : The specific forbidden items found (e.g. 'toApplicationCode', forbidden keys).
# - {MATCHING_FILES}  : The list of files that *passed* the check condition (Success Messages).
# - {PROPERTY_RESOLVED}: Shows if any properties were resolved (e.g. ${app.port} ? 8081).
# - {FAILURES}        : The raw list of failure reasons (often contained in DEFAULT_MESSAGE).
# =============================================================================

# =============================================================================
# PROJECT TYPE FILTERING (NEW FEATURE)
# =============================================================================
# Eliminate report noise by only running applicable rules on each project type.
#
# 1. Define project types in config.projectTypes:
#    CODE:
#      description: "Mule applications"
#      detectionCriteria:
#        markerFiles: ["pom.xml"]
#        excludePatterns: [".*_config.*"]
#    CONFIG:
#      description: "Configuration projects"
#      detectionCriteria:
#        namePattern: ".*_config.*"
#
# 2. Reference types in rules using appliesTo:
#    - id: "RULE-001"
#      appliesTo: ["CODE"]  # Only runs on CODE projects
#
# 3. Rules without appliesTo apply to ALL projects (backward compatible)
#
# Benefits:
# - Cleaner reports (only relevant rules shown)
# - No false positives (CONFIG projects won't fail CODE rules)
# - Zero performance impact (classification cached)
# =============================================================================

# =============================================================================
# PROPERTY RESOLUTION
# =============================================================================
# Aegis can resolve property placeholders in XML attributes, XML element content,
# and JSON values before validation. This allows rules to work seamlessly with
# externalized configurations across multiple technologies.
#
# SUPPORTED RULE TYPES:
# - XML_ATTRIBUTE_EXISTS (Attributes)
# - XML_ELEMENT_CONTENT_REQUIRED / FORBIDDEN (Text Content)
# - JSON_VALIDATION_REQUIRED / FORBIDDEN (Values)
#
# SUPPORTED TECHNOLOGIES:
# - Mule:        ${property} or p('property')
# - Spring Boot: ${property}
# - TIBCO:       %%property%% or $_property
# - Python:      ${VAR}
# - Node.js:     process.env.VAR
# - Kubernetes:  $(VAR)
#
# EXAMPLE:
# XML: <version>${app.version}</version>
# Property File: app.version=1.0.0
# Result: Aegis resolves ${app.version} †’ 1.0.0 before checking
# =============================================================================

config:
  environments:
  - SBX
  - ITE
  - PREP
  - PROD
  
  # Project type definitions for rule filtering
  projectTypes:
    CODE:
      description: "Application projects with source code (Mule, Spring, etc.)"
      detectionCriteria:
        markerFiles: ["pom.xml", "mule-artifact.json", "build.gradle"]
        excludePatterns: [".*_config.*", ".*-config$"]
    
    CONFIG:
      description: "Configuration projects with properties and policies"
      detectionCriteria:
        namePattern: ".*_config.*|.*-config$"
  
  # Identifies valid projects and configuration locations
  projectIdentification:
    # Locates the folder containing environment-specific property files
    configFolder:
      namePattern: .*_config.*  # Regex to match config folder name
    
    # Defines criteria to identify a valid project root for scanning
    targetProject:
      matchMode: ALL  # ALL: Must contain all markers (if multiple logic applies), usually behaves as 'contains at least one of' for list
      markerFiles:    # Existence of ANY of these files marks the folder as a project
      - pom.xml
      - mule-artifact.json

    # Directories to exclude from scanning to improve performance and reduce noise
    ignoredFolders:
      exactNames:     # Exact folder names to skip
      - Aegis-reports
      - rakesh
      - target
      - bin
      - build
      - .git
      - .idea
      - .vscode
      - node_modules
      - __MACOSX
      prefixes:       # Folder names starting with these prefixes to skip
      - .
      - Aegis-reports
      - aegis-report
      - aegis-report-config

    # Files to exclude from scanning globally
    ignoredFiles:
      exactNames:     # Exact filenames to skip (e.g. log4j2-test.xml)
      - .DS_Store
      - thumbs.db
      prefixes:       # Filenames starting with these prefixes to skip
      - temp_
      - debug_
      
rules:

  # ---------------------------------------------------------------------------
  # POM.XML VALIDATION
  # ---------------------------------------------------------------------------

  # RULE-023: Parent POM
  - id: "RULE-001"
    name: "Validate Parent POM Version"
    description: "Ensures Parent POM is com.Raks.eapi:MuleParentPom >= 3.0.0"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Parent POM version is valid (3.0.0+)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Parent POM version is invalid. Must be com.Raks.eapi:MuleParentPom >= 3.0.0\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_REQUIRED' with 'validationType: PARENT' allows you to enforce
    # specific parent POM coordinates and strict minimum versions.
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PARENT
        parent:
          groupId: com.Raks.eapi
          artifactId: MuleParentPom
          minVersion: 3.0.0

  # RULE-024: POM Properties
  - id: "RULE-002"
    name: "Validate POM Properties"
    description: "Ensures critical properties satisfy minimum versions."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Critical POM properties (runtime, plugin, cicd,munit) are valid\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Critical POM properties check failed. Ensure mule.maven.plugin.version>=4.6.0, app.runtime>=4.9.LTS, cicd.mule.version>=4.9.LTS, munit.version>=3.5.0\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_REQUIRED' with 'validationType: PROPERTIES' enforces Maven properties.
    # - 'minVersion': Handles semantic versioning logic (e.g. "4.9.LTS" parsing).
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PROPERTIES
        properties:
        - name: mule.maven.plugin.version
          minVersion: 4.6.0
        - name: app.runtime
          minVersion: "4.9.LTS"
        - name: cicd.mule.version
          minVersion: "4.9.LTS"
        - name: munit.version
          minVersion: "3.5.0"

  # RULE-026: Forbidden Plugins
  - id: "RULE-003"
    name: "Forbid Restricted Plugins"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No restricted plugins found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden plugin found (maven-clean, maven-compiler, or munit-maven)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_FORBIDDEN' ensures specific plugins are NOT present.
    # Checks 'plugins' section of pom.xml.
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: PLUGINS
        forbiddenPlugins:
        - groupId: org.apache.maven.plugins
          artifactId: maven-clean-plugin
        - groupId: org.apache.maven.plugins
          artifactId: maven-compiler-plugin
        - groupId: com.mulesoft.munit.tools
          artifactId: munit-maven-plugin

  # RULE-027: Forbidden Dependencies
  - id: "RULE-004"
    name: "Forbid Runtime Dependencies"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No runtime dependencies found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden dependency found (mule-core-ee or spring-config-ee)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'POM_VALIDATION_FORBIDDEN' ensures specific dependencies are NOT present.
    # Checks 'dependencies' section of pom.xml.
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: DEPENDENCIES
        forbiddenDependencies:
        - groupId: com.mulesoft.mule.runtime
          artifactId: mule-core-ee
        - groupId: com.mulesoft.mule.runtime.modules
          artifactId: mule-module-spring-config-ee

  # RULE-029: Required Dependency
  - id: "RULE-005"
    name: "Require eapimuleutilities"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ eapimuleutilities dependency found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Missing required dependency: eapimuleutilities\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Enforces the presence of a mandatory dependency (eapimuleutilities).
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: DEPENDENCIES
        dependencies:
        - groupId: com.Raks.eapi
          artifactId: eapimuleutilities

  # RULE-028: Shared Libs
  - id: "RULE-006"
    name: "Forbid Shared Libraries"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No shared libraries found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden shared library found (spring-security)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Scans 'pom.xml' as a text file for forbidden tokens (Shared Libraries).
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["pom.xml"]
        tokens: ["spring-security-ldap", "spring-security-web"]

  # RULE-038: Legacy Deps
  - id: "RULE-007"
    name: "Legacy Dependency Upgrade"
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy dependencies (javax.mail, ojdbc8) found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy dependency detected. Upgrade required\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Explicitly forbids known legacy dependencies (javax.mail, old oracle drivers).
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: DEPENDENCIES
        forbiddenDependencies:
        - groupId: javax.mail
          artifactId: mail
        - groupId: com.oracle.database.jdbc
          artifactId: ojdbc8

  # ---------------------------------------------------------------------------
  # MULE ARTIFACT VALIDATION
  # ---------------------------------------------------------------------------

  # RULE-001: mule-artifact.json validation
  - id: "RULE-008"
    name: "Validate mule-artifact.json"
    description: "Enforces minMuleVersion 4.9.7, Java 17, and secureProperties."
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ mule-artifact.json is valid (Version: 4.9.7+, Java: 17)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ mule-artifact.json failed validation. Check minMuleVersion (4.9.7+), javaSpecificationVersions (17), or secureProperties\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'JSON_VALIDATION_REQUIRED' enforces structure and values in JSON files.
    # - 'minVersions': Checks semantic versions (e.g. 4.9.7 >= 4.9.0).
    # - 'requiredFields': Checks strict equality for values (e.g. javaVersion == "17").
    # - 'requiredElements': Checks only for existence of a key.
    - type: JSON_VALIDATION_REQUIRED
      params:
        filePattern: mule-artifact.json
        minVersions:
          minMuleVersion: 4.9.7
        requiredFields:
          javaSpecificationVersions: "17"
        requiredElements:
        - secureProperties


  # ---------------------------------------------------------------------------
  # CODE & IMPLEMENTATION VALIDATION (XML, Java, Config)
  # ---------------------------------------------------------------------------

  # RULE-002: Logger Attributes
  - id: "RULE-009"
    name: "Forbid Legacy Logger Attributes"
    description: "Ensures toApplicationCode and fromApplicationCode are NOT used."
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy logger attributes found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Forbidden attribute found in Logger\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # This rule uses 'XML_ATTRIBUTE_NOT_EXISTS' for identifying forbidden attributes on specific elements.
    # - Advantages: cleaner configuration than raw XPath.
    # - Alternative: You could use 'XML_XPATH_NOT_EXISTS' with "//set-payload[@toApplicationCode]" but that requires more XML knowledge.
    - type: XML_ATTRIBUTE_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        elements: ["set-payload"]
        forbiddenAttributes: ["toApplicationCode", "fromApplicationCode"]

  # RULE-004: jce-encrypt
  - id: "RULE-010"
    name: "Forbid jce-encrypt Token"
    description: "Detects usage of legacy jce-encrypt."
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No jce-encrypt tokens found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Found forbidden token (jce-encrypt)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # This rule uses 'matchMode: REGEX' with word boundaries (\b) to ensure we match the EXACT word 'jce-encrypt'.
    # - If you want to allow partial matches (e.g. 'my-jce-encrypt'), use 'matchMode: SUBSTRING' and remove \b.
    # - REGEX provides the most precision for text token searches.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/mule/*.xml"]
        tokens: ["\\bjce-encrypt\\b"]
        matchMode: REGEX
        ignoreComments: true

  # RULE-005: SOAP Version
  - id: "RULE-011"
    name: "Validate SOAP Version"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ SOAP configuration uses valid version (1.1 or 1.2)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Invalid SOAP version detected. Must be SOAP_11 or SOAP_12\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'XML_ATTRIBUTE_EXISTS' validates that specific attributes/values exist on an element.
    # - 'elementAttributeSets': Defines the element and the REQUIRED attribute values.
    # - Useful for enforcing configuration standards like 'soapVersion="SOAP_12"'.
    #
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' ensures we only validate the SOAP version IF an APIKit SOAP config exists.
    # Precondition: Scans for 'apikit-soap:config'.
    # OnSuccess: Validates that 'soapVersion' is SOAP_11 or SOAP_12.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["src/main/mule/*.xml"]
            tokens: ["apikit-soap:config"]
        onSuccess:
        - type: XML_ATTRIBUTE_EXISTS
          params:
            filePatterns: ["src/main/mule/*.xml"]
            elementAttributeSets:
            - element: apikit-soap:config
              attributes: {soapVersion: "SOAP_11"}
            - element: apikit-soap:config
              attributes: {soapVersion: "SOAP_12"}

  # RULE-031: EncUtil Replacement
  - id: "RULE-012"
    name: "Enforce EncUtil Logic"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ EncUtil logic is present and legacy crypto is gone\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Failed EncUtil check: Either legacy 'jce-encrypt-pbe' found or new 'EncUtil::encryptJcePbe' missing\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Migration Check Strategy (CONDITIONAL):
    # - Only runs on XML projects (Precondition: found 'mule' token in XML).
    # - Fails if Legacy 'jce-encrypt-pbe' is found.
    # - Fails if New 'EncUtil::encryptJcePbe' is NOT found.
      - type: "CONDITIONAL_CHECK"
        params:
          preconditions:
            - type: "GENERIC_TOKEN_SEARCH_REQUIRED"
              params:
                filePatterns: ["src/main/mule/*.xml"]
                # Just check if any XML file exists (by looking for common XML or Mule tag)
                tokens: ["mule"] 
                matchMode: ANY_FILE
          onSuccess:
            - type: XML_XPATH_NOT_EXISTS
              params:
                filePatterns: ["src/main/mule/*.xml"]
                xpathExpressions:
                - xpath: "//*[contains(local-name(), 'jce-encrypt-pbe')]"
                  failureMessage: "Legacy jce-encrypt-pbe found"
            - type: XML_XPATH_EXISTS
              params:
                filePatterns: ["src/main/mule/*.xml"]
                matchMode: ANY_FILE
                xpathExpressions:
                - xpath: "//*[local-name()='set-variable' and contains(@value, 'EncUtil::encryptJcePbe')]"
                  failureMessage: "EncUtil::encryptJcePbe usage missing"

  # RULE-033: ApiMethod
  - id: "RULE-013"
    name: "Verify apimethod variable has encryptedRequestPath"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ apimethod variable logic is correct\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ apimethod variable logic missing encryptedRequestPath\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Verifies that a specific 'set-variable' logic exists.
    # - Checks if variableName='apimethod' AND its value contains 'vars.encryptedRequestPath'.
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='set-variable' and @variableName='apimethod' and contains(@value, 'vars.encryptedRequestPath')]"
  
  # RULE-036: Autodiscovery
  - id: "RULE-014"
    name: "Require API Autodiscovery"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Autodiscovery is enabled\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Autodiscovery is not enabled\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Simple XML check to ensure the 'autodiscovery' element is present in the configuration.
    # Essential for API Manager integration.
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='autodiscovery']"

  # RULE-040: Java 17 Errors
  - id: "RULE-015"
    name: "Java 8 to 17 Error Class Fields Migration Check"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy error field usages (Java 8/Mule 3X) found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy Java 8 error field usages detected. These fields are removed in Mule 4/Java 17\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Uses REGEX to detect Java 8/Mule 3 error handling patterns forbidden in Java 17/Mule 4.
    # Ref: Migration Guide - Error Object Structure
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/**/*.xml", "src/main/**/*.dwl", "src/main/**/*.java" ]
        tokens: 
        # Mule Message Wrapper (Removed)
        - "error\\.muleMessage"
        - "error\\.muleMessage\\.typedValue"
        - "error\\.muleMessage\\.payload"
        - "error\\.muleMessage\\.attributes\\.StatusCode"
        
        # Error Type String Conversions (Changed)
        - "error\\.errorType\\.asString"
        - "error\\.errorType\\.parentErrorType\\.asString"
        
        # Exception/Cause (Reorganized)
        - "error\\.exception\\.cause"
        - "error\\.exception\\.cause\\.detailMessage"
        - "error\\.exception\\.cause\\.Message"
        - "error\\.exception\\.errorMessage\\.typedValue"
        
        # Other
        - "error\\.errors"
        
        # CONFIG_NOTE: 
        # isRegex: true -> Enables regex pattern matching for tokens.
        # matchMode: ALL_FILES -> Ensures ALL scanned files must pass the check (i.e., contain NO forbidden tokens).
        matchMode: ALL_FILES
        isRegex: true
        ignoreComments: true

  # RULE-019: DLP XML
  - id: "RULE-016"
    name: "Forbid DLP Code Logic"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP logic found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DLP logic detected in HTTP Proxy\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'GENERIC_TOKEN_SEARCH_FORBIDDEN' detects forbidden DLP tokens.
    # - 'resolveProperties: true': Resolves values like ${prot.dlp} before searching.
    # - 'wholeWord: true': Ensures "north.bound.dlp.flag" doesn't match "1north.bound.dlp.flag".
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        resolveProperties: true
        wholeWord: true # Set to 'true' to match exact words (prevents '1north...' from matching 'north...'). Set to 'false' for substring mode.
        failureMessage: "DLP flag choice found"
        filePatterns:
        - "**/http-proxy.xml"
        - "**/*.xml"
        tokens:
        - "north.bound.dlp.flag"
        - "raks.dlp.queue"
        ignoreComments: true

  # RULE-020: DLP Properties
  - id: "RULE-017"
    name: "Forbid DLP Properties"
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP properties found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DLP property detected (dlp.flag or dlp.requestqueue)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Same strategy as RULE-019 but targeting .properties files.
    # - 'wholeWord: true': Prevents false positives.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        wholeWord: true # Set to 'true' to match exact words. Set to 'false' for substring mode.
        filePatterns: ["**/*.properties"]
        tokens: ["north.bound.dlp.flag", "south.bound.dlp.flag", "wmq.dlp.requestqueue"]
        ignoreComments: true

  # RULE-021: SQL Security
  - id: "RULE-018"
    name: "Enforce SQL Server DB connection String Security"
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ SQL Server DB Connection Strings are securely configured (or none found)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ SQL Server DB Connection String missing ';encrypt=false;trustServerCertificate=false'\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Refactored to 'CONDITIONAL_CHECK' to strictly enforce SQL security when SQL is used.
    # 1. Trigger: If 'jdbc:sqlserver' is used in ANY file (Precondition).
    # 2. Check: Then NO file may contain an INSECURE connection string (OnSuccess -> Forbidden).
    #    - Regex Negative Lookahead (?!...) ensures we strictly catch lines MISSING validation.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["**/*.properties"]
            tokens: ["jdbc:sqlserver"]
            matchMode: ANY_FILE # Trigger if at least one file uses SQL Server
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
          params:
            filePatterns: ["**/*.properties"]
            # Regex: Match jdbc:sqlserver line that DOES NOT contain 'encrypt=false'
            # Split into two tokens so it fails if EITHER is missing.
            tokens: 
              - "jdbc:sqlserver(?!.*encrypt=false).*"
              - "jdbc:sqlserver(?!.*trustServerCertificate=false).*"
            matchMode: REGEX
            isRegex: true
            ignoreComments: true
            failureMessage: "Found SQL Server DB Connection String (missing 'encrypt=false' and/or 'trustServerCertificate=false')"

  # RULE-032: DB2 AppId
  - id: "RULE-019"
    name: "Enforce DB2 Connection URL ApplicationId"
    appliesTo: ["CONFIG"]
    enabled: true
    severity: MEDIUM
    successMessage: "✓ DB2 Connection URL ApplicationId is present\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ DB2 Connection URL ApplicationId is missing\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' with Negative Logic (FORBIDDEN).
    # 1. Trigger: If 'jdbc:db2' exists.
    # 2. Check: Fail if any line contains 'jdbc:db2' BUT missing 'ApplicationId=' (using Negative Lookahead).
      - type: "CONDITIONAL_CHECK"
        params:
          preconditions:
            - type: "GENERIC_TOKEN_SEARCH_REQUIRED"
              params:
                filePatterns: ["**/*.properties", "**/*.yaml", "**/*.xml"]
                tokens: ["jdbc:db2"]
                wholeWord: false
          onSuccess:
            - type: "GENERIC_TOKEN_SEARCH_FORBIDDEN"
              params:
                filePatterns: ["**/*.properties", "**/*.yaml", "**/*.xml"]
                # Regex: Match jdbc:db2 line that DOES NOT contain 'ApplicationId=' (Case Insensitive)
                tokens: ["jdbc:db2(?!.*(?i)ApplicationId=).*"]
                matchMode: REGEX
                isRegex: true
                failureMessage: "Found DB2 Connection URL missing 'ApplicationId'"

  # RULE-009: Legacy DB2 VIPs
  - id: "RULE-020"
    name: "Forbid Legacy DB2 VIPs"
    description: "Detects usage of deprecated DB2 connection hostnames."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy DB2 VIPs found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy DB2 VIP connection detected. Migrate to DVIPA (dsndb0e/h)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Detects hardcoded legacy connection strings in property files.
    # Blocking these ensures teams migrate to the new DVIPA standard.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/*.properties"]
        tokens: ["db2contppvip.Raks-tst.com:50000", "db2contstvip.Raks-tst.com:50000", "wil-db2contstvip.bbtnet.com:50000"]

  # RULE-022: MQ Cipher Suite (Conditional)
  - id: "RULE-021"
    name: "Validate MQ Cipher Suite"
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ MQ Cipher Suite is correct (or not applicable)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ MQ Cipher Suite is incorrect. Must be TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'CONDITIONAL_CHECK' runs nested rules ('onSuccess') ONLY if 'preconditions' match.
    # - Usage: "If IBM MQ is used (precondition from xml), THEN enforce Cipher Suite property (onSuccess)."
    # - Precondition checks XML for 'ibm-mq:config'.
    # - OnSuccess uses Regex Negative Lookahead to forbidden improper ciphers in .properties.
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["src/main/mule/*.xml"]
            tokens: ["ibm-mq:config"]
            matchMode: SUBSTRING
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
          params:
            filePatterns: ["src/main/resources/**/*.properties"]
            # FAIL if we find 'ibm.mq.cipherSuite=' followed by ANYTHING other than our safe cipher.
            tokens: ["ibm\\.mq\\.cipherSuite\\s*=(?!\\s*TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384).*"]
            matchMode: REGEX
            isRegex: true

  # ---------------------------------------------------------------------------
  # POLICY & ENVIRONMENT VALIDATION (Config Files)
  # ---------------------------------------------------------------------------

  # RULE-006: Header Injection
  - id: "RULE-022"
    name: "Header Injection Policy (WARN mode logging)"
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Header Injection policy configured correctly (WARN mode logging)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Header Injection policy values must be 'WARN mode logging'\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # 'MANDATORY_PROPERTY_VALUE_CHECK' validates configuration values across ALL environments.
    # - Ensures 'x-tfc-request-out' is set to 'WARN'.
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        environments: ['ALL']
        properties:
        - name: headerinjection.policy.inboundheadermap.x-tfc-request-out
          values: ['WARN']
        - name: headerinjection.policy.inboundheadermap.x-tfc-response-in
          values: ['WARN']

  # RULE-008: Legacy Auth
  - id: "RULE-023"
    name: "Forbid Legacy Auth Policies"
    description: "Detects old AAA or Basic Auth policies."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy Auth policies found\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Legacy Auth policy detected (Raks-AAA or RaksBasicAuthnPolicy). Upgrade to CompositeAuth\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Uses simple token search to find deprecated policy names in XML/Policy files.
    # 'matchMode' defaults to 'SUBSTRING', finding any instance of these strings.
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        tokens: ["Raks-AAA-SOAP", "Raks-AAA-HTTP", "RaksBasicAuthnPolicy"]

  # RULE-109: Policy Versions
  - id: "RULE-024"
    name: "Enforce Policy Versions"
    description: "Validates all Raks policy versions."
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ All policy versions are correct\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Policy version mismatch found (Check report for details)\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    # CONFIGURATION NOTE:
    # Validates exact version numbers for internal policies in config files.
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        filePatterns: ["**/Policies/**/*.policy"]
        environments: ['ALL']
        properties:
        - name: Raks.compositeauthn.policy.version
          values: ['3.0.0']
        - name: Raks.authz.policy.version
          values: ['3.0.0']
        - name: noname.policy.version
          values: ['5.1.0']
        - name: ratelimit.policy.version
          values: ['1.4.1']
        - name: headerinjection.policy.version
          values: ['1.3.2']
        - name: headerremoval.policy.version
          values: ['1.1.2']
        - name: Raks.wssencdec.policy.version
          values: ['3.0.0']
        - name: Raks.jsonencdec.policy.version
          values: ['3.0.0']

  # ---------------------------------------------------------------------------
  # CONFIG RULES: MANDATORY_SUBSTRING_CHECK
  # ---------------------------------------------------------------------------

  - id: "RULE-025"
    name: Mandatory substring check for .properties files
    description: Scans .properties files for required tokens (exact substring match)
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: MANDATORY_SUBSTRING_CHECK
      params:
        fileExtensions:
        - .properties
        caseSensitive: true
        environments:
        - ALL
        tokens:
        - apiId

  - id: "RULE-026"
    name: Mandatory substring check for .policy files
    description: Scans .policy files for required tokens (exact substring match)
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: MANDATORY_SUBSTRING_CHECK
      params:
        fileExtensions:
        - .policy
        caseSensitive: true
        environments:
        - ALL
        tokens:
        - http.protocols=HTTPS
        - http.private.port=8081

  - id: "RULE-027"
    name: Forbidden substring check for .properties files
    description: Fails if forbidden tokens are found in .properties files
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        fileExtensions:
        - .properties
        caseSensitive: true
        environments:
        - ALL
        tokens:
        - hardcoded.password
        - TODO
        - fixmelater

  - id: "RULE-028"
    name: Forbidden substring check for .policy files
    description: Fails if forbidden tokens are found in .policy files
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        fileExtensions:
        - .policy
        caseSensitive: true
        environments:
        - ALL
        tokens:
        - deprecated.policy
        - old.version

  # ---------------------------------------------------------------------------
  # CONFIG RULES: MANDATORY_PROPERTY_VALUE_CHECK
  # ---------------------------------------------------------------------------

  - id: "RULE-029"
    name: Mandatory name-value check for .properties files
    description: Ensures required properties exist with correct values in .properties files
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        fileExtensions:
        - .properties
        delimiter: =
        caseSensitiveNames: true
        caseSensitiveValues: true
        environments:
        - ALL
        properties:
        - name: LogJsonFormat
          values:
          - 'true'
          - 'false'
        - name: anotherpropertycheck
          values:
          - somevalue

  - id: "RULE-030"
    name: Mandatory name-value check for .policy files
    description: Ensures required policy properties exist with correct values
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        fileExtensions:
        - .policy
        delimiter: =
        caseSensitiveNames: true
        caseSensitiveValues: true
        environments:
        - ALL
        properties:
        - name: headerinjection.policy.applied
          values:
          - 'true'
        - name: headerinjection.policy.version
          values:
          - 1.3.2
          - 1.3.3
        - name: ratelimit.policy.applied
          values:
          - 'true'
        - name: ratelimit.policy.version
          values:
          - 1.4.2
        - name: raks.compositeauthn.policy.applied
          values:
          - 'true'
        - name: raks.compositeauthn.policy.version
          values:
          - 1.4.2
          - 1.4.3
        - name: raks.authz.policy.applied
          values:
          - 'true'
        - name: raks.authz.policy.version
          values:
          - 1.2.2
          - 1.2.3
        - name: assetType
          values:
          - rest
          - soap
          - batch

  # ---------------------------------------------------------------------------
  # CONFIG RULES: OPTIONAL_PROPERTY_VALUE_CHECK
  # ---------------------------------------------------------------------------

  - id: "RULE-031"
    name: Optional name-value check for .properties files
    description: If property exists in .properties files, validates its value
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: OPTIONAL_PROPERTY_VALUE_CHECK
      params:
        fileExtensions:
        - .properties
        delimiter: =
        caseSensitiveNames: true
        caseSensitiveValues: false
        environments:
        - ALL
        properties:
        - name: platform.config.analytics.enabled
          values:
          - 'true'
          - 'false'
        - name: requestPathEncryption
          values:
          - Y
          - N

  - id: "RULE-032"
    name: Optional name-value check for .policy files
    description: If property exists in .policy files, validates its value
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: OPTIONAL_PROPERTY_VALUE_CHECK
      params:
        fileExtensions:
        - .policy
        delimiter: =
        caseSensitiveNames: true
        caseSensitiveValues: true
        environments:
        - ALL
        properties:
        - name: mTLS-AuthZ.policy.version
          values:
          - 3.0.0
          - 3.0.1
        - name: wssencdec.policy.version
          values:
          - 3.0.0
          - 3.0.1

  # ---------------------------------------------------------------------------
  # CONFIG RULES: GENERIC_TOKEN_SEARCH
  # ---------------------------------------------------------------------------

  - id: "RULE-033"
    name: Optional regex pattern (ip addresses) check in .properties files
    description: Fails if forbidden regex patterns are found in .properties files
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: GENERIC_TOKEN_SEARCH
      params:
        filePatterns:
        - '**/Properties/**/*.properties'
        environments:
        - ALL
        searchMode: FORBIDDEN
        matchMode: REGEX
        tokens:
        - ^(?![\s]*[#!]).*\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b
        - ^(?![\s]*[#!]).*\blocalhost\b
        - ^(?![\s]*[#!]).*\b127\.0\.0\.1\b

  - id: "RULE-034"
    name: Optional regex pattern (ip addresses) check in .policy files
    description: Fails if forbidden regex patterns are found in .policy files
    appliesTo: ["CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    checks:
    - type: GENERIC_TOKEN_SEARCH
      params:
        filePatterns:
        - '**/Policies/*.policy'
        - '**/Policies/**/*.policy'
        environments:
        - ALL
        searchMode: FORBIDDEN
        matchMode: REGEX
        tokens:
        - ^(?![\s]*[#!]).*\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b
        - ^(?![\s]*[#!]).*\blocalhost\b
        - ^(?![\s]*[#!]).*\b127\.0\.0\.1\b



  - id: "RULE-035"
    name: 'Conditional: Batch API asset type'
    description: If API name contains 'batch', the property asset.type must be 'batch'.
    appliesTo: ["CONFIG"]
    enabled: true
    severity: MEDIUM
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Ensures large volume APIs are tagged correctly for infrastructure scaling.
    rationale: Automated provisioning depends on correct asset type metadata.
    exampleGood: 'Project: user-batch-api, asset.type=batch'
    exampleBad: 'Project: user-batch-api, asset.type=rest'
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: PROJECT_CONTEXT
          params:
            nameContains: batch
            ignoreCase: true
        onSuccess:
        - type: MANDATORY_PROPERTY_VALUE_CHECK
          params:
            fileExtensions:
            - .properties
            environments:
            - ALL
            properties:
            - name: asset.type
              values:
              - batch
  - id: "RULE-036"
    name: 'Conditional: MQ and DB Common Timeout'
    description: Projects using both MQ and DB must define a 'commontimeout' property.
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Cross-system timeout synchronization.
    rationale: Prevents partial transaction failures where one system times out much later than the other.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        logic: AND
        preconditions:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='config' and contains(namespace-uri(), 'mq')]
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='config' and contains(namespace-uri(), 'db')]
        onSuccess:
        - type: MANDATORY_PROPERTY_VALUE_CHECK
          params:
            fileExtensions:
            - .properties
            environments:
            - ALL
            properties:
            - name: commontimeout
              values:
              - .+
  - id: "RULE-037"
    name: 'Best Practice: HTTP Config Externalization'
    description: Ensures HTTP Request configurations use externalized properties for timeouts.
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Prevents environment-specific hardcoding.
    rationale: Hardcoded timeouts lead to different behaviors across Dev/UAT/Prod without proper control.
    exampleGood: <http:request-config responseTimeout='${http.timeout}' ...>
    exampleBad: <http:request-config responseTimeout='5000' ...>
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='request-config' and contains(namespace-uri(), 'http')]
        onSuccess:
        - type: XML_ATTRIBUTE_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            elementName: http:request-config
            attributeName: responseTimeout
            expectedValue: ^\$\{.*\}$
            matchMode: REGEX
  - id: "RULE-038"
    name: 'Resilience: Salesforce Reconnection'
    description: If Salesforce connector is used, a reconnection strategy must be defined.
    appliesTo: ["CODE"]
    enabled: true
    severity: MEDIUM
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Handling temporary SaaS connectivity issues.
    rationale: Standard reconnection prevents Mule from locking up if Salesforce is briefly unavailable.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='sfdc-config']
        onSuccess:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='sfdc-config']/*[local-name()='reconnection']
              failureMessage: Mandatory <reconnection> element missing for Salesforce config.
  - id: "RULE-039"
    name: 'Arch: JMS Dependency Alignment'
    description: If JMS connector is in POM, it must be used/configured in code.
    appliesTo: ["CODE"]
    enabled: true
    severity: LOW
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Resource optimization and library cleanliness.
    rationale: Unused dependencies bloat the JAR and increase security surface area.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: POM_VALIDATION_REQUIRED
          params:
            validationType: DEPENDENCIES
            dependencies:
            - artifactId: mule-jms-connector
        onSuccess:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='config' and contains(namespace-uri(), 'jms')]
  - id: "RULE-040"
    name: 'Governance: Prod Secure Config'
    description: If environment is PROD, the secure-prod file must exist.
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: CRITICAL
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Environment-specific security enforcement.
    rationale: Ensures Production credentials are never mixed with lower environments.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: MANDATORY_PROPERTY_VALUE_CHECK
          params:
            fileExtensions:
            - .properties
            environments:
            - ALL
            properties:
            - name: env
              values:
              - PROD
        onSuccess:
        - type: FILE_EXISTS
          params:
            filePatterns:
            - src/main/resources/secure-prod.properties
  - id: "RULE-041"
    name: 'Standard: APIKit Error Handling'
    description: If APIKit is detected, a Global Error Handler must be present.
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Consistent error responses for all experience APIs.
    rationale: Standardized error handling is critical for API consumer experience.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='config' and contains(namespace-uri(), 'apikit')]
        onSuccess:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='error-handler']
              failureMessage: APIKit detected but no <error-handler> found.
  - id: "RULE-042"
    name: 'Conditional: Experience API Autodiscovery'
    description: Experience APIs (-exp-) must have Autodiscovery configured.
    appliesTo: ["CODE"]
    enabled: true
    severity: HIGH
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Compliance with API Governance.
    rationale: Experience APIs are public-facing and MUST be managed by the gateway.
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: PROJECT_CONTEXT
          params:
            nameContains: -exp-
            ignoreCase: true
        onSuccess:
        - type: XML_XPATH_EXISTS
          params:
            filePatterns:
            - src/main/mule/*.xml
            xpathExpressions:
            - xpath: //*[local-name()='autodiscovery']
              failureMessage: Mandatory 'api-gateway:autodiscovery' element is missing
  - id: "RULE-043"
    name: 'Conditional: Secure Property Usage'
    description: If secure properties file exists, 'secure::' syntax must be used in Mule XML.
    appliesTo: ["CODE", "CONFIG"]
    enabled: true
    severity: CRITICAL
    successMessage: "✓ Rule passed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    errorMessage: "✗ Rule failed.\nFiles Checked: {CHECKED_FILES}\nItems Found: {FOUND_ITEMS}\nItems Matched: {MATCHING_FILES}\nDetails: {DEFAULT_MESSAGE}\n{PROPERTY_RESOLVED}"
    useCase: Encryption enforcement.
    rationale: Prevents plain-text property resolution when vault-encrypted files are present.
    exampleGood: value='${secure::db.password}'
    exampleBad: value='${db.password}'
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: FILE_EXISTS
          params:
            filePatterns:
            - src/main/resources/secure-*.properties
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            tokens:
            - 'secure::'
            filePatterns:
            - src/main/mule/*.xml
            matchMode: SUBSTRING

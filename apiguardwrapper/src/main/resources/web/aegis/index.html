<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Aegis - Validation Tool</title>
    <script>
        // ULTRA-EARLY Context & Trailing Slash Enforcement (Prevent FOUC)
        (function() {
            const loc = window.location;
            const path = loc.pathname;
            const isWrapper = path.includes('/apiguard/');
            
            // 1. Enforce trailing slash IMMEDIATELY if in wrapper
            if (isWrapper && !path.endsWith('/')) {
                loc.replace(loc.href + '/');
                return;
            }

            // 2. Global resolution helper
            window.resolvePath = function(url) {
                if (isWrapper && !url.startsWith('http') && !url.startsWith('/')) {
                    return '/apiguard/aegis/' + url;
                }
                return url;
            };
        })();
    </script>
    <!-- Relative paths for standalone -->
    <link rel="stylesheet" href="style.css">
    <script>
       // Helper to check settings
       function checkSettings() {
           const token = localStorage.getItem('aegis_git_token');
           const provider = localStorage.getItem('aegis_git_provider');
           if (!token && document.querySelector('input[name="mode"]:checked').value === 'git') {
               if(confirm("Git Token is not configured. Go to Settings?")) {
                   window.location.href = resolvePath('settings.html');
                   return false;
               }
           }
           return true;
       }
    </script></head>

<body>
    <div class="container" style="position: relative;">
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
            <a id="linkRules" href="#" onclick="window.open(resolvePath('rule_guide.html'), '_blank'); return false;" class="nav-button" title="Guide to all Aegis validation rules" style="padding: 8px 12px; font-size: 12px;">Rule Guide</a>
            <a id="linkSettings" href="#" onclick="window.location.href = resolvePath('settings.html'); return false;" class="nav-button" title="Configure global settings" style="padding: 8px 12px; font-size: 12px;">Settings</a>
            <a id="linkHelp" href="#" onclick="window.open(resolvePath('help.html'), '_blank'); return false;" class="nav-button" title="View help and documentation" style="padding: 8px 12px; font-size: 12px;">Help</a>
        </div>

        <div class="logo">
            <img id="logoImg" src="logo.svg" alt="Aegis Logo" style="height: 60px; margin-bottom: 10px;">
            <h1>Aegis</h1>
        </div>

        <p class="subtitle">Universal Application Code Review & Validation Tool</p>

        <div class="mode-selector optional-section">
            <label>Choose Input Method:</label>
            
            <label id="localLabel">
                <input type="radio" name="mode" value="local" onchange="handleModeChange()">
                &#128193; Local Folder Path
            </label>
            
            <label id="zipLabel">
                <input type="radio" name="mode" value="zip" onchange="handleModeChange()">
                &#128230; Upload ZIP File
            </label>

            <label id="jarLabel">
                <input type="radio" name="mode" value="jar" onchange="handleModeChange()">
                &#128218; Upload JAR/Archive
            </label>

            <label id="gitLabel">
                <input type="radio" name="mode" value="git" onchange="handleModeChange()">
                &#128279; Git Repository
            </label>
        </div>

        <!-- Local Folder Input -->
        <div id="localInput" class="optional-section hidden">
            <label>Project Folder:</label>
            <input type="text" id="folderPath" placeholder="Enter folder path (e.g., C:\projects\apis)">
        </div>

        <!-- ZIP File Input -->
        <div id="zipInput" class="optional-section hidden">
            <label>Select ZIP File:</label>
            <input type="file" id="zipFile" accept=".zip">
            <small>ZIP should contain root folder with API and config folders</small>
        </div>

        <!-- JAR File Input -->
        <div id="jarInput" class="optional-section hidden">
            <label>Select Archive File:</label>
            <input type="file" id="jarFile" accept=".jar">
            <small>Supported formats: .jar (Java / Archive)</small>
        </div>

        <!-- Git Repo Input -->
        <div id="gitInput" class="optional-section hidden">
            <!-- Global Git Provider Selection -->
            <!-- Global Git Provider Selection -->
            <div style="margin-bottom: 15px; display:flex; justify-content:center; align-items:center; gap:20px; flex-wrap:nowrap;">
                <label style="font-weight:bold;">Git Provider:</label>
                <label style="cursor:pointer; display:flex; align-items:center; white-space:nowrap;">
                    <input type="radio" name="gitProvider" value="gitlab" onchange="handleProviderChange()" style="margin-right:8px;"> GitLab
                </label>
                <label style="cursor:pointer; display:flex; align-items:center; white-space:nowrap;">
                    <input type="radio" name="gitProvider" value="github" onchange="handleProviderChange()" style="margin-right:8px;"> GitHub
                </label>
                <label style="cursor:pointer; display:flex; align-items:center; white-space:nowrap;">
                    <input type="radio" name="gitProvider" value="other" onchange="handleProviderChange()" style="margin-right:8px;"> Other
                </label>
            </div>

            <!-- View Mode Toggle -->
            <div style="display:flex; justify-content:center; margin-bottom: 20px;">
                <div style="background:white; border:1px solid #663399; border-radius:4px; overflow:hidden; display:flex;" id="viewModeContainer">
                    <label style="padding: 10px 20px; cursor:pointer; background:white; color:#663399; margin:0;" id="modeDiscoveryLabel">
                        <input type="radio" name="gitViewMode" value="discovery" style="display:none;" onchange="toggleGitView()"> 
                        Discover Repositories
                    </label>
                    <label style="padding: 10px 20px; cursor:pointer; background:#663399; color:white; margin:0;" id="modeManualLabel">
                        <input type="radio" name="gitViewMode" value="manual" checked style="display:none;" onchange="toggleGitView()"> 
                        Manual Git URL
                    </label>
                </div>
            </div>

            <p style="font-size:12px; color:#666; text-align:center; margin-top:-10px; margin-bottom:15px;">
                Using preferences from <a href="settings.html">Settings</a>.
            </p>

            <!-- Discovery Panel -->
            <div id="gitDiscoveryPanel" style="display:none;">
                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <label>Group / Org Name / User:</label>
                        <input type="text" id="gitGroup" placeholder="e.g. raks-group" name="gitGroup" autocomplete="on">
                    </div>
                    <div style="flex:1;">
                        <label>Repository Name Filter (comma-separated):</label>
                        <input type="text" id="gitRepoFilter" placeholder="e.g. api-v1, web-app" name="gitRepoFilter" autocomplete="on">
                    </div>
                </div>
                <div style="text-align:right;">
                    <button type="button" class="nav-button" style="width:auto; white-space:nowrap; padding: 5px 20px;" id="fetchReposBtn" onclick="fetchGitRepos()">Fetch Repos</button>
                </div>
    
                <div id="repoResultsSection" style="display:none; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Select Repositories:</label>
                        <label style="font-size:12px; cursor:pointer; color:#663399;">
                            <input type="checkbox" id="selectAllRepos" onchange="toggleAllRepos(this.checked)"> Select All
                        </label>
                    </div>
                    <div id="repoList" style="max-height:150px; overflow-y:auto; border:1px solid #663399; padding:8px; background:#fff; border-radius:4px;">
                        <!-- Repos appearing here -->
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items: baseline; margin-top:5px;">
                        <small id="repoCountLabel" style="color: #666;"></small>
                        <button type="button" class="nav-button" style="width:auto; padding:2px 10px; font-size:12px; background:#6f42c1;" id="fetchBranchesBtn" onclick="fetchGitBranches()">Fetch Branches</button>
                    </div>
                </div>
            </div>

            <!-- Manual Panel -->
            <!-- Manual Panel -->
            <div id="gitManualPanel" style="margin-top:10px;">
                <label>Git Repository URL:</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="gitUrl" placeholder="https://gitlab.com/group/project.git" name="gitUrl" autocomplete="url">
                    <button type="button" class="nav-button" style="width:auto; white-space:nowrap; padding: 0 15px; background:#6f42c1;" id="fetchBranchesManualBtn" onclick="fetchGitBranches(true)">Fetch Branches</button>
                </div>
            </div>

            <!-- Branch Section (Shared) -->
            <div id="branchSection" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display: flex; justify-content: space-between;">Select Branch: <span id="branchStatus" style="font-size:0.8em; color:#28a745;"></span></label>
                <select id="gitBranchDropdown" style="width:100% !important; padding:10px; border:1px solid #ccc; border-radius:4px;">
                </select>
                <small>Defaults to <code>main</code> or <code>master</code> if not selected.</small>
            </div>
            
            <input type="hidden" id="gitUrls">

            <div style="margin-top:10px; font-size: 11px; color: #d9534f; background: #fff5f5; padding: 8px; border-radius: 4px; border: 1px solid #ffcccc;">
                <strong>Restrictions:</strong> Repository max size: 500MB. Max file size: 10MB. 
                Build artifacts (<code>target/</code>, <code>*.jar</code>) will be excluded.
                Shallow clone (depth=1) is enforced.
            </div>
            
            <div id="gitViewPersistent" style="display:none">
                 <!-- Hidden inputs to store state if needed, but we rely on simple DOM inputs now -->
            </div>
        </div>

        <!-- Custom Rules Input -->
        <div class="optional-section">
            <label>Optional: Custom Rules File</label>
            <input type="file" id="customRules" accept=".yaml,.yml">
            <small>If not provided, default rules from Aegis JAR will be used</small>
        </div>

        <!-- Email Notification Options -->
        <div id="emailSection" class="optional-section" style="margin-top: 20px;">
            <strong style="color: #663399;">&#128231; Email Notification Options</strong>

            <div style="margin-top: 15px;">
                <label style="display: block; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachReports" checked>
                    Attach validation reports (compressed folder)
                </label>

                <label id="attachInputLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachInput" checked>
                    Attach input archive file
                </label>

                <label id="attachProjectLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachProject">
                    Attach project folder (compressed)
                </label>

                <p id="adminOverrideNote"
                    style="display: none; color: #ff6600; font-size: 13px; margin-top: 15px; font-style: italic;">
                    &#9888;&#65039; Note: Administrator has overridden attachment options via server configuration.
                </p>
            </div>
        </div>

        <button id="runBtn" onclick="runValidation()">&#128640; Run Aegis</button>



        <div id="loading" class="hidden loading">
            <p>&#8987; Running validation...</p>
            <p>This may take a few minutes depending on the number of APIs.</p>
        </div>
    </div>

    <!-- Configuration Script -->
    <script>
        // Automatic environment detection
        const isWrapper = window.location.pathname.includes('/apiguard/');
        
        // Configuration
        const CONFIG = {
            baseUrl: isWrapper ? "/apiguard/aegis" : "", 
            apiUrl: isWrapper ? "/apiguard/aegis/api/validate" : "/api/validate",
            statusCheckInterval: 2000,
            reportRetentionDays: 7
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function () {
            // Handle mode visibility based on environment
            if (isWrapper) {
                // Wrapper: Hide Local, Show ZIP/JAR
                const localLabel = document.getElementById('localLabel');
                if (localLabel) localLabel.style.display = 'none';
                
                // Default to ZIP
                selectMode('zip');
            } else {
                // Standalone: Show all (except Git disabled)
                // Default to Local
                selectMode('local');
            }

            // Hide email section in standalone mode (no SMTP configured)
            if (!isWrapper) {
                const emailSection = document.getElementById('emailSection');
                if (emailSection) {
                    emailSection.style.display = 'none';
                }
            }

            // Load saved session preferences for Git (Group, Filter, URL only)
            loadSessionPrefs();
            
            // Add listeners for exclusivity? No longer needed with View Switcher
            

            
            // Initialize view state
            loadProviderSelection();

            // 2. Attach Auto-save listeners to Inputs
            const inputsToSave = ['gitGroup', 'gitRepoFilter', 'gitUrl'];
            inputsToSave.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('input', saveSessionPrefs);
            });
            toggleGitView();

            // Restore persisted mode validation mode
            try {
                const savedMode = localStorage.getItem('aegis_validation_mode');
                console.log('[DEBUG] Restoring saved mode:', savedMode);
                if (savedMode) {
                    const radio = document.querySelector(`input[name="mode"][value="${savedMode}"]`);
                    if (radio) {
                        radio.checked = true;
                    } else {
                        console.warn('[DEBUG] Saved mode radio not found:', savedMode);
                    }
                } else {
                     // Default to Local if nothing saved
                     const localRadio = document.querySelector('input[name="mode"][value="local"]');
                     if(localRadio) localRadio.checked = true;
                }
                
                // Initial toggle based on restored or default
                handleModeChange(false);
            } catch (e) {
                console.error('[DEBUG] Error restoring session prefs:', e);
                alert('Aegis UI Error (Restore): ' + e.message);
            }

            // Initialize GitAnalyzer Bridge if in wrapper mode to ensure correct git config
            if (isWrapper) {
                fetch('/apiguard/gitanalyzer/api/config/ui').catch(e => console.warn('Failed to init GitAnalyzer config', e));
            }
        });

        // Sync provider selection when page becomes visible (user navigated back from Settings)
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                loadProviderSelection();
            }
        });
        
        // Also sync when window gains focus (for same-tab navigation)
        window.addEventListener('focus', function() {
            loadProviderSelection();
        });
        
        // Sync across tabs when localStorage changes in another tab
        window.addEventListener('storage', function(e) {
            if (e.key === 'aegis_git_provider' && e.newValue !== e.oldValue) {
                loadProviderSelection();
            }
        });
        
        function loadProviderSelection() {
            const savedProvider = localStorage.getItem('aegis_git_provider') || 'gitlab';
            const currentChecked = document.querySelector('input[name="gitProvider"]:checked');
            
            // ALWAYS select a provider if none is selected OR if it doesn't match saved
            if (!currentChecked || currentChecked.value !== savedProvider) {
                 const targetRadio = document.querySelector(`input[name="gitProvider"][value="${savedProvider}"]`);
                 if(targetRadio) {
                     targetRadio.checked = true;
                     handleProviderChange(false);
                 }
            }
        }
        
        function handleModeChange(save = true) {
            console.log('[DEBUG] handleModeChange called. Save:', save);
            try {
                if (save) {
                    const checked = document.querySelector('input[name="mode"]:checked');
                    if (checked) {
                        localStorage.setItem('aegis_validation_mode', checked.value);
                        console.log('[DEBUG] Saved mode:', checked.value);
                    }
                }
                toggleMode();
            } catch (e) {
                console.error('[DEBUG] Error in handleModeChange:', e);
                alert('Aegis UI Error (Mode Change): ' + e.message);
            }
        }


        // Use localStorage for Session Preferences (Non-sensitive)
        function loadSessionPrefs() {
                // Load input preference
                const savedMode = localStorage.getItem('aegis_validation_mode');
                if (savedMode) {
                    selectMode(savedMode);
                }

                // Load Git Settings (using vanilla JavaScript instead of jQuery)
                const savedGitUrl = localStorage.getItem('aegis_git_url');
                if (savedGitUrl) {
                    const gitUrlEl = document.getElementById('gitUrl');
                    if (gitUrlEl) gitUrlEl.value = savedGitUrl;
                }
                
                const savedGitBranch = localStorage.getItem('aegis_git_branch');
                if (savedGitBranch) {
                    const gitBranchEl = document.getElementById('gitBranch');
                    if (gitBranchEl) gitBranchEl.value = savedGitBranch;
                }
                
                const savedGitToken = localStorage.getItem('aegis_git_token');
                if (savedGitToken) {
                    const gitTokenEl = document.getElementById('gitToken');
                    if (gitTokenEl) gitTokenEl.value = savedGitToken;
                }

                // Load Toggle States
                const restored = localStorage.getItem('aegis_settings_restore');
                if (restored === 'true') {
                     // logic to restore checkboxes
                } 
            }

        function saveSessionPrefs() {
            // Auto-save session preferences (Sticky Session)
            localStorage.setItem('aegis_session_group', document.getElementById('gitGroup').value);
            localStorage.setItem('aegis_session_filter', document.getElementById('gitRepoFilter').value);
            localStorage.setItem('aegis_session_url', document.getElementById('gitUrl').value);
        }
        
        function clearGitCreds() {
            // Clears session prefs
            localStorage.removeItem('aegis_session_group');
            localStorage.removeItem('aegis_session_filter');
            localStorage.removeItem('aegis_session_url');
            
            document.getElementById('gitGroup').value = '';
            document.getElementById('gitRepoFilter').value = '';
            document.getElementById('gitUrl').value = '';
            document.getElementById('repoResultsSection').style.display = 'none';
            document.getElementById('branchSection').style.display = 'none';
            alert("Session preferences cleared.");
        }
        
        function toggleGitView() {
            const mode = document.querySelector('input[name="gitViewMode"]:checked').value;
            
            const discoveryPanel = document.getElementById('gitDiscoveryPanel');
            const manualPanel = document.getElementById('gitManualPanel');
            
            // Toggle visibility
            discoveryPanel.style.display = mode === 'discovery' ? 'block' : 'none';
            manualPanel.style.display = mode === 'manual' ? 'block' : 'none';
            
            // Update Tab Styles
            const discLabel = document.getElementById('modeDiscoveryLabel');
            const manLabel = document.getElementById('modeManualLabel');
            
            if (mode === 'discovery') {
                discLabel.style.backgroundColor = '#663399';
                discLabel.style.color = 'white';
                manLabel.style.backgroundColor = 'white';
                manLabel.style.color = '#663399';
            } else {
                discLabel.style.backgroundColor = 'white';
                discLabel.style.color = '#663399';
                manLabel.style.backgroundColor = '#663399';
                manLabel.style.color = 'white';
            }
        }
        
        // Removed old toggleGitInputs and handleCredsToggle as they are obsolete

        
        function saveGitCreds() {
            if (document.getElementById('saveGitCreds').checked) {
                localStorage.setItem('aegis_git_group', document.getElementById('gitGroup').value);
                localStorage.setItem('aegis_git_filter', document.getElementById('gitRepoFilter').value);
                localStorage.setItem('aegis_git_token', document.getElementById('gitToken').value);
                const providerRadio = document.querySelector('input[name="gitProvider"]:checked');
                if (providerRadio) localStorage.setItem('aegis_git_provider', providerRadio.value);
                localStorage.setItem('aegis_git_url', document.getElementById('gitUrl').value);
            }
            // Always save Custom Rules path if provided? Or only if checked?
            // User requested persistence, so let's save if checked or always. 
            // Let's assume if checked 'Remember git details' means 'Remember settings'.
            // Actually user asked for "remember custom rules option". 
            // Let's save custom rules whenever saveGitCreds is called, which happens on Run.
             if (document.getElementById('saveGitCreds').checked) {
                const customRulesPath = document.getElementById('customRules').value;
                if (customRulesPath) localStorage.setItem('aegis_custom_rules', customRulesPath);
             }
        }
        
        function clearGitCreds() {
            localStorage.removeItem('aegis_git_group');
            localStorage.removeItem('aegis_git_filter');
            localStorage.removeItem('aegis_git_token');
            localStorage.removeItem('aegis_git_provider');
            localStorage.removeItem('aegis_git_url');
            
            document.getElementById('gitGroup').value = '';
            document.getElementById('gitRepoFilter').value = '';
            document.getElementById('gitToken').value = '';
            document.getElementById('gitUrl').value = '';
            document.getElementById('repoResultsSection').style.display = 'none';
            document.getElementById('branchSection').style.display = 'none';
            document.getElementById('saveGitCreds').checked = false;
            toggleGitInputs(); // Reset state
            alert("Saved git credentials cleared.");
        }
        
        function toggleGitInputs() {
            const groupVal = document.getElementById('gitGroup').value.trim();
            const filterVal = document.getElementById('gitRepoFilter').value.trim();
            const urlVal = document.getElementById('gitUrl').value.trim();
            
            const groupActive = groupVal.length > 0 || filterVal.length > 0;
            const urlActive = urlVal.length > 0;
            
            // Manual URL inputs
            document.getElementById('gitUrl').disabled = groupActive;
            document.getElementById('fetchBranchesManualBtn').disabled = groupActive;
            if (groupActive) {
                document.getElementById('gitUrl').title = "Clear Group/Org fields to use Manual URL";
                document.getElementById('manualGitUrl').style.opacity = '0.5';
            } else {
                 document.getElementById('gitUrl').title = "";
                 document.getElementById('manualGitUrl').style.opacity = '1';
            }

            // Discovery inputs
            document.getElementById('gitGroup').disabled = urlActive;
            document.getElementById('gitRepoFilter').disabled = urlActive;
            document.getElementById('fetchReposBtn').disabled = urlActive;
            if (urlActive) {
                 document.getElementById('gitGroup').parentElement.parentElement.style.opacity = '0.5';
            } else {
                 document.getElementById('gitGroup').parentElement.parentElement.style.opacity = '1';
            }
        }

        function handleCredsToggle() {
             if (!document.getElementById('saveGitCreds').checked) {
                 clearGitCreds();
             }
        }



        function downloadSample(filename) {
            const url = CONFIG.resourceBase + '/' + filename;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function selectMode(modeValue) {
            const radio = document.querySelector(`input[name="mode"][value="${modeValue}"]`);
            if (radio) {
                radio.checked = true;
                toggleMode();
            }
        }

        function toggleMode() {
            try {
                const radio = document.querySelector('input[name="mode"]:checked');
                if (!radio) {
                    console.warn('[DEBUG] No mode radio selected');
                    return;
                }
                
                const mode = radio.value;
                console.log('[DEBUG] toggleMode executing. Mode:', mode);
                
                const localInput = document.getElementById('localInput');
                const zipInput = document.getElementById('zipInput');
                const jarInput = document.getElementById('jarInput');
                const gitInput = document.getElementById('gitInput');
                
                if (!localInput || !zipInput || !jarInput || !gitInput) {
                    console.error('[DEBUG] One or more input sections missing from DOM', {
                        local: !!localInput, zip: !!zipInput, jar: !!jarInput, git: !!gitInput
                    });
                    return;
                }
                
                localInput.classList.toggle('hidden', mode !== 'local');
                zipInput.classList.toggle('hidden', mode !== 'zip');
                jarInput.classList.toggle('hidden', mode !== 'jar');
                gitInput.classList.toggle('hidden', mode !== 'git');
                
                console.log('[DEBUG] gitInput hidden?', gitInput.classList.contains('hidden'));
                if (mode === 'git' && gitInput.classList.contains('hidden')) {
                     // Force remove if classList toggle failed logic somehow
                     gitInput.classList.remove('hidden'); 
                     console.log('[DEBUG] Forced remove hidden from gitInput');
                }
                
                // Show/hide attachment options
                if (mode === 'zip' || mode === 'jar') {
                    document.getElementById('attachInputLabel').style.display = 'block';
                    document.getElementById('attachProjectLabel').style.display = 'none';
                } else if (mode === 'git') {
                    document.getElementById('attachInputLabel').style.display = 'none';
                    document.getElementById('attachProjectLabel').style.display = 'block';
                } else {
                    document.getElementById('attachInputLabel').style.display = 'none';
                    document.getElementById('attachProjectLabel').style.display = 'block';
                }
            } catch (e) {
                console.error('[DEBUG] Error in toggleMode:', e);
                alert('Aegis UI Error (Toggle): ' + e.message);
            }
        }

        function updateNavLinks(sessionId) {
            document.querySelectorAll('.nav-button').forEach(link => {
                const href = link.getAttribute('href');
                if (href && href !== '#' && !href.includes('session=')) {
                    link.setAttribute('href', href + (href.includes('?') ? '&' : '?') + 'session=' + sessionId);
                }
            });
        }

        function showProgress(show, title = "Validating Project...", text = "Running comprehensive analysis...") {
            const modal = document.getElementById('progressModal');
            if (show) {
                document.getElementById('progressTitle').innerText = title;
                document.getElementById('progressText').innerText = text;
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function runValidation() {
            const radio = document.querySelector('input[name="mode"]:checked');
            if (!radio) {
                showAlert('Please select an input mode');
                return;
            }
            const mode = radio.value;
            const formData = new FormData();
            
            // Get session ID
            const sessionId = new URLSearchParams(window.location.search).get('session');
            if (sessionId) formData.append('session', sessionId);
            
            formData.append('mode', mode);

            // Validation logic based on mode
            if (mode === 'local') {
                const path = document.getElementById('folderPath').value;
                if (!path) {
                    showAlert('Please enter a folder path');
                    return;
                }
                formData.append('path', path);
                showProgress(true, "Scanning Local Project", "Analyzing files in " + path + "...");
            } else if (mode === 'zip') {
                const file = document.getElementById('zipFile').files[0];
                if (!file) {
                    showAlert('Please select a ZIP file');
                    return;
                }
                formData.append('archive', file);
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            } else if (mode === 'jar') {
                const file = document.getElementById('jarFile').files[0];
                if (!file) {
                    showAlert('Please select a JAR file');
                    return;
                }
                formData.append('archive', file);
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            } else if (mode === 'git') {
                // Determine Provider
                // Global Selection
                const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
                let provider = providerSelect ? providerSelect.value : 'gitlab';
                const gitViewMode = document.querySelector('input[name="gitViewMode"]:checked').value;
                let gitUrls = "";
                
                if (gitViewMode === 'discovery') {
                     const fetchedUrls = document.getElementById('gitUrls').value;
                     if (!fetchedUrls) {
                         showAlert('Please select repositories from the list');
                         return;
                     }
                     gitUrls = fetchedUrls;
                      // In discovery mode, provider is selected explicitly - ALREADY SET TO GLOBAL 'provider'
                } else {
                     const manualUrl = document.getElementById('gitUrl').value;
                     if (!manualUrl) {
                         showAlert('Please enter a Manual Git URL');
                         return;
                     }
                     gitUrls = manualUrl;
                     
                     // Use explicit selection in manual mode
                     // Use explicit selection in manual mode
                }
                
                formData.append('gitUrls', gitUrls);
                const selectedBranch = document.getElementById('gitBranchDropdown').value || "";
                formData.append('gitBranch', selectedBranch);
                
                // Get Token based on Provider
                let token = "";
                if (provider === 'github') {
                    token = localStorage.getItem('aegis_github_token') || "";
                } else if (provider === 'gitlab') {
                    token = localStorage.getItem('aegis_gitlab_token') || "";
                } else {
                    // Other provider - user should have set 'Other' token if needed
                    token = localStorage.getItem('aegis_other_token') || "";
                }
                
                // Fallback (Legacy)
                if (!token) token = localStorage.getItem('aegis_git_token') || "";

                if(!token) {
                    console.warn(`No ${provider} token found. Creating public request.`);
                    // Optional: could just proceed without token for public repos
                }
                formData.append('gitToken', token);
                
                // Save session preferences
                saveSessionPrefs();
                
                const repoCount = gitUrls.split(',').length;
                showProgress(true, "Cloning & Scanning", `Cloning ${repoCount} repository(s) from ${provider} and running analysis...`);
            }

            // Custom rules
            const customRules = document.getElementById('customRules').files[0];
            if (customRules) {
                formData.append('customRules', customRules);
            }

            // Email options
            formData.append('attachReports', document.getElementById('attachReports').checked);
            formData.append('attachInput', document.getElementById('attachInput').checked);
            formData.append('attachProject', document.getElementById('attachProject').checked);

            // UI State
            document.getElementById('runBtn').disabled = true;

            // API Call
            fetch(CONFIG.apiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showProgress(false); // Hide progress
                document.getElementById('runBtn').disabled = false;
                
                if (data.status === 'success' || data.success === true) {
                    handleSuccess(data, mode, sessionId);
                } else {
                    showAlert('Error: ' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                showProgress(false); // Hide progress
                showAlert('Network Error: ' + error.message);
                document.getElementById('runBtn').disabled = false;
            });
        }
        
        function handleSuccess(data, mode, sessionId) {
            // Use the session ID returned from the server if the initial one was null
            const activeSessionId = data.sessionId || sessionId;

            let message = '';
            // Basic report link logic
            const reportName = data.reportFolder || 'validation-report';
            const resourceBase = CONFIG.resourceBase;
            const openReportUrl = resourceBase + '/' + reportName + '/report.html';
            
            if (mode === 'local') {
                // Escape path for string literal usage in onclick
                const safePath = data.reportPath.replace(/\\/g, '\\\\');
                
                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report generated at: <br><code>${data.reportPath}</code></p>
                    <div style="margin-top:20px;">
                        <button class="btn-primary" onclick="openLocalReportApi('${safePath}')">Open Report in Browser</button>
                    </div>
                `;
            } else {
                // ZIP/JAR mode uses the server's relative URL if available, or constructs one
                // The backend now returns 'relativeReportUrl' which is safer
                let finalUrl = openReportUrl;
                if (data.relativeReportUrl) {
                    finalUrl = CONFIG.baseUrl + '/reports/' + activeSessionId + '/' + data.relativeReportUrl;
                }

                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report has been generated.</p>
                    <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                        <button class="btn-primary" onclick="window.open('${finalUrl}', '_blank')">View Report Online</button>
                `;
                
                if (data.reportZip) {
                    message += `<button class="btn-primary" style="background:#555;" onclick="window.location.href='${CONFIG.baseUrl}/download?file=${encodeURIComponent(data.reportZip)}&session=${activeSessionId}'">Download Report ZIP</button>`;
                } else {
                     message += `<button class="btn-primary" style="background:#aa5; cursor:not-allowed;" disabled>Download ZIP Not Available</button>`;
                }
                
                message += `</div>`;
            }

            showAlert(message, true);
        }

        function openLocalReportApi(path) {
            // Use the backend API to open the file on the host OS
            const formData = new URLSearchParams();
            formData.append('path', path);
            
            // Handle context path if in wrapper
            const apiBase = CONFIG.baseUrl || ''; 
            
            fetch(apiBase + '/api/open', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if(!d.success) alert('Failed to open report automatically. Please open the file manually: ' + path);
            })
            .catch(e => alert('Error requesting to open report: ' + e.message));
        }

        function showAlert(message, isHtml = false) {
            const modalBody = document.getElementById('modalMessage');
            if (isHtml) {
                modalBody.innerHTML = message;
            } else {
                modalBody.textContent = message;
            }
            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }

         function handleProviderChange(clearInputs = true) {
              const provider = document.querySelector('input[name="gitProvider"]:checked').value;
              localStorage.setItem('aegis_git_provider', provider);
              
              if (clearInputs) {
                  // Contextual Input Clearing
                  document.getElementById('gitGroup').value = '';
                  document.getElementById('gitRepoFilter').value = '';
                  document.getElementById('gitUrl').value = '';
                  document.getElementById('repoList').innerHTML = '';
                  document.getElementById('repoResultsSection').style.display = 'none';
                  // Also clear session prefs to avoid restoring confused state
                  localStorage.removeItem('aegis_session_group');
                  localStorage.removeItem('aegis_session_filter');
                  localStorage.removeItem('aegis_session_url');
                  
                  // Auto-fill defaults from Settings
                  if (provider === 'gitlab') {
                      const def = localStorage.getItem('aegis_gitlab_group');
                      if(def) {
                          document.getElementById('gitGroup').value = def;
                          saveSessionPrefs();
                      }
                  } else if (provider === 'github') {
                      const def = localStorage.getItem('aegis_github_group');
                      if(def) {
                          document.getElementById('gitGroup').value = def;
                          saveSessionPrefs();
                      }
                  }

             }
             
             // Logic: disable Discovery for 'Other'
             const discoveryRadio = document.querySelector('input[name="gitViewMode"][value="discovery"]');
             const discoveryLabel = document.getElementById('modeDiscoveryLabel');
             const viewContainer = document.getElementById('viewModeContainer');
             
             if (provider === 'other') {
                 // Force Manual Mode
                 document.querySelector('input[name="gitViewMode"][value="manual"]').checked = true;
                 toggleGitView(); // Switch view
                 
                 // Disable Discovery UI
                 discoveryRadio.disabled = true;
                 discoveryLabel.style.opacity = '0.5';
                 discoveryLabel.style.pointerEvents = 'none';
                 discoveryLabel.title = "Discovery not available for Other providers";
             } else {
                 // Enable Discovery
                 discoveryRadio.disabled = false;
                 discoveryLabel.style.opacity = '1';
                 discoveryLabel.style.pointerEvents = 'auto';
                 discoveryLabel.title = "";
             }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                /* Optional toast or alert, or just let user know via tooltip */
                const btn = document.querySelector('button[onclick^="copyToClipboard"]');
                if(btn) {
                    const originalText = btn.innerText;
                    btn.innerText = "Copied!";
                    setTimeout(() => btn.innerText = originalText, 1500);
                }
            });
        }

        // Git Discovery Functions
        async function fetchGitRepos() {
            // Check Provider first
            const provider = document.querySelector('input[name="gitProvider"]:checked').value;
            if (provider === 'other') {
                showAlert("Discovery Mode is not supported for 'Other' providers. Please use Manual Git URL.");
                return;
            }

            let group = document.getElementById('gitGroup').value;
            const filter = document.getElementById('gitRepoFilter').value;
            const btn = document.getElementById('fetchReposBtn');
            
            if (!group) {
                showAlert('Please enter a Group or Organization name');
                return;
            }

            // Auto-sanitize: If user entered full URL, extract the group part
            // Handles https://gitlab.com/groupname or https://github.com/orgname
            group = group.trim();
            if (group.startsWith('http')) {
                 const urlParts = group.split('/');
                 // usually last part, or last non-empty part
                 // ex: https://gitlab.com/raks-group -> raks-group
                 // ex: https://gitlab.com/raks-group/ -> raks-group
                 group = urlParts.filter(p => p.length > 0).pop();
            }
            
            // Get credentials from Settings
            let token = '';
            // const provider already defined above
            if (provider === 'github') {
                token = localStorage.getItem('aegis_github_token') || '';
            } else if (provider === 'gitlab') {
                token = localStorage.getItem('aegis_gitlab_token') || '';
            }
            
            // Fallback
            // Fallback
            if (!token) token = localStorage.getItem('aegis_git_token') || '';
            
            console.log(`[DEBUG] fetchGitRepos: Provider=${provider}, TokenLength=${token ? token.length : 0}`);
            if(token && token.length > 0) console.log(`[DEBUG] Token starts with: ${token.substring(0, 4)}...`);
            
            const gitlabUrl = localStorage.getItem('aegis_gitlab_url') || '';
            const githubUrl = localStorage.getItem('aegis_github_url') || '';
            
            // Optional: Warn about missing token but don't block
            if (!token) {
                console.warn("No Token found for " + provider + ". Attempting public access.");
            }

            btn.disabled = true;
            btn.innerText = 'Fetching...';
            showProgress(true, "Discovering Repositories", `Fetching projects for '${group}' from ${provider}...`);
            
            try {
                // Adjust API base for discovery
                // Adjust API base for discovery -> Use Aegis Wrapper endpoints
                // Use new Aegis Recursive Discovery flow
                const apiBase = isWrapper ? '/apiguard/aegis' : CONFIG.baseUrl;
                // GitAnalyzer uses /api/download/list, Aegis Standalone uses /api/git/repos
                // WRAPPER NOW USES /api/git/repos (Unified)
                const endpoint = '/api/git/repos';
                let url = apiBase + `${endpoint}?group=${encodeURIComponent(group)}&filter=${encodeURIComponent(filter)}&provider=${encodeURIComponent(provider)}`;
                
                if(gitlabUrl) url += `&gitlabUrl=${encodeURIComponent(gitlabUrl)}`;
                if(githubUrl) url += `&githubUrl=${encodeURIComponent(githubUrl)}`;
                
                const headers = { 'x-git-token': token, 'x-git-provider': provider };
                
                const response = await fetch(url, { headers: headers });
                if (!response.ok) {
                    let errMsg = 'Failed to fetch repositories.';
                    try {
                        // The backend might return standard error page or JSON
                        const errText = await response.text(); 
                        // Try parsing JSON first
                        try {
                            const errJson = JSON.parse(errText);
                            if (errJson.message) errMsg = errJson.message;
                        } catch(e) {
                             // If not JSON, check for HTML error
                             if (errText.includes('GitLab Group/User not found')) {
                                 errMsg = "GitLab Group/User not found (404). Please check the name.";
                             } else {
                                 errMsg += " Server responded with " + response.status;
                             }
                        }
                    } catch(e) { console.warn("Failed to parse error response", e); }
                    
                    throw new Error(errMsg);
                }
                
                let repos = await response.json();
                
                // Robust parsing for various backend return types
                if (typeof repos === 'string') {
                    try { repos = JSON.parse(repos); } catch(e) { console.error("Failed to parse repo string", e); }
                }
                // Handle wrapped object (e.g. { "repos": [...] } or { "result": [...] })
                if (!Array.isArray(repos) && typeof repos === 'object') {
                    if (Array.isArray(repos.repos)) repos = repos.repos;
                    else if (Array.isArray(repos.result)) repos = repos.result;
                    // If map but unclear, try Object.keys or values? No, safer to fail or show raw.
                }

                const list = document.getElementById('repoList');
                list.innerHTML = '';
                
                if (!Array.isArray(repos) || repos.length === 0) {
                    list.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">No repositories found.</div>';
                    if(!Array.isArray(repos)) console.warn('Expected array but got:', repos);
                } else {
                    repos.forEach(repo => {
                        const div = document.createElement('div');
                        div.style.padding = '5px 0';
                        div.innerHTML = `<label style="font-weight:normal; display:flex; align-items:center; cursor:pointer; margin:0;">
                            <input type="checkbox" class="repo-check" value="${repo}" style="width:auto; margin-right:8px;" onchange="updateSelectedRepos()"> ${repo}
                        </label>`;
                        list.appendChild(div);
                    });
                }
                document.getElementById('repoResultsSection').style.display = 'block';
            } catch (err) {
                showProgress(false);
                showAlert('Error: ' + err.message);
            } finally {
                showProgress(false);
                btn.disabled = false;
                btn.innerText = 'Fetch Repos';
            }
        }

        function toggleAllRepos(checked) {
            const checks = document.querySelectorAll('.repo-check');
            checks.forEach(c => c.checked = checked);
            updateSelectedRepos();
        }

        function updateSelectedRepos() {
            const checks = document.querySelectorAll('.repo-check:checked');
            const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
            const provider = providerSelect ? providerSelect.value : 'gitlab';
            
            const urls = Array.from(checks).map(c => {
                 const repo = c.value;
                 if (provider === 'github') return `https://github.com/${repo}.git`;
                 else return `https://gitlab.com/${repo}.git`;
            });
            document.getElementById('gitUrls').value = urls.join(',');
            document.getElementById('repoCountLabel').innerText = `${urls.length} selected`;
        }

        async function fetchGitBranches(isManual = false) {
            let repoToFetch = "";
            if (isManual) {
                repoToFetch = document.getElementById('gitUrl').value;
                if (!repoToFetch) {
                    showAlert('Please enter a Manual Git URL first');
                    return;
                }
            } else {
                const checks = document.querySelectorAll('.repo-check:checked');
                if (checks.length === 0) {
                    showAlert('Please select at least one repository first');
                    return;
                }
                repoToFetch = checks[0].value;
            }
            
            // Get credentials from Settings
            // Determine Provider for Fetch
            let provider = 'gitlab';
            let token = '';

            if (isManual) {
                // Smart Provider Detection
                if (repoToFetch.includes('github.com')) {
                     provider = 'github';
                     // Auto-update UI to match? Optional, but good for feedback
                     // const radio = document.querySelector('input[name="gitProvider"][value="github"]');
                     // if(radio) radio.checked = true;
                } else if (repoToFetch.includes('gitlab.com')) {
                     provider = 'gitlab';
                } else {
                     // Use explicit selection as fallback
                     const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
                     provider = providerSelect ? providerSelect.value : 'gitlab';
                }
            } else {
                // Use selected provider in discovery mode
                 const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
                 provider = providerSelect ? providerSelect.value : 'gitlab';
            }
            
            // Get credentials from Settings
            if (provider === 'github') {
                token = localStorage.getItem('aegis_github_token') || '';
            } else {
                token = localStorage.getItem('aegis_gitlab_token') || '';
            }
            const gitlabUrl = localStorage.getItem('aegis_gitlab_url') || '';
            const githubUrl = localStorage.getItem('aegis_github_url') || '';

            const btn = isManual ? document.getElementById('fetchBranchesManualBtn') : document.getElementById('fetchBranchesBtn');
            const status = document.getElementById('branchStatus');

            btn.disabled = true;
            if (!isManual) status.innerText = 'Fetching...';
            showProgress(true, "Discovering Branches", `Fetching branches for ${repoToFetch}...`);
            
            try {
                const apiBase = isWrapper ? '/apiguard/aegis' : CONFIG.baseUrl;
                // GitAnalyzer uses /api/download/branches, Aegis Standalone uses /api/git/branches
                // WRAPPER NOW USES /api/git/branches via Aegis-Wrapper Flow
                const endpoint = '/api/git/branches';
                let url = apiBase + `${endpoint}?repo=${encodeURIComponent(repoToFetch)}`;
                
                if(gitlabUrl) url += `&gitlabUrl=${encodeURIComponent(gitlabUrl)}`;
                if(githubUrl) url += `&githubUrl=${encodeURIComponent(githubUrl)}`;
                
                const headers = { 'x-git-token': token, 'x-git-provider': provider };
                
                const response = await fetch(url, { headers: headers });
                if (!response.ok) {
                    let errMsg = 'Failed to fetch branches';
                    try {
                         const errData = await response.json();
                         if(errData && errData.message) errMsg = errData.message;
                    } catch(e) { console.warn("Failed to parse error response", e); }
                    throw new Error(errMsg);
                }
                
                const branches = await response.json();
                const select = document.getElementById('gitBranchDropdown');
                select.innerHTML = '';
                
                if (!branches || branches.length === 0) {
                    select.innerHTML = '<option value="">No branches found</option>';
                } else if (!Array.isArray(branches)) {
                    // Handle error response from backend
                    const errorMsg = branches.error || branches.message || JSON.stringify(branches);
                    throw new Error('Backend Error: ' + errorMsg);
                } else {
                    branches.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.innerText = b;
                        if (b === 'main' || b === 'master') opt.selected = true;
                        select.appendChild(opt);
                    });
                }
                document.getElementById('branchSection').style.display = 'block';
                if (!isManual) {
                    status.innerText = 'Done';
                    setTimeout(() => { status.innerText = ''; }, 2000);
                }
                showProgress(false);
            } catch (err) {
                showProgress(false);
                showAlert('Error: ' + err.message);
                if (!isManual) status.innerText = 'Error';
            } finally {
                showProgress(false);
                btn.disabled = false;
            }
        }
    </script>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="progressTitle" style="color: #333; margin-bottom: 10px;">Validating Project...</h3>
            <div class="progress-container">
                <div class="progress-bar indeterminate"></div>
            </div>
            <p id="progressText" style="color: #666; margin-top: 15px; font-size: 14px;">Running comprehensive analysis. This may take a moment...</p>
        </div>
    </div>
    
    <!-- Message Modal (Reuses modal-content style) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: #663399; margin-bottom: 15px;">Aegis Notification</h3>
            <div id="modalMessage" style="margin-bottom: 20px; color: #333;"></div>
            <button onclick="closeModal()" style="padding: 8px 20px; background: #663399; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>

</body>
</html>

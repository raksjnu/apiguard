<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Download - GitAnalyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <div class="raks-frame">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light brand-header mb-0 flex-shrink-0">
            <div class="container-fluid">
                <a class="navbar-brand d-flex align-items-center" href="/">
                    <img src="assets/images/logo.png" alt="Logo" class="d-inline-block align-text-top me-2" height="40">
                    ApiGuard Portal - GitAnalyzer
                </a>
                <div class="d-flex">
                    <a href="guide.html#bulk" class="btn btn-purple me-2 d-flex align-items-center" target="_blank">
                        <span class="me-2">ðŸ“˜</span> Guide / Help
                    </a>
                    <a href="/" class="btn btn-outline-light ghost-btn">Dashboard</a>
                </div>
            </div>
        </nav>

        <!-- Split Layout -->
        <div class="split-container">
            <!-- Left Panel: Configuration -->
            <div class="split-left" id="leftPanel">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0 fw-bold text-purple">Bulk Configuration</h5>
                    <div class="badge bg-light text-dark p-2 border">
                         <select class="form-select form-select-sm border-0 bg-transparent p-0 d-inline-block w-auto fw-bold" id="gitProviderSelect" style="box-shadow:none;">
                             <option value="gitlab">GitLab</option>
                             <option value="github">GitHub</option>
                         </select>
                         <span class="mx-1">|</span>
                         <input type="password" id="gitTokenInput" placeholder="Token Optional" class="border-0 bg-transparent p-0 small" style="width: 80px; outline:none;">
                    </div>
                </div>

                <form id="downloadForm">
                    <div class="sub-frame mb-3">
                         <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">1. Discovery Criteria</h6>
                         <div class="mb-3">
                            <label class="form-label small fw-bold">Git Group / Organization</label>
                            <input type="text" class="form-control form-control-sm" id="groupName" placeholder="e.g. raks-group">
                        </div>
                        <div class="mb-3">
                             <label class="form-label small fw-bold">Filter (Regex)</label>
                             <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filterPattern" placeholder="e.g. .*service.*">
                                <button type="button" class="btn btn-sub-action" id="fetchGroupBtn">Fetch Repositories</button>
                             </div>
                        </div>
                    </div>
                    
                    <div class="sub-frame mb-3">
                        <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">2. Manual Addition</h6>
                        <label class="form-label small fw-bold">Add Single Repository</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="manualRepoInput" placeholder="group/project">
                            <button class="btn btn-sub-action" type="button" id="addManualBtn">Add</button>
                        </div>
                    </div>

                    <div class="sub-frame mb-3">
                         <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">3. Options</h6>
                          <div class="mb-2">
                             <label class="form-label small fw-bold">Output Directory (Optional)</label>
                             <input type="text" class="form-control form-control-sm" id="targetDir" placeholder="e.g. C:\MyDownloads">
                          </div>
                          <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="branchManualInput" placeholder="Branch (e.g. master)">
                            <button class="btn btn-sub-action" type="button" id="fetchBranchesBtn">Fetch Branches</button>
                        </div>
                        <div class="form-text x-small">Click Fetch to see available branches for selected repos.</div>
                        <div id="branchChecklist" class="d-none"></div> <!-- Hidden for now, logic handles it differently? Or I need to adapt logic? -->
                    </div>

                    <button type="submit" class="btn btn-purple text-white w-100 py-2 shadow-sm" id="downloadBtn">
                        <i class="bi bi-download me-2"></i> Download Selected
                    </button>
                </form>
            </div>

            <!-- Resizer -->
            <div class="resizer" id="dragMe"></div>

            <!-- Right Panel: Results -->
            <div class="split-right" id="rightPanel">
                
                <h5 class="text-purple fw-bold mb-3">Repositories to Download</h5>
                
                <div class="d-flex justify-content-between align-items-center mb-2 bg-light p-2 rounded border">
                    <div class="form-check">
                        <small>
                            <a href="#" id="selectAllBtn" class="text-decoration-none me-2 fw-bold">Select All</a>
                            <span class="text-muted">|</span>
                            <a href="#" id="deselectAllBtn" class="text-decoration-none ms-2">Deselect All</a>
                        </small>
                    </div>
                </div>

                <div class="card shadow-sm border-0 mb-3" style="min-height: 200px;">
                    <div class="card-body p-0">
                         <div id="repoChecklist" class="p-2" style="max-height: 400px; overflow-y: auto;">
                            <!-- Checkboxes injected here -->
                            <div class="text-muted text-center mt-5">
                                <i class="bi bi-cloud-download display-4 opacity-25"></i>
                                <p class="mt-2 text-muted small">No repositories fetched yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status/Console Output -->
                <div id="resultsSection" class="d-none animate-fade-in">
                    <div class="card bg-dark text-white border-0 shadow-sm mt-3">
                        <div class="card-header bg-dark border-bottom border-secondary py-2">
                            <small class="text-uppercase fw-bold text-muted">Download Status</small>
                        </div>
                        <div class="card-body p-2">
                            <div id="statusSummary" class="alert alert-info py-2 small mb-2"></div>
                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                <table class="table table-dark table-sm table-hover align-middle mb-0">
                                    <thead>
                                        <tr>
                                            <th>Repo</th>
                                            <th>Branch</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="resultsTableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    
        <!-- Footer -->
        <footer class="raks-footer text-center mt-auto flex-shrink-0">
            <div class="container" id="footerText">
                &copy; 2026 RAKS - Enterprise API Solution Suite - ApiGuard
            </div>
        </footer>
    </div>
    
    <script>
        // --- Resizer Logic ---
        const resizer = document.getElementById('dragMe');
        const leftPanel = document.getElementById('leftPanel');
        let x = 0;
        let leftWidth = 0;

        const mouseDownHandler = function (e) {
            x = e.clientX;
            leftWidth = leftPanel.getBoundingClientRect().width;
            resizer.classList.add('resizing');
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.body.style.userSelect = 'none';
        };

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - x;
            const newLeftWidth = leftWidth + dx;
            if (newLeftWidth > 250 && newLeftWidth < 800) {
                 leftPanel.style.width = `${newLeftWidth}px`;
            }
        };

        const mouseUpHandler = function () {
            resizer.classList.remove('resizing');
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.body.style.removeProperty('user-select');
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
    </script>
    
    <script>
        fetch('/api/config/ui').then(r=>r.json()).then(c=>{
            if(c['ui.footer.text']) document.getElementById('footerText').innerText=c['ui.footer.text'];
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Persistence Logic ---
        const STORE_KEY_PROVIDER = 'git_analyzer_provider';
        const STORE_KEY_TOKEN = 'git_analyzer_token';

        const providerSelect = document.getElementById('gitProviderSelect');
        const tokenInput = document.getElementById('gitTokenInput');

        // Load valid values from localStorage
        if (providerSelect && tokenInput) {
             const savedProvider = localStorage.getItem(STORE_KEY_PROVIDER);
             if (savedProvider) providerSelect.value = savedProvider;
    
             const savedToken = localStorage.getItem(STORE_KEY_TOKEN);
             if (savedToken) tokenInput.value = savedToken;
    
             // Save on change
             providerSelect.addEventListener('change', () => {
                 localStorage.setItem(STORE_KEY_PROVIDER, providerSelect.value);
             });
    
             tokenInput.addEventListener('input', () => {
                 localStorage.setItem(STORE_KEY_TOKEN, tokenInput.value);
             });
        }

        // Helper to get Headers
        function getGitHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            const pSelect = document.getElementById('gitProviderSelect');
            if (pSelect) headers['X-Git-Provider'] = pSelect.value;
            
            const tInput = document.getElementById('gitTokenInput');
            if (tInput) {
                const token = tInput.value.trim();
                if (token) headers['X-Git-Token'] = token;
            }
            return headers;
        }

        // --- Persistence Logic (Form Fields) ---
        const FIELDS_TO_PERSIST = ['groupName', 'filterPattern', 'targetDir'];
        
        FIELDS_TO_PERSIST.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Restore
                const val = localStorage.getItem('git_analyzer_' + id);
                if (val) el.value = val;
                
                // Save
                el.addEventListener('input', () => {
                    localStorage.setItem('git_analyzer_' + id, el.value);
                });
            }
        });

        // Restore Manual Repos
        const savedManual = localStorage.getItem('git_analyzer_manual_repos');
        if (savedManual) {
            try {
                const repos = JSON.parse(savedManual);
                const container = document.getElementById('repoChecklist');
                if (repos.length > 0 && container.innerText.includes('No repositories')) {
                    container.innerHTML = '';
                }
                repos.forEach(r => container.appendChild(createCheckbox(r, true)));
            } catch(e) { console.error('Error loading manual repos', e); }
        }

        function saveManualRepo(repo) {
            let repos = [];
            const existing = localStorage.getItem('git_analyzer_manual_repos');
            if (existing) {
                try { repos = JSON.parse(existing); } catch(e) {}
            }
            if (!repos.includes(repo)) {
                repos.push(repo);
                localStorage.setItem('git_analyzer_manual_repos', JSON.stringify(repos));
            }
        }


        // Checkbox Helper
        function createCheckbox(repoName, checked=true) {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input repo-checkbox" type="checkbox" value="${repoName}" id="chk_${repoName.replace(/\W/g,'_')}" ${checked ? 'checked' : ''}>
                <label class="form-check-label" for="chk_${repoName.replace(/\W/g,'_')}">
                    ${repoName}
                </label>
            `;
            return div;
        }

        // Add Manual Repo
        document.getElementById('addManualBtn').addEventListener('click', () => {
            const val = document.getElementById('manualRepoInput').value.trim();
            if(val) {
                const container = document.getElementById('repoChecklist');
                // clear empty message if needed
                if(container.innerText.includes('No repositories')) container.innerHTML = '';
                container.appendChild(createCheckbox(val, true));
                saveManualRepo(val); // Save to persistence
                document.getElementById('manualRepoInput').value = '';
            }
        });

        // Select/Deselect All
        document.getElementById('selectAllBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.repo-checkbox').forEach(c => c.checked = true);
        });
        document.getElementById('deselectAllBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.repo-checkbox').forEach(c => c.checked = false);
        });

        // Fetch Group Logic (Restored)
        document.getElementById('fetchGroupBtn').addEventListener('click', async (e) => {
             e.preventDefault(); // Important for <a> tag
             const groupInput = document.getElementById('groupName').value;
             const filterInput = document.getElementById('filterPattern').value;
             const btn = document.getElementById('fetchGroupBtn');
             const originalText = btn.textContent;
             
             btn.classList.add('disabled');
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fetching...';
             
             try {
                let url = '/api/download/list';
                const params = new URLSearchParams();
                if (groupInput) params.append('group', groupInput);
                if (filterInput) params.append('filter', filterInput);
                
                const response = await fetch(url + '?' + params.toString(), {
                    headers: getGitHeaders()
                });
                const data = await response.json();
                
                const container = document.getElementById('repoChecklist');
                container.innerHTML = ''; // clear

                if (data.repositories && data.repositories.length > 0) {
                    data.repositories.forEach(repo => {
                        container.appendChild(createCheckbox(repo, true));
                    });
                    
                    if (!groupInput && data.group) {
                         document.getElementById('groupName').value = data.group;
                    }
                } else {
                    container.innerHTML = '<div class="text-muted text-center mt-5">No repositories found matching criteria.</div>';
                }
             } catch (err) {
                 alert('Error fetching repositories: ' + err.message);
                 console.error(err);
             } finally {
                 btn.classList.remove('disabled');
                 btn.textContent = originalText;
             }
        });

                // Fetch Branches Logic
        document.getElementById('fetchBranchesBtn').addEventListener('click', async () => {
             // Find first available repo to check branches against
             const repos = Array.from(document.querySelectorAll('.repo-checkbox'));
             if (repos.length === 0) {
                 alert("Please fetch repositories first.");
                 return;
             }
             // Prefer first checked, otherwise first listed
             let sampleRepo = repos.find(cb => cb.checked)?.value || repos[0].value;
             
             const btn = document.getElementById('fetchBranchesBtn');
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
             btn.classList.add('disabled');
             
             try {
                const response = await fetch('/api/download/branches?repo=' + encodeURIComponent(sampleRepo), {
                    headers: getGitHeaders()
                });
                const branches = await response.json();
                
                const container = document.getElementById('branchChecklist');
                container.innerHTML = '';
                
                if (branches && branches.length > 0) {
                    branches.forEach(br => {
                        const div = document.createElement('div');
                        div.className = 'form-check form-check-sm';
                        div.innerHTML = `
                            <input class="form-check-input branch-checkbox" type="checkbox" value="${br}" id="br_${br.replace(/\W/g,'_')}">
                            <label class="form-check-label small" for="br_${br.replace(/\W/g,'_')}">${br}</label>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<div class="text-muted small text-center mt-3">No branches found.</div>';
                }
             } catch (err) {
                 alert('Error fetching branches: ' + err.message);
             } finally {
                 btn.innerHTML = 'Fetch Branches';
                 btn.classList.remove('disabled');
             }
        });

        document.getElementById('downloadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Gather Selected Repos
            const selectedRepos = Array.from(document.querySelectorAll('.repo-checkbox:checked')).map(cb => cb.value);
            
            if(selectedRepos.length === 0) {
                alert("Please select at least one repository.");
                return;
            }

            const btn = document.getElementById('downloadBtn');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Downloading...';
            document.getElementById('resultsSection').classList.add('d-none');

            // Gather Branches
            const selectedBranches = Array.from(document.querySelectorAll('.branch-checkbox:checked')).map(cb => cb.value);
            const manualBranch = document.getElementById('branchManualInput').value.trim();
            if(manualBranch) {
                manualBranch.split(',').forEach(b => {
                    if(b.trim()) selectedBranches.push(b.trim());
                });
            }

            const payload = {
                repos: selectedRepos, 
                outputDir: document.getElementById('targetDir').value,
                branches: selectedBranches // Sent as array
            };

            try {
                const triggerDownload = async (doOverwrite = false) => {
                    const finalPayload = { ...payload };
                    if (doOverwrite) finalPayload.overwrite = true;
                    
                    const response = await fetch('/api/download', {
                        method: 'POST',
                        headers: getGitHeaders(),
                        body: JSON.stringify(finalPayload)
                    });
                    return await response.json();
                };

                let result = await triggerDownload(false);

                // Check for Conflicts
                if (result.details) {
                    const conflicts = result.details.filter(d => d.status === 'FAILURE' && d.error && d.error.includes('already exists'));
                    if (conflicts.length > 0) {
                         const confirmOverwrite = confirm(`Found ${conflicts.length} repositories that already exist in the target directory.\n\nDo you want to overwrite them?\n(This will delete existing folders)`);
                         if (confirmOverwrite) {
                             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Overwriting...';
                             result = await triggerDownload(true);
                         }
                    }
                }
                
                renderResults(result);

            } catch (err) {
                alert('Error: ' + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        function renderResults(result) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';
            
            const summary = document.getElementById('statusSummary');
            summary.innerHTML = `<strong>Download Complete!</strong> Successfully downloaded ${result.successful} out of ${result.total} items to: <code>${result.downloadDir}</code>`;

            if (result.details) {
                result.details.forEach(item => {
                    const tr = document.createElement('tr');
                    const badgeClass = item.status === 'SUCCESS' ? 'bg-success' : 'bg-danger';
                    
                    tr.innerHTML = `
                        <td>${item.repo}</td>
                        <td class="fw-bold text-primary">${item.branch}</td>
                        <td><span class="badge ${badgeClass}">${item.status}</span></td>
                        <td class="small text-truncate" style="max-width: 300px;">
                            ${item.status === 'SUCCESS' ? item.path : '<span class="text-danger">' + item.error + '</span>'}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            document.getElementById('resultsSection').classList.remove('d-none');
        }
    </script>

</body>
</html>

<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MuleGuard - Validation Tool</title>
    <style>

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            position: relative;
        }

        /* Progress Bar Styles */
        .progress-container {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 4px;
            margin-top: 20px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #663399;
            width: 0%;
            transition: width 0.4s ease;
        }
        
        .progress-bar.indeterminate {
            width: 100%;
            background: linear-gradient(45deg, #663399 25%, #7a4bb8 25%, #7a4bb8 50%, #663399 50%, #663399 75%, #7a4bb8 75%, #7a4bb8);
            background-size: 40px 40px;
            animation: progress-stripe 1s linear infinite;
        }
        
        @keyframes progress-stripe {
            0% { background-position: 40px 0; }
            100% { background-position: 0 0; }
        }

        /* Header & Container (Keep existing) */
        /* Header & Container - Restored to Original 'Boxed' Style */
        .container {
            background: white;
            border: 5px solid #663399; /* The solid purple line requested */
            border-radius: 8px;
            padding: 40px;
            margin: 50px auto;
            max-width: 800px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .logo {
            text-align: center;
            margin-bottom: 20px;
            /* Reset flex properties from previous unwanted edit */
            display: block;
            width: auto;
            height: auto;
            background-color: transparent; 
        }

        .logo img {
            height: 80px;
            margin-bottom: 10px;
            max-width: none;
            max-height: none;
        }

        h1 {
            color: #663399;
            margin: 10px 0;
            text-align: center;
            font-size: 32px; /* Restored larger size */
        }
        
        .subtitle {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
        }
        
        /* Form Elements */
        .card { background: white; border-radius: 8px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #663399; }
        .section-title { font-size: 18px; margin-bottom: 20px; color: #663399; font-weight: 600; display: flex; align-items: center; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input[type="text"], input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        .btn-primary { background-color: #663399; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; transition: background 0.2s; }
        .btn-primary:hover { background-color: #552b80; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        
        .radio-group { display: flex; gap: 20px; margin-bottom: 20px; }
        .radio-option { display: flex; align-items: center; cursor: pointer; padding: 10px 15px; border: 1px solid #ddd; border-radius: 4px; transition: all 0.2s; }
        .radio-option:hover { background-color: #f9f4ff; border-color: #d1b3ff; }
        .radio-option.selected { background-color: #f3e5ff; border-color: #663399; color: #663399; font-weight: 500; }
        .radio-input { margin-right: 10px; }
        
        .helper-text { font-size: 12px; color: #666; margin-top: 5px; }
        .badge-coming-soon { background: #eee; color: #666; font-size: 10px; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
        
        /* Utility Classes */
        .hidden { display: none !important; }
        
        /* Compatibility Mappings */
        .optional-section, .mode-selector { 
            background: #f0f0ff; 
            border-radius: 4px; 
            padding: 20px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            margin-bottom: 20px; 
            border-left: 5px solid #663399; 
            border-top: none;
        }
        
        button { 
            background-color: #663399; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            font-weight: 600; 
            width: 100%; 
            transition: background 0.2s; 
            margin-top: 10px;
        }
        button:hover { background-color: #552b80; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        
        /* Nav Buttons */
        .nav-button {
            background: #663399;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
            font-size: 14px;
            display: inline-block;
            text-align: center;
        }
        .button-group { display: flex; gap: 10px; margin-top: 20px; justify-content: center; }
    </style>
</head>

<body>
    <div class="container" style="position: relative;">
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
            <a id="linkChecklist" href="checklist.html" class="nav-button" title="View all validation checklist items" style="padding: 8px 12px; font-size: 12px;">Checklist</a>
            <a id="linkRules" href="rule_guide.html" class="nav-button" title="Guide to all MuleGuard validation rules" style="padding: 8px 12px; font-size: 12px;">Rule Guide</a>
            <a id="linkHelp" href="help.html" class="nav-button" title="View help and documentation" style="padding: 8px 12px; font-size: 12px;">Help</a>
        </div>

        <div class="logo">
            <!-- Logo path will be adjusted by JS if needed -->
            <img id="logoImg" src="logo.svg" alt="MuleGuard Logo" style="height: 60px; margin-bottom: 10px;"
                 onerror="this.style.display='none'; this.parentNode.innerText='MuleGuard';">
            <h1>MuleGuard</h1>
        </div>

        <p class="subtitle">Comprehensive MuleSoft Application Validation Tool</p>

        <div class="mode-selector optional-section">
            <label>Choose Input Method:</label>
            
            <label id="localLabel">
                <input type="radio" name="mode" value="local" onchange="toggleMode()">
                &#128193; Local Folder Path
            </label>
            
            <label id="zipLabel">
                <input type="radio" name="mode" value="zip" onchange="toggleMode()">
                &#128230; Upload ZIP File
            </label>

            <label id="jarLabel">
                <input type="radio" name="mode" value="jar" onchange="toggleMode()">
                &#128218; Upload JAR/Archive
            </label>

            <label id="gitLabel" class="disabled-label" title="Coming Soon">
                <input type="radio" name="mode" value="git" disabled>
                &#128279; Git Repository (Coming Soon)
            </label>
        </div>

        <!-- Local Folder Input -->
        <div id="localInput" class="optional-section hidden">
            <label>Mule Projects Folder: 
                <a href="#" class="sample-download" onclick="downloadSample('muleapp1.zip')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Project)
                </a>
            </label>
            <input type="text" id="folderPath" placeholder="Enter folder path (e.g., C:\projects\muleapis)">
        </div>

        <!-- ZIP File Input -->
        <div id="zipInput" class="optional-section hidden">
            <label>Select ZIP File: 
                <a href="#" class="sample-download" onclick="downloadSample('muleapp1.zip')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Project)
                </a>
            </label>
            <input type="file" id="zipFile" accept=".zip">
            <small>ZIP should contain root folder with API and config folders</small>
        </div>

        <!-- JAR File Input -->
        <div id="jarInput" class="optional-section hidden">
            <label>Select Archive File:</label>
            <input type="file" id="jarFile" accept=".jar">
            <small>Supported formats: .jar (Mule App)</small>
        </div>

        <!-- Custom Rules Input -->
        <div class="optional-section">
            <label>Optional: Custom Rules File 
                <a href="#" class="sample-download" onclick="downloadSample('sample-rules.yaml')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Rules)
                </a>
            </label>
            <input type="file" id="customRules" accept=".yaml,.yml">
            <small>If not provided, default rules from MuleGuard JAR will be used</small>
        </div>

        <!-- Email Notification Options -->
        <div class="optional-section" style="margin-top: 20px;">
            <strong style="color: #663399;">&#128231; Email Notification Options</strong>

            <div style="margin-top: 15px;">
                <label style="display: block; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachReports" checked>
                    Attach validation reports (compressed folder)
                </label>

                <label id="attachInputLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachInput" checked>
                    Attach input archive file
                </label>

                <label id="attachProjectLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachProject">
                    Attach project folder (compressed)
                </label>

                <p id="adminOverrideNote"
                    style="display: none; color: #ff6600; font-size: 13px; margin-top: 15px; font-style: italic;">
                    &#9888;&#65039; Note: Administrator has overridden attachment options via server configuration.
                </p>
            </div>
        </div>

        <button id="runBtn" onclick="runValidation()">&#128640; Run MuleGuard</button>



        <div id="loading" class="hidden loading">
            <p>&#8987; Running validation...</p>
            <p>This may take a few minutes depending on the number of APIs.</p>
        </div>
    </div>

    <!-- Configuration Script -->
    <script>
        // Automatic environment detection
        const isWrapper = window.location.pathname.includes('/apiguard/');
        
        // Configuration
        const CONFIG = {
            baseUrl: isWrapper ? '/apiguard/muleguard' : '',
            apiUrl: isWrapper ? '/apiguard/muleguard/validate' : '/api/validate',
            resourceBase: isWrapper ? '/apiguard/muleguard/web' : '',
            defaultMode: isWrapper ? 'zip' : 'local'
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function () {
            // Set up links based on environment
            setupLinks();
            
            // Handle mode visibility based on environment
            if (isWrapper) {
                // Wrapper: Hide Local, Show ZIP/JAR
                const localLabel = document.getElementById('localLabel');
                if (localLabel) localLabel.style.display = 'none';
                
                // Default to ZIP
                selectMode('zip');
            } else {
                // Standalone: Show all (except Git disabled)
                // Default to Local
                selectMode('local');
            }

            // Update image sources if in standalone
            if (!isWrapper) {
                document.getElementById('logoImg').src = 'logo.svg';
            }
        });

        function setupLinks() {
            const basePath = CONFIG.resourceBase;
            const suffix = isWrapper ? '' : ''; // Standalone might serve directly from root

            document.getElementById('linkChecklist').href = basePath + '/checklist.html';
            document.getElementById('linkRules').href = basePath + '/rule_guide.html';
            document.getElementById('linkHelp').href = basePath + '/help.html';
            
            // Update session ID in links if present
            const urlParams = new URLSearchParams(window.location.search);
            const sessionId = urlParams.get('session');
            if (sessionId) updateNavLinks(sessionId);
        }

        function downloadSample(filename) {
            const url = CONFIG.resourceBase + '/' + filename;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function selectMode(modeValue) {
            const radio = document.querySelector(`input[name="mode"][value="${modeValue}"]`);
            if (radio) {
                radio.checked = true;
                toggleMode();
            }
        }

        function toggleMode() {
            const radio = document.querySelector('input[name="mode"]:checked');
            if (!radio) return;
            
            const mode = radio.value;
            
            document.getElementById('localInput').classList.toggle('hidden', mode !== 'local');
            document.getElementById('zipInput').classList.toggle('hidden', mode !== 'zip');
            document.getElementById('jarInput').classList.toggle('hidden', mode !== 'jar');
            
            // Show/hide attachment options
            if (mode === 'zip' || mode === 'jar') {
                document.getElementById('attachInputLabel').style.display = 'block';
                document.getElementById('attachProjectLabel').style.display = 'none';
            } else {
                document.getElementById('attachInputLabel').style.display = 'none';
                document.getElementById('attachProjectLabel').style.display = 'block';
            }
        }

        function updateNavLinks(sessionId) {
            document.querySelectorAll('.nav-button').forEach(link => {
                const href = link.getAttribute('href');
                if (href && href !== '#' && !href.includes('session=')) {
                    link.setAttribute('href', href + (href.includes('?') ? '&' : '?') + 'session=' + sessionId);
                }
            });
        }

        function showProgress(show, title = "Validating Project...", text = "Running comprehensive analysis...") {
            const modal = document.getElementById('progressModal');
            if (show) {
                document.getElementById('progressTitle').innerText = title;
                document.getElementById('progressText').innerText = text;
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function runValidation() {
            const radio = document.querySelector('input[name="mode"]:checked');
            if (!radio) {
                showAlert('Please select an input mode');
                return;
            }
            const mode = radio.value;
            const formData = new FormData();
            
            // Get session ID
            const sessionId = new URLSearchParams(window.location.search).get('session');
            if (sessionId) formData.append('session', sessionId);
            
            formData.append('mode', mode);

            // Validation logic based on mode
            if (mode === 'local') {
                const path = document.getElementById('folderPath').value;
                if (!path) {
                    showAlert('Please enter a folder path');
                    return;
                }
                formData.append('path', path);
                showProgress(true, "Scanning Local Project", "Analyzing files in " + path + "...");
            } else if (mode === 'zip') {
                const file = document.getElementById('zipFile').files[0];
                if (!file) {
                    showAlert('Please select a ZIP file');
                    return;
                }
                formData.append('archive', file); 
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            } else if (mode === 'jar') {
                const file = document.getElementById('jarFile').files[0];
                if (!file) {
                    showAlert('Please select a JAR/Archive file');
                    return;
                }
                formData.append('archive', file);
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            }

            // Custom rules
            const customRules = document.getElementById('customRules').files[0];
            if (customRules) {
                formData.append('customRules', customRules);
            }

            // Email options
            formData.append('attachReports', document.getElementById('attachReports').checked);
            formData.append('attachInput', document.getElementById('attachInput').checked);
            formData.append('attachProject', document.getElementById('attachProject').checked);

            // UI State
            document.getElementById('runBtn').disabled = true;

            // API Call
            fetch(CONFIG.apiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showProgress(false); // Hide progress
                document.getElementById('runBtn').disabled = false;
                
                if (data.status === 'success' || data.success === true) {
                    handleSuccess(data, mode, sessionId);
                } else {
                    showAlert('Error: ' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                showProgress(false); // Hide progress
                showAlert('Network Error: ' + error.message);
                document.getElementById('runBtn').disabled = false;
            });
        }
        
        function handleSuccess(data, mode, sessionId) {
            // Use the session ID returned from the server if the initial one was null
            const activeSessionId = data.sessionId || sessionId;

            let message = '';
            // Basic report link logic
            const reportName = data.reportFolder || 'validation-report';
            const resourceBase = CONFIG.resourceBase;
            const openReportUrl = resourceBase + '/' + reportName + '/report.html';
            
            if (mode === 'local') {
                // Escape path for string literal usage in onclick
                const safePath = data.reportPath.replace(/\\/g, '\\\\');
                
                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report generated at: <br><code>${data.reportPath}</code></p>
                    <div style="margin-top:20px;">
                        <button class="btn-primary" onclick="openLocalReportApi('${safePath}')">Open Report in Browser</button>
                    </div>
                `;
            } else {
                // ZIP/JAR mode uses the server's relative URL if available, or constructs one
                // The backend now returns 'relativeReportUrl' which is safer
                let finalUrl = openReportUrl;
                if (data.relativeReportUrl) {
                    finalUrl = CONFIG.baseUrl + '/reports/' + activeSessionId + '/' + data.relativeReportUrl;
                }

                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report has been generated.</p>
                    <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                        <button class="btn-primary" onclick="window.open('${finalUrl}', '_blank')">View Report Online</button>
                `;
                
                if (data.reportZip) {
                    // Start download using session ID
                    message += `<button class="btn-primary" style="background:#555;" onclick="window.location.href='${CONFIG.baseUrl}/download?session=${activeSessionId}'">Download Report ZIP</button>`;
                } else {
                     message += `<button class="btn-primary" style="background:#aa5; cursor:not-allowed;" disabled>Download ZIP Not Available</button>`;
                }
                
                message += `</div>`;
            }

            showAlert(message, true);
        }

        function openLocalReportApi(path) {
            // Use the backend API to open the file on the host OS
            const formData = new URLSearchParams();
            formData.append('path', path);
            
            // Handle context path if in wrapper
            const apiBase = CONFIG.baseUrl || ''; 
            
            fetch(apiBase + '/api/open', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if(!d.success) alert('Failed to open report automatically. Please open the file manually: ' + path);
            })
            .catch(e => alert('Error requesting to open report: ' + e.message));
        }

        function showAlert(message, isHtml = false) {
            const modalBody = document.getElementById('modalMessage');
            if (isHtml) {
                modalBody.innerHTML = message;
            } else {
                modalBody.textContent = message;
            }
            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                /* Optional toast or alert, or just let user know via tooltip */
                const btn = document.querySelector('button[onclick^="copyToClipboard"]');
                if(btn) {
                    const originalText = btn.innerText;
                    btn.innerText = "Copied!";
                    setTimeout(() => btn.innerText = originalText, 1500);
                }
            });
        }
    </script>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="progressTitle" style="color: #333; margin-bottom: 10px;">Validating Project...</h3>
            <div class="progress-container">
                <div class="progress-bar indeterminate"></div>
            </div>
            <p id="progressText" style="color: #666; margin-top: 15px; font-size: 14px;">Running comprehensive analysis. This may take a moment...</p>
        </div>
    </div>
    
    <!-- Message Modal (Reuses modal-content style) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: #663399; margin-bottom: 15px;">MuleGuard Notification</h3>
            <div id="modalMessage" style="margin-bottom: 20px; color: #333;"></div>
            <button onclick="closeModal()" style="padding: 8px 20px; background: #663399; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>

</body>
</html>

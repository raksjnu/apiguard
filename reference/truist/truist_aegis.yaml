# =============================================================================
# Aegis Rules Configuration - Truist
# Targeted for Technical Checklist Compliance
# =============================================================================

# =============================================================================
# RULE TYPES QUICK REFERENCE
# =============================================================================
# 
# UNIVERSAL RULE TYPES (Apply to ANY text-based project)
# -------------------------------------------------------------------------
# 1.  GENERIC_TOKEN_SEARCH_REQUIRED      - Ensures required tokens exist in files
# 2.  GENERIC_TOKEN_SEARCH_FORBIDDEN     - Ensures forbidden tokens do NOT exist in files
# 3.  XML_XPATH_EXISTS                   - Validates required XPath expressions exist in XML
# 4.  XML_XPATH_NOT_EXISTS               - Validates forbidden XPath expressions do NOT exist in XML
# 5.  XML_ATTRIBUTE_EXISTS               - Ensures required XML attributes exist with correct values
# 6.  XML_ATTRIBUTE_NOT_EXISTS           - Ensures forbidden XML attributes do NOT exist
# 7.  XML_ELEMENT_CONTENT_REQUIRED       - Validates required content exists within XML elements
# 8.  XML_ELEMENT_CONTENT_FORBIDDEN      - Validates forbidden content does NOT exist within XML elements
# 9.  POM_VALIDATION_REQUIRED            - Ensures required POM elements exist (parent, dependencies, plugins, properties)
# 10. POM_VALIDATION_FORBIDDEN           - Ensures forbidden POM elements do NOT exist (dependencies, plugins)
# 11. JSON_VALIDATION_REQUIRED           - Validates required JSON elements exist (e.g., mule-artifact.json, package.json)
# 12. JSON_VALIDATION_FORBIDDEN          - Validates forbidden JSON elements do NOT exist
#
# CONFIG RULE TYPES (Standard Types - Apply to Configuration Projects)
# -------------------------------------------------------------------------
# 1.  MANDATORY_SUBSTRING_CHECK          - Ensures required substrings exist in config files (.properties, .policy)
# 2.  MANDATORY_PROPERTY_VALUE_CHECK     - Validates required properties exist with correct values
# 3.  OPTIONAL_PROPERTY_VALUE_CHECK      - Validates property values IF the property exists
# 4.  GENERIC_TOKEN_SEARCH               - Advanced token search with REGEX support and environment filtering
#
# CONDITIONAL STANDARDS (Universal "If-Then" Engine)
# -------------------------------------------------------------------------
# 1.  CONDITIONAL_CHECK       - Logic engine. Runs 'onSuccess' only if 'preconditions' are met.
# 
# COMMON TRIGGERS (Can be used in 'preconditions'):
# - PROJECT_CONTEXT           - Trigger by Project Name patterns (e.g., contains '-exp-').
# - FILE_EXISTS               - Trigger by file presence (e.g., 'secure-properties.xml').
# - XML_XPATH_EXISTS          - Trigger by XML content (e.g., check for DB/MQ connectors).
# - MANDATORY_PROPERTY_VALUE_CHECK - Trigger by property existence or specific value.
# 
# NOTE: *ANY* check type above can be used as a trigger for the conditional engine!
#
# =============================================================================
# MESSAGE TOKENS
# =============================================================================
# You can use the following tokens in successMessage and errorMessage:
# - {RULE_ID}         : The ID of the rule being executed.
# - {DEFAULT_MESSAGE} : The technical details of the check result (e.g. valid/invalid values).
# - {CHECKED_FILES}   : The list of files processed by the check.
# - {FOUND_ITEMS}     : The specific forbidden items found (e.g. 'toApplicationCode', forbidden keys).
# =============================================================================

config:
  environments:
  - SBX
  - ITE
  - PREP
  - PROD
  # Identifies valid projects and configuration locations
  projectIdentification:
    # Locates the folder containing environment-specific property files
    configFolder:
      namePattern: .*_config.*  # Regex to match config folder name
    
    # Defines criteria to identify a valid project root for scanning
    targetProject:
      matchMode: ALL  # ALL: Must contain all markers (if multiple logic applies), usually behaves as 'contains at least one of' for list
      markerFiles:    # Existence of ANY of these files marks the folder as a project
      - pom.xml
      - mule-artifact.json

    # Directories to exclude from scanning to improve performance and reduce noise
    ignoredFolders:
      exactNames:     # Exact folder names to skip
      - Aegis-reports
      - rakesh
      - target
      - bin
      - build
      - .git
      - .idea
      - .vscode
      - node_modules
      - __MACOSX
      prefixes:       # Folder names starting with these prefixes to skip
      - .
      - Aegis-reports
      
rules:

  # ===========================================================================
  # SECTION 1: PROJECT STRUCTURE & METADATA
  # ===========================================================================

  # BANK-001: mule-artifact.json validation
  - id: "BANK-001"
    name: "Validate mule-artifact.json"
    description: "Enforces minMuleVersion 4.9.7, Java 17, and secureProperties."
    enabled: true
    severity: HIGH
    successMessage: "✓ mule-artifact.json is valid (Version: 4.9.7+, Java: 17) {DEFAULT_MESSAGE} \n {CHECKED_FILES}"
    errorMessage: "✗ mule-artifact.json failed validation. Check minMuleVersion (4.9.7+), javaSpecificationVersions (17), or secureProperties. {DEFAULT_MESSAGE} \n {CHECKED_FILES}"
    checks:
    - type: JSON_VALIDATION_REQUIRED
      params:
        filePattern: mule-artifact.json
        minVersions:
          minMuleVersion: 4.9.7
        requiredFields:
          javaSpecificationVersions: "17"
        requiredElements:
        - secureProperties

  # BANK-023: Parent POM
  - id: "BANK-023"
    name: "Validate Parent POM Version"
    description: "Ensures Parent POM is com.truist.eapi:MuleParentPom >= 3.0.0"
    enabled: true
    severity: HIGH
    successMessage: "✓ Parent POM version is valid (3.0.0+) {DEFAULT_MESSAGE} \n {CORE_DETAILS}"
    errorMessage: "✗ Parent POM version is invalid. Must be com.truist.eapi:MuleParentPom >= 3.0.0 {DEFAULT_MESSAGE} \n {CORE_DETAILS}"
    checks:
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PARENT
        parent:
          groupId: com.truist.eapi
          artifactId: MuleParentPom
          minVersion: 3.0.0

  # BANK-024: POM Properties
  - id: "BANK-024"
    name: "Validate POM Properties"
    description: "Ensures critical properties satisfy minimum versions."
    enabled: true
    severity: HIGH
    successMessage: "✓ Critical POM properties (runtime, plugin, cicd,munit) are valid {DEFAULT_MESSAGE}"
    errorMessage: "✗ Critical POM properties check failed. Ensure mule.maven.plugin.version>=4.6.0, app.runtime>=4.9.LTS, cicd.mule.version>=4.9.LTS, munit.version>=3.5.0 {DEFAULT_MESSAGE}"
    checks:
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: PROPERTIES
        properties:
        - name: mule.maven.plugin.version
          minVersion: 4.6.0
        - name: app.runtime
          minVersion: "4.9.LTS"
        - name: cicd.mule.version
          minVersion: "4.9.LTS"
        - name: munit.version
          minVersion: "3.5.0"

  # ===========================================================================
  # SECTION 2: CODE QUALITY & SECURITY (XML/JAVA)
  # ===========================================================================

  # BANK-002 & BANK-003: Logger Attributes
  - id: "BANK-002"
    name: "Forbid Legacy Logger Attributes"
    description: "Ensures toApplicationCode and fromApplicationCode are NOT used."
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy logger attributes found {DEFAULT_MESSAGE}; items checked - {FOUND_ITEMS} ; Checked Files: {CHECKED_FILES}"
    errorMessage: "✗ Forbidden attribute found in Logger: {FOUND_ITEMS}; {DEFAULT_MESSAGE} ; Checked Files: {CHECKED_FILES}"
    checks:
    - type: XML_ATTRIBUTE_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        elements: ["set-payload"]
        forbiddenAttributes: ["toApplicationCode", "fromApplicationCode"]

  # BANK-004: jce-encrypt
  - id: "BANK-004"
    name: "Forbid jce-encrypt Token"
    description: "Detects usage of legacy jce-encrypt."
    enabled: true
    severity: HIGH
    successMessage: "✓ No jce-encrypt tokens found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Found forbidden token 'jce-encrypt'. Use EncUtil. {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/mule/*.xml"]
        tokens: ["jce-encrypt"]
        matchMode: SUBSTRING

  # BANK-005: SOAP Version
  - id: "BANK-005"
    name: "Validate SOAP Version"
    enabled: true
    severity: HIGH
    successMessage: "✓ SOAP configuration uses valid version (1.1 or 1.2) {DEFAULT_MESSAGE}"
    errorMessage: "✗ Invalid SOAP version detected. Must be SOAP_11 or SOAP_12. {DEFAULT_MESSAGE}"
    checks:
    - type: XML_ATTRIBUTE_EXISTS
      params:
        filePatterns: ["src/main/mule/*-config.xml"]
        elementAttributeSets:
        - element: apikit-soap:config
          attributes: {soapVersion: "SOAP_11"}
        - element: apikit-soap:config
          attributes: {soapVersion: "SOAP_12"}

  # BANK-008: Legacy Auth
  - id: "BANK-008"
    name: "Forbid Legacy Auth Policies"
    description: "Detects old AAA or Basic Auth policies."
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy Auth policies found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Legacy Auth policy detected (Truist-AAA or BasicAuth). Upgrade to CompositeAuth. {DEFAULT_MESSAGE}"
    checks:
    - type: XML_XPATH_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        xpathExpressions:
        - xpath: "//*[contains(local-name(), 'Truist-AAA-SOAP')]"
          failureMessage: "Truist-AAA-SOAP found"
        - xpath: "//*[contains(local-name(), 'Truist-AAA-HTTP')]"
          failureMessage: "Truist-AAA-HTTP found"
        - xpath: "//*[contains(local-name(), 'TruistBasicAuthnPolicy')]"
          failureMessage: "TruistBasicAuthnPolicy found"

  # BANK-015: DB2 DVIPA
  - id: "BANK-015"
    name: "DB2 DVIPA Migration Check"
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy DB2 VIPs found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Legacy DB2 VIP detected. Migrate to DVIPA (dsndb0e/h). {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/*.properties"]
        tokens: 
        - "wil-db2contstvip\\.bbtnet\\.com:50000"
        - "db2contppvip\\.truist-tst\\.com:50000"
        matchMode: REGEX

  # BANK-019 & 020: DLP Removal
  - id: "BANK-019"
    name: "Forbid DLP Logic"
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP logic found\n{DEFAULT_MESSAGE}"
    errorMessage: "✗ DLP logic detected in HTTP Proxy.\n{DEFAULT_MESSAGE}"
    checks:
    - type: XML_XPATH_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/http-proxy.xml"]
        xpathExpressions:
        - xpath: "//choice/when[contains(@expression, 'north.bound.dlp.flag')]"
          failureMessage: "DLP flag choice found"

  - id: "BANK-020"
    name: "Forbid DLP Properties"
    enabled: true
    severity: HIGH
    successMessage: "✓ No DLP properties found {DEFAULT_MESSAGE}"
    errorMessage: "✗ DLP property detected (dlp.flag or requestqueue). {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/resources/*.properties"]
        tokens: ["north.bound.dlp.flag", "south.bound.dlp.flag", "wmq.dlp.requestqueue"]

  # BANK-021: SQL Security
  - id: "BANK-021"
    name: "Enforce SQL Security"
    enabled: true
    severity: HIGH
    successMessage: "✓ SQL Server connections are non-encrypted {DEFAULT_MESSAGE}"
    errorMessage: "✗ SQL Server URL missing ';encrypt=false;trustServerCertificate=false' {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["**/*.properties"]
        tokens: ["jdbc:sqlserver(?!.*encrypt=false)(?!.*trustServerCertificate=false).*"]
        matchMode: REGEX

  # BANK-031: EncUtil Replacement
  - id: "BANK-031"
    name: "Enforce EncUtil Logic"
    enabled: true
    severity: HIGH
    successMessage: "✓ EncUtil logic is present and legacy crypto is gone {DEFAULT_MESSAGE}"
    errorMessage: "✗ Failed EncUtil check: Either legacy 'jce-encrypt-pbe' found or new 'EncUtil::encryptJcePbe' missing. {DEFAULT_MESSAGE}"
    checks:
    - type: XML_XPATH_NOT_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        xpathExpressions:
        - xpath: "//*[contains(local-name(), 'jce-encrypt-pbe')]"
          failureMessage: "Legacy jce-encrypt-pbe found"
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='set-variable' and contains(@value, 'EncUtil::encryptJcePbe')]"
          failureMessage: "EncUtil::encryptJcePbe usage missing"

  # BANK-032: ApiMethod
  - id: "BANK-032"
    name: "Verify API Method Logic"
    enabled: true
    severity: HIGH
    successMessage: "✓ apimethod variable logic is correct {DEFAULT_MESSAGE}"
    errorMessage: "✗ apimethod variable logic missing encryptedRequestPath. {DEFAULT_MESSAGE}"
    checks:
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//set-variable[@variableName='apimethod' and contains(@value, 'vars.encryptedRequestPath')]"

  # BANK-036: Autodiscovery
  - id: "BANK-036"
    name: "Require API Autodiscovery"
    enabled: true
    severity: HIGH
    successMessage: "✓ Autodiscovery element found {DEFAULT_MESSAGE}"
    errorMessage: "✗ API Autodiscovery element missing in global-config. {DEFAULT_MESSAGE}"
    checks:
    - type: XML_XPATH_EXISTS
      params:
        filePatterns: ["src/main/mule/*.xml"]
        matchMode: ANY_FILE
        xpathExpressions:
        - xpath: "//*[local-name()='autodiscovery']"

  # BANK-040: Java 17 Errors
  - id: "BANK-040"
    name: "Java 17 Error Migration"
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy error syntax found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Legacy Java 8 error syntax detected (error.muleMessage, etc.). {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["src/main/**/*.xml", "src/main/**/*.dwl"]
        tokens: 
        - "error\\.muleMessage"
        - "error\\.exception\\.cause(\\.detailMessage|\\.Message)?"
        matchMode: REGEX

  # ===========================================================================
  # SECTION 3: DEPENDENCIES & PLUGINS
  # ===========================================================================

  # BANK-026: Forbidden Plugins
  - id: "BANK-026"
    name: "Forbid Restricted Plugins"
    enabled: true
    severity: HIGH
    successMessage: "✓ No restricted plugins found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Forbidden plugin found (maven-clean, maven-compiler, or munit-maven). {DEFAULT_MESSAGE}"
    checks:
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: PLUGINS
        forbiddenPlugins:
        - groupId: org.apache.maven.plugins
          artifactId: maven-clean-plugin
        - groupId: org.apache.maven.plugins
          artifactId: maven-compiler-plugin
        - groupId: com.mulesoft.munit.tools
          artifactId: munit-maven-plugin

  # BANK-027: Forbidden Dependencies
  - id: "BANK-027"
    name: "Forbid Runtime Dependencies"
    enabled: true
    severity: HIGH
    successMessage: "✓ No runtime dependencies found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Forbidden dependency found (mule-core-ee or spring-config-ee). {DEFAULT_MESSAGE}"
    checks:
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: DEPENDENCIES
        forbiddenDependencies:
        - groupId: com.mulesoft.mule.runtime
          artifactId: mule-core-ee
        - groupId: com.mulesoft.mule.runtime.modules
          artifactId: mule-module-spring-config-ee

  # BANK-029: Required Dependency
  - id: "BANK-029"
    name: "Require eapimuleutilities"
    enabled: true
    severity: HIGH
    successMessage: "✓ eapimuleutilities dependency found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Missing required dependency: eapimuleutilities. {DEFAULT_MESSAGE}"
    checks:
    - type: POM_VALIDATION_REQUIRED
      params:
        validationType: DEPENDENCIES
        dependencies:
        - groupId: com.truist.eapi.crypto
          artifactId: eapimuleutilities

  # BANK-028 & 038: Shared Libs & Legacy Deps
  - id: "BANK-028"
    name: "Forbid Shared Libraries"
    enabled: true
    severity: HIGH
    successMessage: "✓ No shared libraries found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Forbidden shared library found (spring-security). {DEFAULT_MESSAGE}"
    checks:
    - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
      params:
        filePatterns: ["pom.xml"]
        tokens: ["spring-security-ldap", "spring-security-web"]

  - id: "BANK-038"
    name: "Legacy Dependency Upgrade"
    enabled: true
    severity: HIGH
    successMessage: "✓ No legacy dependencies (javax.mail, ojdbc8) found {DEFAULT_MESSAGE}"
    errorMessage: "✗ Legacy dependency detected. Upgrade required. {DEFAULT_MESSAGE}"
    checks:
    - type: POM_VALIDATION_FORBIDDEN
      params:
        validationType: DEPENDENCIES
        forbiddenDependencies:
        - groupId: javax.mail
          artifactId: mail
        - groupId: com.oracle.database.jdbc
          artifactId: ojdbc8

  # ===========================================================================
  # SECTION 4: POLICY CONFIGURATION (YAML)
  # ===========================================================================

  # BANK-006: Header Injection
  - id: "BANK-006"
    name: "Header Injection Policy (WARN)"
    enabled: true
    severity: HIGH
    successMessage: "✓ Header Injection policy configured correctly (WARN) {DEFAULT_MESSAGE}"
    errorMessage: "✗ Header Injection policy values must be 'WARN'. {DEFAULT_MESSAGE}"
    checks:
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        fileExtensions: [.policy, .yaml]
        environments: ['ALL']
        properties:
        - name: headerinjection.policy.inboundheadermap.x-tfc-request-out
          values: ['WARN']
        - name: headerinjection.policy.inboundheadermap.x-tfc-response-in
          values: ['WARN']

  # BANK-109: Policy Versions
  - id: "BANK-109"
    name: "Enforce Policy Versions"
    description: "Validates all Truist policy versions."
    enabled: true
    severity: HIGH
    successMessage: "✓ All policy versions are correct {DEFAULT_MESSAGE}"
    errorMessage: "✗ Policy version mismatch found (Check report for details). {DEFAULT_MESSAGE}"
    checks:
    - type: MANDATORY_PROPERTY_VALUE_CHECK
      params:
        fileExtensions: [.policy, .yaml]
        environments: ['ALL']
        properties:
        - name: truist.compositeauthn.policy.version
          values: ['3.0.0']
        - name: truist.authz.policy.version
          values: ['3.0.0']
        - name: noname.policy.version
          values: ['5.1.0']
        - name: ratelimit.policy.version
          values: ['1.4.1']
        - name: headerinjection.policy.version
          values: ['1.3.2']
        - name: headerremoval.policy.version
          values: ['1.1.2']
        - name: truist.wssencdec.policy.version
          values: ['3.0.0']
        - name: truist.jsonencdec.policy.version
          values: ['3.0.0']

  # BANK-022: MQ Cipher Suite (Conditional)
  - id: "BANK-022"
    name: "Validate MQ Cipher Suite"
    enabled: true
    severity: HIGH
    successMessage: "✓ MQ Cipher Suite is correct (or not applicable) {DEFAULT_MESSAGE}"
    errorMessage: "✗ MQ Cipher Suite is incorrect. Must be TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384. {DEFAULT_MESSAGE}"
    checks:
    - type: CONDITIONAL_CHECK
      params:
        preconditions:
        - type: GENERIC_TOKEN_SEARCH_REQUIRED
          params:
            filePatterns: ["src/main/mule/*.xml"]
            tokens: ["ibm-mq:config"]
            matchMode: SUBSTRING
        onSuccess:
        - type: GENERIC_TOKEN_SEARCH_FORBIDDEN
          params:
            filePatterns: ["src/main/resources/**/*.properties"]
            tokens: ["ibm\\.mq\\.cipherSuite\\s*=(?!\\s*TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384).*"]
            matchMode: REGEX

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Download - GitAnalyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/css/styles.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <div class="raks-frame">
        <!-- Header -->
        <nav class="navbar navbar-expand-lg navbar-light brand-header mb-0 flex-shrink-0">
            <div class="container-fluid position-relative">
                <a class="navbar-brand d-flex align-items-center" href="index.html">
                    <img src="assets/images/logo.png" alt="Logo" class="d-inline-block align-text-top me-2" height="40">
                    ApiGuard Portal - GitAnalyzer
                </a>
                
                <!-- Centered Title -->
                <div class="position-absolute start-50 translate-middle-x d-none d-lg-block">
                    <h5 class="fw-bold text-purple mb-0">Bulk Download</h5>
                </div>

                <div class="d-flex ms-auto">
                    <a href="guide.html" class="btn btn-purple me-2 d-flex align-items-center" target="_blank">
                        <span class="me-2">ðŸ“˜</span> Guide / Help
                    </a>
                    <a href="index.html" class="btn btn-outline-light ghost-btn">Dashboard</a>
                </div>
            </div>
        </nav>

        <!-- Split Layout -->
        <div class="split-container">
            <!-- Left Panel: Configuration -->
            <div class="split-left" id="leftPanel">
                
                <h5 class="mb-3 fw-bold text-purple pt-2">Bulk Configuration</h5>
                <form id="downloadForm">
                    <!-- Read-Only Connection Status -->
                <div class="connection-card mb-3" id="gitConnectionCard" style="padding: 15px;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="min-width: 0;"> <!-- prevent flex overflow -->
                             <span class="small fw-bold text-uppercase opacity-75 d-block text-truncate" style="letter-spacing: 0.5px; font-size: 0.7rem;">Git Connection</span>
                             <span class="small fw-bold text-purple" id="currentProviderDisplay">...</span>
                        </div>
                        <div class="d-flex align-items-center gap-2 flex-shrink-0">
                            <span class="status-pulse active"></span> 
                            <span class="small fw-bold text-success" style="font-size: 0.75rem;">Connected</span>
                             <a href="index.html" class="btn btn-sm btn-outline-secondary p-0 px-1 border-0" data-bs-toggle="tooltip" title="Manage on Dashboard">
                                 <i class="bi bi-gear"></i>
                             </a>
                        </div>
                    </div>
                </div>
                    <div class="sub-frame mb-3">
                         <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">1. Discovery Criteria</h6>
                         <div class="mb-3">
                            <label class="form-label small fw-bold">Git Group / Organization</label>
                            <input type="text" class="form-control form-control-sm" id="groupName" placeholder="e.g. raks-group">
                        </div>
                        <div class="mb-3">
                             <label class="form-label small fw-bold d-flex align-items-center">
                                 Filter (Regex)
                                 <span class="ms-1" data-bs-toggle="tooltip" data-bs-html="true" title="Regex Examples:<br><code>.*service.*</code><br><code>^api-.*</code><br><code>(?!.*test).*</code> (exclude test)">
                                     <i class="bi bi-info-circle text-muted" style="cursor:help;"></i>
                                 </span>
                             </label>
                             <div class="input-group input-group-sm">
                                <input type="text" class="form-control" id="filterPattern" placeholder="e.g. .*service.*">
                                <button type="button" class="btn btn-sub-action" id="fetchGroupBtn">Fetch Repositories</button>
                             </div>
                        </div>
                    </div>
                    
                    <!-- (Rest of Form remains) -->
                    <div class="sub-frame mb-3">
                        <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">2. Manual Addition</h6>
                         <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="manualRepoInput" placeholder="group/project">
                            <button class="btn btn-sub-action" type="button" id="addManualBtn">Add</button>
                        </div>
                    </div>

                    <div class="sub-frame mb-3">
                         <h6 class="text-purple fw-bold mb-3 border-bottom pb-2">3. Options</h6>
                          <div class="mb-2">
                             <label class="form-label small fw-bold">Output Directory (Optional)</label>
                             <input type="text" class="form-control form-control-sm" id="targetDir" placeholder="e.g. C:\MyDownloads">
                          </div>
                           <label class="form-label small fw-bold">Branch Selection (Optional)</label>
                          <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="branchManualInput" placeholder="Branch (e.g. master)">
                            <button class="btn btn-sub-action" type="button" id="fetchBranchesBtnLeft">Fetch Branches</button>
                        </div>
                        <div class="form-text x-small">Click Fetch to see available branches for (checked) repos.</div>
                        <div id="branchChecklist" class="mt-2 text-start d-none border rounded p-2 bg-light"></div> 
                        
                        <div class="form-check form-switch small mt-3 mb-1">
                            <input class="form-check-input" type="checkbox" id="overwriteCheckbox">
                            <label class="form-check-label fw-bold" for="overwriteCheckbox">Overwrite Existing Folders</label>
                             <div class="form-text x-small text-danger" style="font-size: 0.65rem;">Warning: Will delete existing repo folders.</div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-purple text-white w-100 py-2 shadow-sm" id="downloadBtn">
                        <i class="bi bi-download me-2"></i> Download Selected
                    </button>
                </form>
            </div>

            <!-- Resizer -->
            <div class="resizer" id="dragMe"></div>

            <!-- Right Panel: Results -->
            <div class="split-right" id="rightPanel">
                
                <h5 class="text-purple fw-bold mb-3">Repositories to Download</h5>
                
                <div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded border shadow-sm" style="border-left: 4px solid #663399 !important;">
                    <div class="form-check m-0">
                        <small>
                            <a href="#" id="selectAllBtn" class="text-decoration-none fw-bold me-2 text-purple">Select All</a>
                            <span class="text-muted">|</span>
                            <a href="#" id="deselectAllBtn" class="text-decoration-none ms-2 text-purple">Deselect All</a>
                        </small>
                    </div>
                     <button class="btn btn-sm btn-sub-action" type="button" id="fetchBranchesBtn">
                        <i class="bi bi-git me-1"></i> Fetch Branches
                    </button>
                </div>

                <div class="card shadow-sm border-0 mb-4" style="border-left: 4px solid #663399 !important; min-height: 200px;">
                    <div class="card-body p-0">
                         <div id="repoChecklist" class="p-3" style="max-height: 350px; overflow-y: auto;">
                            <!-- Checkboxes injected here -->
                            <div class="text-muted text-center mt-5">
                                <i class="bi bi-cloud-download display-4 opacity-25"></i>
                                <p class="mt-2 text-muted small">No repositories fetched yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- New Results Card Style -->
                <div id="resultsSection" class="d-none animate-fade-in">
                    <div class="card shadow-sm border-0 mb-4" style="border-left: 4px solid #663399 !important;">
                         <div class="card-header bg-white border-bottom-0 pt-3 pb-2">
                             <div class="d-flex justify-content-between align-items-center">
                                <h6 class="text-purple fw-bold m-0">Download Results</h6>
                                <span id="statusTime" class="small text-muted font-monospace"></span>
                             </div>
                         </div>
                         <div class="card-body pt-0">
                             <div id="statusSummary" class="mb-3"></div>
                             <div class="table-responsive">
                                 <table class="table table-sm table-hover align-middle">
                                     <tbody id="resultsTableBody">
                                         <!-- Result Items -->
                                     </tbody>
                                 </table>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Footer -->
        <footer class="raks-footer text-center mt-auto flex-shrink-0">
            <div class="container" id="footerText">
                &copy; 2018 RAKS - Enterprise API Solution Suite - ApiGuard
            </div>
        </footer>
    </div>
    
    <script>
        // --- Resizer Logic ---
        const resizer = document.getElementById('dragMe');
        const leftPanel = document.getElementById('leftPanel');
        let x = 0;
        let leftWidth = 0;

        const mouseDownHandler = function (e) {
            x = e.clientX;
            leftWidth = leftPanel.getBoundingClientRect().width;
            resizer.classList.add('resizing');
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            document.body.style.userSelect = 'none';
        };

        const mouseMoveHandler = function (e) {
            const dx = e.clientX - x;
            const newLeftWidth = leftWidth + dx;
            if (newLeftWidth > 250 && newLeftWidth < 800) {
                 leftPanel.style.width = `${newLeftWidth}px`;
            }
        };

        const mouseUpHandler = function () {
            resizer.classList.remove('resizing');
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            document.body.style.removeProperty('user-select');
        };

        resizer.addEventListener('mousedown', mouseDownHandler);
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize all Bootstrap tooltips
        document.addEventListener('DOMContentLoaded', function () {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });

        // Load config (if available)
        let config = {};
        try {
            const configMeta = document.querySelector('meta[name="apiguard-config"]');
            if (configMeta && configMeta.content) {
                config = JSON.parse(decodeURIComponent(escape(atob(configMeta.content))));
            }
        } catch (e) {
            console.error("Error parsing config:", e);
        }

        if (config['ui.header.bulk']) document.querySelector('.position-absolute h5').innerText = config['ui.header.bulk'];
        });

        // --- Standardized Git Connection (Read Mode) ---
        const STORE_KEY_PROVIDER = 'git_analyzer_provider';
        const STORE_KEY_TOKEN = 'git_analyzer_token'; // Add this line
        const connectedProvider = localStorage.getItem(STORE_KEY_PROVIDER) || 'gitlab';
        const connectionCard = document.getElementById('gitConnectionCard');
        const providerDisplay = document.getElementById('currentProviderDisplay');

        if (providerDisplay) {
            const displayNames = { 'github': 'GitHub', 'gitlab': 'GitLab' };
            providerDisplay.innerText = displayNames[connectedProvider] || 'Unknown';
        }

        if (connectionCard) {
            connectionCard.classList.remove('github-theme', 'gitlab-theme');
            connectionCard.classList.add(connectedProvider + '-theme');
        }

        // Helper to get base path (works in both standalone and wrapper modes)
        function getBasePath() {
            const path = window.location.pathname;
            // If path contains /apiguard/gitanalyzer, we're in wrapper mode
            if (path.includes('/apiguard/gitanalyzer')) {
                return '/apiguard/gitanalyzer';
            }
            // Otherwise, standalone mode - no prefix
            return '';
        }
        
        // Helper to get Headers
        // Helper to get Headers
        function getGitHeaders() {
            const provider = localStorage.getItem('git_analyzer_provider') || 'gitlab';
            let token;

            if (provider === 'github') {
                token = localStorage.getItem('git_analyzer_github_token');
            } else {
                token = localStorage.getItem('git_analyzer_gitlab_token');
            }
            
            // Fallback
            if (!token) {
                 token = localStorage.getItem('git_analyzer_token');
            }

            const headers = {
                'Content-Type': 'application/json',
                'X-Git-Provider': provider
            };
            
            if (token) {
                headers['X-Git-Token'] = token;
            } else {
                console.warn("No token found for provider: " + provider);
            }
            
            return headers;
        }

        // --- Persistence Logic (Form Fields) ---
        const FIELDS_TO_PERSIST = ['groupName', 'filterPattern', 'targetDir'];
        
        FIELDS_TO_PERSIST.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                // Restore
                const val = localStorage.getItem('git_analyzer_' + id);
                if (val) el.value = val;
                
                // Save
                el.addEventListener('input', () => {
                    localStorage.setItem('git_analyzer_' + id, el.value);
                });
            }
        });

        // Restore Manual Repos
        const savedManual = localStorage.getItem('git_analyzer_manual_repos');
        if (savedManual) {
            try {
                const repos = JSON.parse(savedManual);
                const container = document.getElementById('repoChecklist');
                if (repos.length > 0 && container.innerText.includes('No repositories')) {
                    container.innerHTML = '';
                }
                repos.forEach(r => container.appendChild(createCheckbox(r, true)));
            } catch(e) { console.error('Error loading manual repos', e); }
        }

        function saveManualRepo(repo) {
            let repos = [];
            const existing = localStorage.getItem('git_analyzer_manual_repos');
            if (existing) {
                try { repos = JSON.parse(existing); } catch(e) {}
            }
            if (!repos.includes(repo)) {
                repos.push(repo);
                localStorage.setItem('git_analyzer_manual_repos', JSON.stringify(repos));
            }
        }


        // Checkbox Helper
        function createCheckbox(repoName, checked=true) {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input repo-checkbox" type="checkbox" value="${repoName}" id="chk_${repoName.replace(/\W/g,'_')}" ${checked ? 'checked' : ''}>
                <label class="form-check-label" for="chk_${repoName.replace(/\W/g,'_')}">
                    ${repoName}
                </label>
            `;
            return div;
        }

        // Add Manual Repo
        document.getElementById('addManualBtn').addEventListener('click', () => {
            const val = document.getElementById('manualRepoInput').value.trim();
            if(val) {
                const container = document.getElementById('repoChecklist');
                // clear empty message if needed
                if(container.innerText.includes('No repositories')) container.innerHTML = '';
                container.appendChild(createCheckbox(val, true));
                saveManualRepo(val); // Save to persistence
                document.getElementById('manualRepoInput').value = '';
            }
        });

        // Select/Deselect All
        document.getElementById('selectAllBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.repo-checkbox').forEach(c => c.checked = true);
        });
        document.getElementById('deselectAllBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.repo-checkbox').forEach(c => c.checked = false);
        });

        // Fetch Group Logic (Restored)
        document.getElementById('fetchGroupBtn').addEventListener('click', async (e) => {
             e.preventDefault(); // Important for <a> tag
             const groupInput = document.getElementById('groupName').value;
             const filterInput = document.getElementById('filterPattern').value;
             const btn = document.getElementById('fetchGroupBtn');
             const originalText = btn.textContent;
             
             btn.classList.add('disabled');
             btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Fetching...';
             
             try {
                let url = getBasePath() + '/api/download/list';
                const params = new URLSearchParams();
                if (groupInput) params.append('group', groupInput);
                if (filterInput) params.append('filter', filterInput);
                
                const response = await fetch(url + '?' + params.toString(), {
                    headers: getGitHeaders()
                });
                const data = await response.json();
                
                const container = document.getElementById('repoChecklist');
                container.innerHTML = ''; // clear

                if (data.repositories && data.repositories.length > 0) {
                    // Header for select all
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'repo-item border-bottom pb-2 mb-2';
                    headerDiv.innerHTML = `
                        <input type="checkbox" class="form-check-input me-2" id="selectAllCheckbox">
                        <label class="form-check-label fw-bold x-small" for="selectAllCheckbox">Select All (${data.repositories.length})</label>
                    `;
                    container.appendChild(headerDiv);
                    
                    data.repositories.forEach(repo => {
                        container.appendChild(createCheckbox(repo, true));
                    });

                    document.getElementById('selectAllCheckbox').onchange = (e) => {
                        container.querySelectorAll('.repo-checkbox').forEach(cb => cb.checked = e.target.checked);
                    };
                    
                    if (!groupInput && data.group) {
                         document.getElementById('groupName').value = data.group;
                    }
                } else {
                    container.innerHTML = '<div class="text-muted text-center mt-5">No repositories found matching criteria.</div>';
                }
             } catch (err) {
                 alert('Error fetching repositories: ' + err.message);
                 console.error(err);
             } finally {
                 btn.classList.remove('disabled');
                 btn.textContent = originalText;
             }
        });

                // Fetch Branches Logic
        const fetchBranchesHandler = async (btnId) => {
             // Find first available repo to check branches against
             const repos = Array.from(document.querySelectorAll('.repo-checkbox'));
             if (repos.length === 0) {
                 alert("Please fetch repositories first.");
                 return;
             }
             // Prefer first checked, otherwise first listed
             let sampleRepo = repos.find(cb => cb.checked)?.value || repos[0].value;
             
             // Get BOTH buttons to update state
             const btnLeft = document.getElementById('fetchBranchesBtnLeft');
             const btnRight = document.getElementById('fetchBranchesBtn');
             
             // Set loading state
             const setLoading = (isLoading) => {
                 if(btnLeft) {
                     btnLeft.disabled = isLoading;
                     btnLeft.innerHTML = isLoading ? '<span class="spinner-border spinner-border-sm"></span>' : 'Fetch Branches';
                 }
                 if(btnRight) {
                     btnRight.disabled = isLoading;
                     btnRight.innerHTML = isLoading ? '<i class="bi bi-git me-1"></i> Fetching...' : '<i class="bi bi-git me-1"></i> Fetch Branches';
                 }
             };
             
             setLoading(true);
             
             try {
                const response = await fetch(getBasePath() + '/api/download/branches?repo=' + encodeURIComponent(sampleRepo), {
                    headers: getGitHeaders()
                });
                if (!response.ok) throw new Error('API Error: ' + response.status);
                
                const branches = await response.json();
                
                const container = document.getElementById('branchChecklist');
                container.classList.remove('d-none'); 
                
                container.innerHTML = '<div class="fw-bold x-small mb-1 text-muted">Branches (' + branches.length + ' found)</div>';
                const listDiv = document.createElement('div');
                listDiv.className = 'scrollable-checklist';
                
                if (branches && branches.length > 0) {
                    branches.forEach(br => {
                        const div = document.createElement('div');
                        div.className = 'form-check form-check-sm';
                        div.innerHTML = `
                            <input class="form-check-input branch-checkbox" type="checkbox" value="${br}" id="br_${br.replace(/\./g,'_').replace(/\//g,'_')}">
                            <label class="form-check-label small" for="br_${br.replace(/\./g,'_').replace(/\//g,'_')}">${br}</label>
                        `;
                        listDiv.appendChild(div);
                    });
                     container.appendChild(listDiv);
                } else {
                    container.innerHTML = '<div class="text-muted small text-center mt-3">No branches found.</div>';
                }
             } catch (err) {
                 alert('Error fetching branches: ' + err.message);
                 console.error(err);
             } finally {
                 setLoading(false);
             }
        };

        // Bind to both buttons
        if(document.getElementById('fetchBranchesBtn')) {
            document.getElementById('fetchBranchesBtn').addEventListener('click', () => fetchBranchesHandler('fetchBranchesBtn'));
        }
        if(document.getElementById('fetchBranchesBtnLeft')) {
             document.getElementById('fetchBranchesBtnLeft').addEventListener('click', () => fetchBranchesHandler('fetchBranchesBtnLeft'));
        }
             

    </script>

    <!-- Downloading Modal -->
    <div class="modal fade" id="downloadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body" id="downloadingBody">
                    <h5 class="fw-bold text-purple mb-3">Downloading Repositories</h5>
                    
                    <!-- Progress Bar Container -->
                    <div class="progress mb-3" style="height: 25px; border-radius: 12px; overflow: hidden; background: #f0f0f0;">
                         <div id="downloadProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-purple" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>

                    <div id="currentDownloadLabel" class="text-dark fw-bold mb-1" style="font-size: 0.9rem;">Initializing...</div>
                    <div id="progressCountLabel" class="text-muted x-small mb-3">0 / 0 completed</div>

                    <p class="text-muted small mb-0">Please do not close this window.</p>
                </div>
                <div class="modal-body d-none" id="downloadSuccessBody">
                    <div class="mb-3 text-success">
                        <i class="bi bi-check-circle-fill display-4"></i>
                    </div>
                    <h5 class="fw-bold text-success">Download Complete!</h5>
                    <p class="text-muted small">All selected repositories have been processed.</p>
                </div>
            </div>
        </div>
    </div>

    <script>

        document.getElementById('downloadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Gather Selected Repos
            const selectedRepos = Array.from(document.querySelectorAll('.repo-checkbox:checked')).map(cb => cb.value);
            
            if(selectedRepos.length === 0) {
                alert("Please select at least one repository.");
                return;
            }

            const btn = document.getElementById('downloadBtn');
            // const originalText = btn.textContent; // No longer needed for button text
            
            // Show Modal
            const downloadingModal = new bootstrap.Modal(document.getElementById('downloadingModal'));
            document.getElementById('downloadingBody').classList.remove('d-none');
            document.getElementById('downloadSuccessBody').classList.add('d-none');
            downloadingModal.show();
            
            document.getElementById('resultsSection').classList.add('d-none');

            // Gather Branches
            const selectedBranches = Array.from(document.querySelectorAll('.branch-checkbox:checked')).map(cb => cb.value);
            const manualBranch = document.getElementById('branchManualInput').value.trim();
            if(manualBranch) {
                manualBranch.split(',').forEach(b => {
                    if(b.trim()) selectedBranches.push(b.trim());
                });
            }

            const payload = {
                repos: selectedRepos, 
                outputDir: document.getElementById('targetDir').value,
                branches: selectedBranches, // Sent as array
                overwrite: document.getElementById('overwriteCheckbox').checked
            };

            console.log("[DEBUG] Starting bulk download (async)...");
            console.log("[DEBUG] Payload:", payload);

            try {
                // Initial Request to start background task
                const response = await fetch(getBasePath() + '/api/download', {
                    method: 'POST',
                    headers: getGitHeaders(),
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || 'Failed to start download');
                }

                const data = await response.json();
                console.log("[DEBUG] Received Response:", data);

                if (data.details) {
                    // Synchronous Response (Wrapper Mode)
                    updateUIWithFinishedStatus(data);
                    setTimeout(() => {
                         downloadingModal.hide();
                         renderResults(data);
                    }, 1500);
                    return;
                }

                const taskId = data.taskId;

                // Polling Logic
                const pollInterval = setInterval(async () => {
                    try {
                        const statusRes = await fetch(getBasePath() + `/api/download/status/${taskId}`);
                        if (!statusRes.ok) return;

                        const status = await statusRes.json();
                        
                        // Update Progress Bar
                        const percent = status.total > 0 ? Math.round((status.success / status.total) * 100) : 0;
                        const pb = document.getElementById('downloadProgressBar');
                        pb.style.width = percent + '%';
                        pb.innerText = percent + '%';
                        pb.setAttribute('aria-valuenow', percent);

                        // Update Labels
                        document.getElementById('currentDownloadLabel').innerText = status.currentRepo || 'Processing...';
                        document.getElementById('progressCountLabel').innerText = `${status.success} / ${status.total} items completed`;

                        if (status.finished) {
                            clearInterval(pollInterval);
                            console.log("[DEBUG] Download Finished:", status);
                            
                            // Success State in Modal
                            document.getElementById('downloadingBody').classList.add('d-none');
                            document.getElementById('downloadSuccessBody').classList.remove('d-none');
                            
                            setTimeout(() => {
                                downloadingModal.hide();
                                renderResults(status);
                            }, 1500);
                        }

                        if (status.error) {
                            clearInterval(pollInterval);
                            throw new Error(status.error);
                        }
                    } catch (pollErr) {
                        console.error("[ERROR] Polling failed:", pollErr);
                        clearInterval(pollInterval);
                        downloadingModal.hide();
                        alert('Polling Error: ' + pollErr.message);
                    }
                }, 800);

            } catch (err) {
                console.error("[ERROR] Bulk download failed to start:", err);
                downloadingModal.hide();
                alert('Error: ' + err.message);
            }
        });

        function renderResults(result) {
            try {
                if (!result) return;
                
                const tbody = document.getElementById('resultsTableBody');
                tbody.innerHTML = '';
                
                const summary = document.getElementById('statusSummary');
                // Backend returns 'success' and 'outputDir'
                const successCount = result.success || 0;
                const totalCount = result.total || (result.details ? result.details.length : 0);
                const outDir = result.outputDir || 'unknown';
                
                summary.innerHTML = `<strong>Download Complete!</strong> Successfully downloaded ${successCount} out of ${totalCount} items to: <code>${outDir}</code>`;
    
                if (result.details) {
                    result.details.forEach(item => {
                        const tr = document.createElement('tr');
                        const isSuccess = item.status === 'SUCCESS';
                        const badgeClass = isSuccess ? 'bg-success' : 'bg-danger';
                        
                        tr.innerHTML = `
                            <td>${item.repo || 'Unknown'}</td>
                            <td class="fw-bold text-primary">${item.branch || '-'}</td>
                            <td><span class="badge ${badgeClass}">${item.status || 'ERROR'}</span></td>
                            <td class="small text-break">
                                ${isSuccess ? (item.path || 'Success') : '<span class="text-danger">' + (item.error || 'Unknown Error') + '</span>'}
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (renderErr) {
                console.error("Error rendering results:", renderErr);
                alert("Download finished, but error rendering results table: " + renderErr.message);
            } finally {
                // ALWAYS show the section
                document.getElementById('resultsSection').classList.remove('d-none');
            }
        }

        function updateUIWithFinishedStatus(data) {
             const progress = 100;
             const bar = document.getElementById('downloadProgressBar');
             if (bar) {
                bar.style.width = progress + '%';
                bar.innerText = progress + '%';
                bar.setAttribute('aria-valuenow', progress);
             }
             
             const label = document.getElementById('currentDownloadLabel');
             if (label) label.innerText = 'Finalizing...';
             
             const countLabel = document.getElementById('progressCountLabel');
             if (countLabel) countLabel.innerText = `${data.success} / ${data.total} completed`;
             
             const downloadingBody = document.getElementById('downloadingBody');
             const successBody = document.getElementById('downloadSuccessBody');
             if (downloadingBody) downloadingBody.classList.add('d-none');
             if (successBody) successBody.classList.remove('d-none');
        }

        // Fetch UI Config
        fetch(getBasePath() + '/api/config/ui')
            .then(response => response.json())
            .then(config => {
                if (config['ui.header.bulk']) {
                    const headerTitle = document.querySelector('.navbar .position-absolute h5');
                    if (headerTitle) headerTitle.textContent = config['ui.header.bulk'];
                }
                if (config['ui.footer.text']) {
                    const footerText = document.querySelector('.raks-footer .container'); 
                    // Note: bulk_download.html might not have the footer ID 'footerText' or structure. I need to verify structure first.
                    // Actually, I'll use querySelector which is safer if ID is missing.
                    if (footerText) footerText.innerHTML = config['ui.footer.text'];
                }
            })
            .catch(err => console.error('Error loading UI config:', err));
    </script>
</body>
</html>

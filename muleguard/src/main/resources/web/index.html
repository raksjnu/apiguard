<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>MuleGuard - Validation Tool</title>
    <link rel="stylesheet" href="style.css">
    <script>
       // Helper to check settings
       function checkSettings() {
           const token = localStorage.getItem('muleguard_git_token');
           const provider = localStorage.getItem('muleguard_git_provider');
           if (!token && document.querySelector('input[name="mode"]:checked').value === 'git') {
               if(confirm("Git Token is not configured. Go to Settings?")) {
                   window.location.href = 'settings.html';
                   return false;
               }
           }
           return true;
       }
    </script></head>

<body>
    <div class="container" style="position: relative;">
        <div style="position: absolute; top: 20px; right: 20px; display: flex; gap: 10px;">
            <a id="linkChecklist" href="checklist.html" class="nav-button" title="View all validation checklist items" style="padding: 8px 12px; font-size: 12px;">Checklist</a>
            <a id="linkRules" href="rule_guide.html" class="nav-button" title="Guide to all MuleGuard validation rules" style="padding: 8px 12px; font-size: 12px;">Rule Guide</a>
            <a id="linkSettings" href="settings.html" class="nav-button" title="Configure global settings" style="padding: 8px 12px; font-size: 12px;">Settings</a>
            <a id="linkHelp" href="help.html" class="nav-button" title="View help and documentation" style="padding: 8px 12px; font-size: 12px;">Help</a>
        </div>

        <div class="logo">
            <!-- Logo path will be adjusted by JS if needed -->
            <img id="logoImg" src="logo.svg" alt="MuleGuard Logo" style="height: 60px; margin-bottom: 10px;"
                 onerror="this.style.display='none'; this.parentNode.innerText='MuleGuard';">
            <h1>MuleGuard</h1>
        </div>

        <p class="subtitle">Comprehensive MuleSoft Application Validation Tool</p>

        <div class="mode-selector optional-section">
            <label>Choose Input Method:</label>
            
            <label id="localLabel">
                <input type="radio" name="mode" value="local" onchange="toggleMode()">
                &#128193; Local Folder Path
            </label>
            
            <label id="zipLabel">
                <input type="radio" name="mode" value="zip" onchange="toggleMode()">
                &#128230; Upload ZIP File
            </label>

            <label id="jarLabel">
                <input type="radio" name="mode" value="jar" onchange="toggleMode()">
                &#128218; Upload JAR/Archive
            </label>

            <label id="gitLabel">
                <input type="radio" name="mode" value="git" onchange="toggleMode()">
                &#128279; Git Repository
            </label>
        </div>

        <!-- Local Folder Input -->
        <div id="localInput" class="optional-section hidden">
            <label>Mule Projects Folder: 
                <a href="#" class="sample-download" onclick="downloadSample('muleapp1.zip')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Project)
                </a>
            </label>
            <input type="text" id="folderPath" placeholder="Enter folder path (e.g., C:\projects\muleapis)">
        </div>

        <!-- ZIP File Input -->
        <div id="zipInput" class="optional-section hidden">
            <label>Select ZIP File: 
                <a href="#" class="sample-download" onclick="downloadSample('muleapp1.zip')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Project)
                </a>
            </label>
            <input type="file" id="zipFile" accept=".zip">
            <small>ZIP should contain root folder with API and config folders</small>
        </div>

        <!-- JAR File Input -->
        <div id="jarInput" class="optional-section hidden">
            <label>Select Archive File:</label>
            <input type="file" id="jarFile" accept=".jar">
            <small>Supported formats: .jar (Mule App)</small>
        </div>

        <!-- Git Repo Input -->
        <div id="gitInput" class="optional-section hidden">
            <!-- View Mode Toggle -->
            <div style="display:flex; justify-content:center; margin-bottom: 20px;">
                <div style="background:white; border:1px solid #663399; border-radius:4px; overflow:hidden; display:flex;">
                    <label style="padding: 10px 20px; cursor:pointer; background:#663399; color:white; margin:0;" id="modeDiscoveryLabel">
                        <input type="radio" name="gitViewMode" value="discovery" checked style="display:none;" onchange="toggleGitView()"> 
                        Discover Repositories
                    </label>
                    <label style="padding: 10px 20px; cursor:pointer; background:white; color:#663399; margin:0;" id="modeManualLabel">
                        <input type="radio" name="gitViewMode" value="manual" style="display:none;" onchange="toggleGitView()"> 
                        Manual Git URL
                    </label>
                </div>
            </div>

            <p style="font-size:12px; color:#666; text-align:center; margin-top:-10px; margin-bottom:15px;">
                Using preferences from <a href="settings.html">Settings</a>.
            </p>

            <!-- Discovery Panel -->
            <div id="gitDiscoveryPanel">
                <div style="display:flex; gap:10px; margin-bottom: 10px;">
                    <div style="flex:1;">
                        <label>Group / Org Name / User:</label>
                        <input type="text" id="gitGroup" placeholder="e.g. raks-group">
                    </div>
                    <div style="flex:1;">
                        <label>Repository Name Filter (comma-separated):</label>
                        <input type="text" id="gitRepoFilter" placeholder="e.g. api-v1, mule-app">
                    </div>
                </div>
                <div style="text-align:right;">
                    <button type="button" class="nav-button" style="width:auto; white-space:nowrap; padding: 5px 20px;" id="fetchReposBtn" onclick="fetchGitRepos()">Fetch Repos</button>
                </div>
    
                <div id="repoResultsSection" style="display:none; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <label>Select Repositories:</label>
                        <label style="font-size:12px; cursor:pointer; color:#663399;">
                            <input type="checkbox" id="selectAllRepos" onchange="toggleAllRepos(this.checked)"> Select All
                        </label>
                    </div>
                    <div id="repoList" style="max-height:150px; overflow-y:auto; border:1px solid #663399; padding:8px; background:#fff; border-radius:4px;">
                        <!-- Repos appearing here -->
                    </div>
                    <div style="display:flex; justify-content: space-between; align-items: baseline; margin-top:5px;">
                        <small id="repoCountLabel" style="color: #666;"></small>
                        <button type="button" class="nav-button" style="width:auto; padding:2px 10px; font-size:12px; background:#6f42c1;" id="fetchBranchesBtn" onclick="fetchGitBranches()">Fetch Branches</button>
                    </div>
                </div>
            </div>

            <!-- Manual Panel -->
            <div id="gitManualPanel" style="display:none; margin-top:10px;">
                <label>Git Repository URL:</label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="gitUrl" placeholder="https://gitlab.com/group/project.git">
                    <button type="button" class="nav-button" style="width:auto; white-space:nowrap; padding: 0 15px; background:#6f42c1;" id="fetchBranchesManualBtn" onclick="fetchGitBranches(true)">Fetch Branches</button>
                </div>
            </div>

            <!-- Branch Section (Shared) -->
            <div id="branchSection" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                <label style="display: flex; justify-content: space-between;">Select Branch: <span id="branchStatus" style="font-size:0.8em; color:#28a745;"></span></label>
                <select id="gitBranchDropdown" style="width:100% !important; padding:10px; border:1px solid #ccc; border-radius:4px;">
                </select>
                <small>Defaults to <code>main</code> or <code>master</code> if not selected.</small>
            </div>
            
            <input type="hidden" id="gitUrls">

            <div style="margin-top:10px; font-size: 11px; color: #d9534f; background: #fff5f5; padding: 8px; border-radius: 4px; border: 1px solid #ffcccc;">
                <strong>Restrictions:</strong> Repository max size: 500MB. Max file size: 10MB. 
                Build artifacts (<code>target/</code>, <code>*.jar</code>) will be excluded.
                Shallow clone (depth=1) is enforced.
            </div>
            
            <div id="gitViewPersistent" style="display:none">
                 <!-- Hidden inputs to store state if needed, but we rely on simple DOM inputs now -->
            </div>
        </div>

        <!-- Custom Rules Input -->
        <div class="optional-section">
            <label>Optional: Custom Rules File 
                <a href="#" class="sample-download" onclick="downloadSample('sample-rules.yaml')"
                   style="margin-left: 10px; font-size: 0.9em; color: #663399; text-decoration: underline;">
                    (Download Sample Rules)
                </a>
            </label>
            <input type="file" id="customRules" accept=".yaml,.yml">
            <small>If not provided, default rules from MuleGuard JAR will be used</small>
        </div>

        <!-- Email Notification Options -->
        <div id="emailSection" class="optional-section" style="margin-top: 20px;">
            <strong style="color: #663399;">&#128231; Email Notification Options</strong>

            <div style="margin-top: 15px;">
                <label style="display: block; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachReports" checked>
                    Attach validation reports (compressed folder)
                </label>

                <label id="attachInputLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachInput" checked>
                    Attach input archive file
                </label>

                <label id="attachProjectLabel" style="display: none; margin: 10px 0; cursor: pointer;">
                    <input type="checkbox" id="attachProject">
                    Attach project folder (compressed)
                </label>

                <p id="adminOverrideNote"
                    style="display: none; color: #ff6600; font-size: 13px; margin-top: 15px; font-style: italic;">
                    &#9888;&#65039; Note: Administrator has overridden attachment options via server configuration.
                </p>
            </div>
        </div>

        <button id="runBtn" onclick="runValidation()">&#128640; Run MuleGuard</button>



        <div id="loading" class="hidden loading">
            <p>&#8987; Running validation...</p>
            <p>This may take a few minutes depending on the number of APIs.</p>
        </div>
    </div>

    <!-- Configuration Script -->
    <script>
        // Automatic environment detection
        const isWrapper = window.location.pathname.includes('/apiguard/');
        
        // Configuration
        const CONFIG = {
            baseUrl: isWrapper ? '/apiguard/muleguard' : '',
            apiUrl: isWrapper ? '/apiguard/muleguard/validate' : '/api/validate',
            resourceBase: isWrapper ? '/apiguard/muleguard/web' : '',
            defaultMode: isWrapper ? 'zip' : 'local'
        };

        // Initialize UI
        document.addEventListener('DOMContentLoaded', function () {
            // Set up links based on environment
            setupLinks();
            
            // Handle mode visibility based on environment
            if (isWrapper) {
                // Wrapper: Hide Local, Show ZIP/JAR
                const localLabel = document.getElementById('localLabel');
                if (localLabel) localLabel.style.display = 'none';
                
                // Default to ZIP
                selectMode('zip');
            } else {
                // Standalone: Show all (except Git disabled)
                // Default to Local
                selectMode('local');
            }

            // Update image sources if in standalone
            if (!isWrapper) {
                document.getElementById('logoImg').src = 'logo.svg';
                
                // Hide email section in standalone mode (no SMTP configured)
                const emailSection = document.getElementById('emailSection');
                if (emailSection) {
                    emailSection.style.display = 'none';
                }
            }

            // Load saved session preferences for Git (Group, Filter, URL only)
            loadSessionPrefs();
            
            // Add listeners for exclusivity? No longer needed with View Switcher
            
            // Initialize view state
            toggleGitView();
        });

        function setupLinks() {
            try {
                if (isWrapper && CONFIG.resourceBase) {
                     // Add debug indicator
                     console.log('Running setupLinks for Wrapper. Base:', CONFIG.resourceBase);
                     
                     // Fix stylesheet with cache bust
                     const cssLink = document.querySelector('link[rel="stylesheet"]');
                     if (cssLink) {
                         cssLink.href = CONFIG.resourceBase + '/style.css?v=' + new Date().getTime();
                     } else {
                         console.error('CSS Link not found');
                     }
                     
                     // Fix Logo
                     const logo = document.getElementById('logoImg');
                     if (logo) logo.src = CONFIG.resourceBase + '/logo.svg';
                     
                     // Fix Nav Links
                     const links = ['linkChecklist', 'linkRules', 'linkSettings', 'linkHelp'];
                     links.forEach(id => {
                         const el = document.getElementById(id);
                         if (el) {
                             const page = el.getAttribute('href');
                             if (!page.startsWith(CONFIG.resourceBase)) {
                                 el.href = CONFIG.resourceBase + '/' + page;
                             }
                         }
                     });
                }
            } catch (e) {
                console.error('Error in setupLinks:', e);
                // Fallback: visual alert
                const errDiv = document.createElement('div');
                errDiv.style.background='red';
                errDiv.style.color='white';
                errDiv.innerText = 'UI Error: ' + e.message;
                document.body.prepend(errDiv);
            }
        }

        // Use localStorage for Session Preferences (Non-sensitive)
        function loadSessionPrefs() {
            const savedGroup = localStorage.getItem('muleguard_session_group');
            const savedFilter = localStorage.getItem('muleguard_session_filter');
            const savedUrl = localStorage.getItem('muleguard_session_url');
            
            if (savedGroup) document.getElementById('gitGroup').value = savedGroup;
            if (savedFilter) document.getElementById('gitRepoFilter').value = savedFilter;
            if (savedUrl) document.getElementById('gitUrl').value = savedUrl;
        }

        function saveSessionPrefs() {
            // Auto-save session preferences (Sticky Session)
            localStorage.setItem('muleguard_session_group', document.getElementById('gitGroup').value);
            localStorage.setItem('muleguard_session_filter', document.getElementById('gitRepoFilter').value);
            localStorage.setItem('muleguard_session_url', document.getElementById('gitUrl').value);
        }
        
        function clearGitCreds() {
            // Clears session prefs
            localStorage.removeItem('muleguard_session_group');
            localStorage.removeItem('muleguard_session_filter');
            localStorage.removeItem('muleguard_session_url');
            
            document.getElementById('gitGroup').value = '';
            document.getElementById('gitRepoFilter').value = '';
            document.getElementById('gitUrl').value = '';
            document.getElementById('repoResultsSection').style.display = 'none';
            document.getElementById('branchSection').style.display = 'none';
            alert("Session preferences cleared.");
        }
        
        function toggleGitView() {
            const mode = document.querySelector('input[name="gitViewMode"]:checked').value;
            
            const discoveryPanel = document.getElementById('gitDiscoveryPanel');
            const manualPanel = document.getElementById('gitManualPanel');
            
            // Toggle visibility
            discoveryPanel.style.display = mode === 'discovery' ? 'block' : 'none';
            manualPanel.style.display = mode === 'manual' ? 'block' : 'none';
            
            // Update Tab Styles
            const discLabel = document.getElementById('modeDiscoveryLabel');
            const manLabel = document.getElementById('modeManualLabel');
            
            if (mode === 'discovery') {
                discLabel.style.backgroundColor = '#663399';
                discLabel.style.color = 'white';
                manLabel.style.backgroundColor = 'white';
                manLabel.style.color = '#663399';
            } else {
                discLabel.style.backgroundColor = 'white';
                discLabel.style.color = '#663399';
                manLabel.style.backgroundColor = '#663399';
                manLabel.style.color = 'white';
            }
        }
        
        // Removed old toggleGitInputs and handleCredsToggle as they are obsolete

        
        function saveGitCreds() {
            if (document.getElementById('saveGitCreds').checked) {
                localStorage.setItem('muleguard_git_group', document.getElementById('gitGroup').value);
                localStorage.setItem('muleguard_git_filter', document.getElementById('gitRepoFilter').value);
                localStorage.setItem('muleguard_git_token', document.getElementById('gitToken').value);
                const providerRadio = document.querySelector('input[name="gitProvider"]:checked');
                if (providerRadio) localStorage.setItem('muleguard_git_provider', providerRadio.value);
                localStorage.setItem('muleguard_git_url', document.getElementById('gitUrl').value);
            }
            // Always save Custom Rules path if provided? Or only if checked?
            // User requested persistence, so let's save if checked or always. 
            // Let's assume if checked 'Remember git details' means 'Remember settings'.
            // Actually user asked for "remember custom rules option". 
            // Let's save custom rules whenever saveGitCreds is called, which happens on Run.
             if (document.getElementById('saveGitCreds').checked) {
                const customRulesPath = document.getElementById('customRules').value;
                if (customRulesPath) localStorage.setItem('muleguard_custom_rules', customRulesPath);
             }
        }
        
        function clearGitCreds() {
            localStorage.removeItem('muleguard_git_group');
            localStorage.removeItem('muleguard_git_filter');
            localStorage.removeItem('muleguard_git_token');
            localStorage.removeItem('muleguard_git_provider');
            localStorage.removeItem('muleguard_git_url');
            
            document.getElementById('gitGroup').value = '';
            document.getElementById('gitRepoFilter').value = '';
            document.getElementById('gitToken').value = '';
            document.getElementById('gitUrl').value = '';
            document.getElementById('repoResultsSection').style.display = 'none';
            document.getElementById('branchSection').style.display = 'none';
            document.getElementById('saveGitCreds').checked = false;
            toggleGitInputs(); // Reset state
            alert("Saved git credentials cleared.");
        }
        
        function toggleGitInputs() {
            const groupVal = document.getElementById('gitGroup').value.trim();
            const filterVal = document.getElementById('gitRepoFilter').value.trim();
            const urlVal = document.getElementById('gitUrl').value.trim();
            
            const groupActive = groupVal.length > 0 || filterVal.length > 0;
            const urlActive = urlVal.length > 0;
            
            // Manual URL inputs
            document.getElementById('gitUrl').disabled = groupActive;
            document.getElementById('fetchBranchesManualBtn').disabled = groupActive;
            if (groupActive) {
                document.getElementById('gitUrl').title = "Clear Group/Org fields to use Manual URL";
                document.getElementById('manualGitUrl').style.opacity = '0.5';
            } else {
                 document.getElementById('gitUrl').title = "";
                 document.getElementById('manualGitUrl').style.opacity = '1';
            }

            // Discovery inputs
            document.getElementById('gitGroup').disabled = urlActive;
            document.getElementById('gitRepoFilter').disabled = urlActive;
            document.getElementById('fetchReposBtn').disabled = urlActive;
            if (urlActive) {
                 document.getElementById('gitGroup').parentElement.parentElement.style.opacity = '0.5';
            } else {
                 document.getElementById('gitGroup').parentElement.parentElement.style.opacity = '1';
            }
        }

        function handleCredsToggle() {
             if (!document.getElementById('saveGitCreds').checked) {
                 clearGitCreds();
             }
        }



        function downloadSample(filename) {
            const url = CONFIG.resourceBase + '/' + filename;
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function selectMode(modeValue) {
            const radio = document.querySelector(`input[name="mode"][value="${modeValue}"]`);
            if (radio) {
                radio.checked = true;
                toggleMode();
            }
        }

        function toggleMode() {
            const radio = document.querySelector('input[name="mode"]:checked');
            if (!radio) return;
            
            const mode = radio.value;
            
            document.getElementById('localInput').classList.toggle('hidden', mode !== 'local');
            document.getElementById('zipInput').classList.toggle('hidden', mode !== 'zip');
            document.getElementById('jarInput').classList.toggle('hidden', mode !== 'jar');
            document.getElementById('gitInput').classList.toggle('hidden', mode !== 'git');
            
            // Show/hide attachment options
            if (mode === 'zip' || mode === 'jar') {
                document.getElementById('attachInputLabel').style.display = 'block';
                document.getElementById('attachProjectLabel').style.display = 'none';
            } else if (mode === 'git') {
                document.getElementById('attachInputLabel').style.display = 'none';
                document.getElementById('attachProjectLabel').style.display = 'block';
            } else {
                document.getElementById('attachInputLabel').style.display = 'none';
                document.getElementById('attachProjectLabel').style.display = 'block';
            }
        }

        function updateNavLinks(sessionId) {
            document.querySelectorAll('.nav-button').forEach(link => {
                const href = link.getAttribute('href');
                if (href && href !== '#' && !href.includes('session=')) {
                    link.setAttribute('href', href + (href.includes('?') ? '&' : '?') + 'session=' + sessionId);
                }
            });
        }

        function showProgress(show, title = "Validating Project...", text = "Running comprehensive analysis...") {
            const modal = document.getElementById('progressModal');
            if (show) {
                document.getElementById('progressTitle').innerText = title;
                document.getElementById('progressText').innerText = text;
                modal.style.display = 'flex';
            } else {
                modal.style.display = 'none';
            }
        }

        function runValidation() {
            const radio = document.querySelector('input[name="mode"]:checked');
            if (!radio) {
                showAlert('Please select an input mode');
                return;
            }
            const mode = radio.value;
            const formData = new FormData();
            
            // Get session ID
            const sessionId = new URLSearchParams(window.location.search).get('session');
            if (sessionId) formData.append('session', sessionId);
            
            formData.append('mode', mode);

            // Validation logic based on mode
            if (mode === 'local') {
                const path = document.getElementById('folderPath').value;
                if (!path) {
                    showAlert('Please enter a folder path');
                    return;
                }
                formData.append('path', path);
                showProgress(true, "Scanning Local Project", "Analyzing files in " + path + "...");
            } else if (mode === 'zip') {
                const file = document.getElementById('zipFile').files[0];
                if (!file) {
                    showAlert('Please select a ZIP file');
                    return;
                }
                formData.append('archive', file);
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            } else if (mode === 'jar') {
                const file = document.getElementById('jarFile').files[0];
                if (!file) {
                    showAlert('Please select a JAR file');
                    return;
                }
                formData.append('archive', file);
                showProgress(true, "Uploading & Scanning", "Uploading " + file.name + " and running analysis...");
            } else if (mode === 'git') {
                // Determine Provider
                let provider = 'gitlab'; // Default
                const gitViewMode = document.querySelector('input[name="gitViewMode"]:checked').value;
                let gitUrls = "";
                
                if (gitViewMode === 'discovery') {
                     const fetchedUrls = document.getElementById('gitUrls').value;
                     if (!fetchedUrls) {
                         showAlert('Please select repositories from the list');
                         return;
                     }
                     gitUrls = fetchedUrls;
                     // In discovery mode, provider is selected explicitly
                     const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
                     if (providerSelect) provider = providerSelect.value;
                } else {
                     const manualUrl = document.getElementById('gitUrl').value;
                     if (!manualUrl) {
                         showAlert('Please enter a Manual Git URL');
                         return;
                     }
                     gitUrls = manualUrl;
                     
                     // Infer provider from URL if possible
                     if (manualUrl.includes("github.com")) provider = 'github';
                     else if (manualUrl.includes("gitlab.com")) provider = 'gitlab';
                     else {
                         // Fallback to default setting
                         provider = localStorage.getItem('muleguard_git_provider') || 'gitlab';
                     }
                }
                
                formData.append('gitUrls', gitUrls);
                const selectedBranch = document.getElementById('gitBranchDropdown').value || "";
                formData.append('gitBranch', selectedBranch);
                
                // Get Token based on Provider
                let token = "";
                if (provider === 'github') {
                    token = localStorage.getItem('muleguard_github_token') || "";
                } else {
                    token = localStorage.getItem('muleguard_gitlab_token') || "";
                }
                
                // Fallback to legacy key if not found (migration)
                if (!token) token = localStorage.getItem('muleguard_git_token') || "";

                if(!token) {
                    console.warn(`No ${provider} token found. Creating public request.`);
                    // Optional: could just proceed without token for public repos
                }
                formData.append('gitToken', token);
                
                // Save session preferences
                saveSessionPrefs();
                
                const repoCount = gitUrls.split(',').length;
                showProgress(true, "Cloning & Scanning", `Cloning ${repoCount} repository(s) from ${provider} and running analysis...`);
            }

            // Custom rules
            const customRules = document.getElementById('customRules').files[0];
            if (customRules) {
                formData.append('customRules', customRules);
            } else {
                // If no file uploaded, check for default rules path in Settings
                const defaultRulesPath = localStorage.getItem('muleguard_custom_rules_path');
                if (defaultRulesPath) {
                    formData.append('customRulesPath', defaultRulesPath);
                }
            }

            // Email options
            formData.append('attachReports', document.getElementById('attachReports').checked);
            formData.append('attachInput', document.getElementById('attachInput').checked);
            formData.append('attachProject', document.getElementById('attachProject').checked);

            // UI State
            document.getElementById('runBtn').disabled = true;

            // API Call
            fetch(CONFIG.apiUrl, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                showProgress(false); // Hide progress
                document.getElementById('runBtn').disabled = false;
                
                if (data.status === 'success' || data.success === true) {
                    handleSuccess(data, mode, sessionId);
                } else {
                    showAlert('Error: ' + (data.message || 'Unknown error occurred'));
                }
            })
            .catch(error => {
                showProgress(false); // Hide progress
                showAlert('Network Error: ' + error.message);
                document.getElementById('runBtn').disabled = false;
            });
        }
        
        function handleSuccess(data, mode, sessionId) {
            // Use the session ID returned from the server if the initial one was null
            const activeSessionId = data.sessionId || sessionId;

            let message = '';
            // Basic report link logic
            const reportName = data.reportFolder || 'validation-report';
            const resourceBase = CONFIG.resourceBase;
            const openReportUrl = resourceBase + '/' + reportName + '/report.html';
            
            if (mode === 'local') {
                // Escape path for string literal usage in onclick
                const safePath = data.reportPath.replace(/\\/g, '\\\\');
                
                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report generated at: <br><code>${data.reportPath}</code></p>
                    <div style="margin-top:20px;">
                        <button class="btn-primary" onclick="openLocalReportApi('${safePath}')">Open Report in Browser</button>
                    </div>
                `;
            } else {
                // ZIP/JAR mode uses the server's relative URL if available, or constructs one
                // The backend now returns 'relativeReportUrl' which is safer
                let finalUrl = openReportUrl;
                if (data.relativeReportUrl) {
                    finalUrl = CONFIG.baseUrl + '/reports/' + activeSessionId + '/' + data.relativeReportUrl;
                }

                message = `
                    <p>&#9989; <strong>Validation Complete!</strong></p>
                    <p>Report has been generated.</p>
                    <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
                        <button class="btn-primary" onclick="window.open('${finalUrl}', '_blank')">View Report Online</button>
                `;
                
                if (data.reportZip) {
                    message += `<button class="btn-primary" style="background:#555;" onclick="window.location.href='${CONFIG.baseUrl}/download?file=${encodeURIComponent(data.reportZip)}&session=${activeSessionId}'">Download Report ZIP</button>`;
                } else {
                     message += `<button class="btn-primary" style="background:#aa5; cursor:not-allowed;" disabled>Download ZIP Not Available</button>`;
                }
                
                message += `</div>`;
            }

            showAlert(message, true);
        }

        function openLocalReportApi(path) {
            // Use the backend API to open the file on the host OS
            const formData = new URLSearchParams();
            formData.append('path', path);
            
            // Handle context path if in wrapper
            const apiBase = CONFIG.baseUrl || ''; 
            
            fetch(apiBase + '/api/open', {
                method: 'POST',
                body: formData
            })
            .then(r => r.json())
            .then(d => {
                if(!d.success) alert('Failed to open report automatically. Please open the file manually: ' + path);
            })
            .catch(e => alert('Error requesting to open report: ' + e.message));
        }

        function showAlert(message, isHtml = false) {
            const modalBody = document.getElementById('modalMessage');
            if (isHtml) {
                modalBody.innerHTML = message;
            } else {
                modalBody.textContent = message;
            }
            document.getElementById('customModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customModal').style.display = 'none';
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                /* Optional toast or alert, or just let user know via tooltip */
                const btn = document.querySelector('button[onclick^="copyToClipboard"]');
                if(btn) {
                    const originalText = btn.innerText;
                    btn.innerText = "Copied!";
                    setTimeout(() => btn.innerText = originalText, 1500);
                }
            });
        }

        // Git Discovery Functions
        async function fetchGitRepos() {
            let group = document.getElementById('gitGroup').value;
            const filter = document.getElementById('gitRepoFilter').value;
            const btn = document.getElementById('fetchReposBtn');
            
            if (!group) {
                showAlert('Please enter a Group or Organization name');
                return;
            }

            // Auto-sanitize: If user entered full URL, extract the group part
            // Handles https://gitlab.com/groupname or https://github.com/orgname
            group = group.trim();
            if (group.startsWith('http')) {
                 const urlParts = group.split('/');
                 // usually last part, or last non-empty part
                 // ex: https://gitlab.com/raks-group -> raks-group
                 // ex: https://gitlab.com/raks-group/ -> raks-group
                 group = urlParts.filter(p => p.length > 0).pop();
            }
            
            // Get credentials from Settings
            const provider = localStorage.getItem('muleguard_git_provider') || 'gitlab';
            const token = localStorage.getItem('muleguard_git_token') || '';
            const gitlabUrl = localStorage.getItem('muleguard_gitlab_url') || '';
            const githubUrl = localStorage.getItem('muleguard_github_url') || '';
            
            if (!token) {
                if(!confirm("No Git Token configured in Settings. Fetching private repos will fail. Continue?")) return;
            }

            btn.disabled = true;
            btn.innerText = 'Fetching...';
            showProgress(true, "Discovering Repositories", `Fetching projects for '${group}' from ${provider}...`);
            
            try {
                // Adjust API base for discovery
                const apiBase = CONFIG.baseUrl || '';
                let url = apiBase + `/api/git/repos?provider=${provider}&token=${encodeURIComponent(token)}&group=${encodeURIComponent(group)}&filter=${encodeURIComponent(filter)}`;
                
                if(gitlabUrl) url += `&gitlabUrl=${encodeURIComponent(gitlabUrl)}`;
                if(githubUrl) url += `&githubUrl=${encodeURIComponent(githubUrl)}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch repositories. Check token and group/org.');
                
                let repos = await response.json();
                
                // Robust parsing for various backend return types
                if (typeof repos === 'string') {
                    try { repos = JSON.parse(repos); } catch(e) { console.error("Failed to parse repo string", e); }
                }
                // Handle wrapped object (e.g. { "repos": [...] } or { "result": [...] })
                if (!Array.isArray(repos) && typeof repos === 'object') {
                    if (Array.isArray(repos.repos)) repos = repos.repos;
                    else if (Array.isArray(repos.result)) repos = repos.result;
                    // If map but unclear, try Object.keys or values? No, safer to fail or show raw.
                }

                const list = document.getElementById('repoList');
                list.innerHTML = '';
                
                if (!Array.isArray(repos) || repos.length === 0) {
                    list.innerHTML = '<div style="padding:10px; color:#666; text-align:center;">No repositories found.</div>';
                    if(!Array.isArray(repos)) console.warn('Expected array but got:', repos);
                } else {
                    repos.forEach(repo => {
                        const div = document.createElement('div');
                        div.style.padding = '5px 0';
                        div.innerHTML = `<label style="font-weight:normal; display:flex; align-items:center; cursor:pointer; margin:0;">
                            <input type="checkbox" class="repo-check" value="${repo}" style="width:auto; margin-right:8px;" onchange="updateSelectedRepos()"> ${repo}
                        </label>`;
                        list.appendChild(div);
                    });
                }
                document.getElementById('repoResultsSection').style.display = 'block';
            } catch (err) {
                showProgress(false);
                showAlert('Error: ' + err.message);
            } finally {
                showProgress(false);
                btn.disabled = false;
                btn.innerText = 'Fetch Repos';
            }
        }

        function toggleAllRepos(checked) {
            const checks = document.querySelectorAll('.repo-check');
            checks.forEach(c => c.checked = checked);
            updateSelectedRepos();
        }

        function updateSelectedRepos() {
            const checks = document.querySelectorAll('.repo-check:checked');
            const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
            const provider = providerSelect ? providerSelect.value : 'gitlab';
            
            const urls = Array.from(checks).map(c => {
                 const repo = c.value;
                 if (provider === 'github') return `https://github.com/${repo}.git`;
                 else return `https://gitlab.com/${repo}.git`;
            });
            document.getElementById('gitUrls').value = urls.join(',');
            document.getElementById('repoCountLabel').innerText = `${urls.length} selected`;
        }

        async function fetchGitBranches(isManual = false) {
            let repoToFetch = "";
            if (isManual) {
                repoToFetch = document.getElementById('gitUrl').value;
                if (!repoToFetch) {
                    showAlert('Please enter a Manual Git URL first');
                    return;
                }
            } else {
                const checks = document.querySelectorAll('.repo-check:checked');
                if (checks.length === 0) {
                    showAlert('Please select at least one repository first');
                    return;
                }
                repoToFetch = checks[0].value;
            }
            
            // Get credentials from Settings
            // Determine Provider for Fetch
            let provider = 'gitlab';
            let token = '';

            if (isManual) {
                // Infer from URL in manual mode
                if (repoToFetch.includes("github.com")) provider = 'github';
                else if (repoToFetch.includes("gitlab.com")) provider = 'gitlab';
                else provider = localStorage.getItem('muleguard_git_provider') || 'gitlab';
            } else {
                // Use selected provider in discovery mode
                 const providerSelect = document.querySelector('input[name="gitProvider"]:checked');
                 provider = providerSelect ? providerSelect.value : 'gitlab';
            }
            
            // Get credentials from Settings
            if (provider === 'github') {
                token = localStorage.getItem('muleguard_github_token') || localStorage.getItem('muleguard_git_token') || '';
            } else {
                token = localStorage.getItem('muleguard_gitlab_token') || localStorage.getItem('muleguard_git_token') || '';
            }
            const gitlabUrl = localStorage.getItem('muleguard_gitlab_url') || '';
            const githubUrl = localStorage.getItem('muleguard_github_url') || '';

            const btn = isManual ? document.getElementById('fetchBranchesManualBtn') : document.getElementById('fetchBranchesBtn');
            const status = document.getElementById('branchStatus');

            btn.disabled = true;
            if (!isManual) status.innerText = 'Fetching...';
            showProgress(true, "Discovering Branches", `Fetching branches for ${repoToFetch}...`);
            
            try {
                const apiBase = CONFIG.baseUrl || '';
                let url = apiBase + `/api/git/branches?provider=${provider}&token=${encodeURIComponent(token)}&repo=${encodeURIComponent(repoToFetch)}`;
                
                if(gitlabUrl) url += `&gitlabUrl=${encodeURIComponent(gitlabUrl)}`;
                if(githubUrl) url += `&githubUrl=${encodeURIComponent(githubUrl)}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to fetch branches');
                
                const branches = await response.json();
                const select = document.getElementById('gitBranchDropdown');
                select.innerHTML = '';
                
                if (!branches || branches.length === 0) {
                    select.innerHTML = '<option value="">No branches found</option>';
                } else {
                    branches.forEach(b => {
                        const opt = document.createElement('option');
                        opt.value = b;
                        opt.innerText = b;
                        if (b === 'main' || b === 'master') opt.selected = true;
                        select.appendChild(opt);
                    });
                }
                document.getElementById('branchSection').style.display = 'block';
                if (!isManual) {
                    status.innerText = 'Done';
                    setTimeout(() => { status.innerText = ''; }, 2000);
                }
                showProgress(false);
            } catch (err) {
                showProgress(false);
                showAlert('Error: ' + err.message);
                if (!isManual) status.innerText = 'Error';
            } finally {
                showProgress(false);
                btn.disabled = false;
            }
        }
    </script>

    <!-- Progress Modal -->
    <div id="progressModal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="progressTitle" style="color: #333; margin-bottom: 10px;">Validating Project...</h3>
            <div class="progress-container">
                <div class="progress-bar indeterminate"></div>
            </div>
            <p id="progressText" style="color: #666; margin-top: 15px; font-size: 14px;">Running comprehensive analysis. This may take a moment...</p>
        </div>
    </div>
    
    <!-- Message Modal (Reuses modal-content style) -->
    <div id="customModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: #663399; margin-bottom: 15px;">MuleGuard Notification</h3>
            <div id="modalMessage" style="margin-bottom: 20px; color: #333;"></div>
            <button onclick="closeModal()" style="padding: 8px 20px; background: #663399; color: white; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>

</body>
</html>

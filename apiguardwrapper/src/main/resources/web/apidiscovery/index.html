<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Raks API Discovery & Governance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #663399; /* Corporate Purple */
            --secondary-color: #03dac6;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --text-color: #333;
            --header-bg: #663399;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; background-color: var(--bg-color); color: var(--text-color); }
        header { background-color: var(--header-bg); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .brand { font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        .tabs { display: flex; gap: 1rem; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #ddd; cursor: pointer; border-radius: 8px 8px 0 0; margin-right: 5px; font-weight: bold; transition: all 0.2s ease; border: 2px solid #ddd; }
        .tab:hover:not(.active) { background: #e0e0e0; transform: translateY(-2px); border-color: var(--primary-color); }
        .tab.active { background: var(--primary-color); color: white; transform: translateY(0); border: 2px solid var(--primary-color); border-bottom: none; }

        .card { background: var(--card-bg); border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 2rem; border: 2px solid var(--primary-color); }
        .card h2 { margin-top: 0; color: var(--primary-color); border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Breadcrumbs */
        .breadcrumbs { background: #f0f0f0; padding: 10px 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; border-left: 4px solid var(--primary-color); }
        .breadcrumbs strong { color: var(--primary-color); }
        .breadcrumbs span { color: #666; margin: 0 5px; }

        /* Wizard Steps */
        .wizard-step { display: none; }
        .wizard-step.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 2px solid var(--primary-color); border-radius: 8px; box-sizing: border-box; font-family: inherit; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #552b80; box-shadow: 0 0 0 3px rgba(102, 51, 153, 0.1); }
        
        button { background: var(--primary-color); color: white; border: 2px solid var(--primary-color); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease; }
        button:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(102, 51, 153, 0.3); background-color: #552b80; border-color: #552b80; }
        button:active { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(102, 51, 153, 0.3); }
        button.secondary { background-color: #757575; border-color: #757575; }
        button.small { padding: 5px 10px; font-size: 0.8rem; }
        
        /* Grid/List View */
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; max-height: 70vh; overflow-y: auto; padding: 5px; }
        .grid-container.list-view { grid-template-columns: 1fr; }
        
        .grid-item { background: #fff; border: 2px solid var(--primary-color); padding: 15px; border-radius: 10px; cursor: pointer; transition: all 0.2s; position: relative; }
        .list-view .grid-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; }
        
        .grid-item:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(102, 51, 153, 0.2); border-color: #552b80; }
        .list-view .grid-item:hover { transform: none; background-color: #f9f9f9; }
        
        .grid-item.selected { background-color: #f3e5f5; border-color: var(--primary-color); border-width: 3px; }
        
        .grid-item h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .grid-item p { margin: 0; font-size: 0.9rem; color: #666; word-break: break-all; }
        
        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; margin-top: 1rem; border: 2px solid var(--primary-color); border-radius: 8px; overflow: hidden; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        th { background-color: #f9f9f9; color: #555; border-bottom: 2px solid var(--primary-color); }
        
        .progress-bar-container { width: 100%; background-color: #ddd; border-radius: 8px; margin-top: 10px; height: 10px; overflow: hidden; display: none; border: 1px solid var(--primary-color); }
        .progress-bar { height: 100%; background-color: var(--secondary-color); width: 0%; transition: width 0.3s; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; position: relative; border: 3px solid var(--primary-color); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; font-weight: bold; color: #666; }
        
        .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-right: 5px; color: white; }
        .badge.mule { background-color: #00a1df; }
        .badge.spring { background-color: #6db33f; }
        .badge.python { background-color: #ffe873; color: #333; }
        .badge.tibco { background-color: #ce000c; }
        
        .view-controls { display: flex; gap: 5px; align-items: center; }
        
        .ignore-btn {
            background-color: #d32f2f !important;
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        .ignore-btn:hover { background-color: #b71c1c !important; }

        /* Loading Overlay */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 2000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        /* Spinner & Progress */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .progress-container { width: 100%; background-color: #fff; border: 2px solid var(--primary-color) !important; border-radius: 4px; margin-top: 10px; height: 12px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--primary-color); width: 0%; transition: width 0.3s ease; }
        
        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border: 2px solid var(--primary-color) !important;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <!-- Base64 Logo for robustness -->
        <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj4KICA8cGF0aCBkPSJNIDE1IDIwIEwgNDAgMTAgTCA2NSAyMCBMIDY1IDQ1IFEgNjUgNjAgNDAgNzUgUSAxNSA2MCAxNSA0NSBaIiBmaWxsPSIjNjYzMzk5IiBzdHJva2U9IiM2NjMzOTkiIHN0cm9rZS13aWR0aD0iMiIvPgogIDx0ZXh0IHg9IjQwIiB5PSI1MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiPlJBS1M8L3RleHQ+Cjwvc3ZnPg==" alt="Raks Logo" style="height: 40px; background: white; padding: 5px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        Raks API Discovery
    </div>
    <div>
        <a href="#" onclick="switchTab('settings'); return false;" style="color: white; text-decoration: none; font-weight: 500; display: flex; align-items: center; gap: 5px; border: 1px solid white; padding: 5px 10px; border-radius: 4px;">
            üìò Guide / Help
        </a>
    </div>
</header>

<div class="container">
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('quick')">‚ö° Quick Scan</div>
        <div class="tab" onclick="switchTab('discovery')">üîç API Discovery</div>
        <div class="tab" onclick="switchTab('correlation')">üîó Traffic Correlation</div>
        <div class="tab" onclick="switchTab('history')">üìú Scan History</div>
        <div class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</div>
    </div>

    <!-- TAB: DISCOVERY (WIZARD) -->
    <div id="tab-discovery" class="tab-content" style="display:none;">
        <div class="card">
            
            <!-- Step 1: Connect -->
            <div id="step-1" class="wizard-step active">
                <h3>Step 1: Connect to GitLab</h3>
                <p>Ensure your credentials are configured in the <strong>Settings</strong> tab.</p>
                <div class="info-box">
                     <p>Target: <strong id="disp-gitlab-url">Loading...</strong></p>
                </div>
                <button onclick="fetchGroups()">Fetch Groups &rarr;</button>
            </div>

            <!-- Step 2: Select Group -->
            <div id="step-2" class="wizard-step">
                <h2>Step 2: Select a Group</h2>
                <div class="breadcrumbs" id="bc-step-2">Connected to GitLab <span>&gt;</span> <strong>Select Group</strong></div>
                
                <button class="secondary" onclick="prevStep(1)">&larr; Back</button>
                <p>Select the group you want to scan.</p>
                
                <div style="margin-bottom: 10px; display: flex; gap: 10px;">
                     <input type="text" id="manualGroupInput" placeholder="Or enter Group Name/ID (e.g. raksjnu)">
                     <button onclick="manualGroupSelect()" style="padding: 5px 10px; font-size: 0.9rem;">Go</button>
                </div>
                <div id="groups-grid" class="grid-container"></div>
            </div>

            <!-- Step 3: Select Projects -->
            <div id="step-3" class="wizard-step">
                <h2>
                    Step 3: Select Projects
                    <div class="view-controls">
                        <button class="small secondary" onclick="setViewMode('grid')" title="Grid View">Tiles</button>
                        <button class="small secondary" onclick="setViewMode('list')" title="List View">List</button>
                    </div>
                </h2>
                <div class="breadcrumbs" id="bc-step-3">GitLab <span>&gt;</span> <span id="bc-group-name">Group</span> <span>&gt;</span> <strong>Select Projects</strong></div>
                
                <button class="secondary" onclick="prevStep(2)">&larr; Back</button>
                <p>Select one or more projects to include in the scan.</p>
                
                <div style="margin-bottom: 10px;">
                    <button onclick="selectAllProjects()">Select All</button>
                    <button class="secondary" onclick="deselectAllProjects()">Deselect All</button>
                </div>
                
                <div id="projects-grid" class="grid-container"></div>
                
                <br>
                <button onclick="nextStep(4)">Configure Scan &rarr;</button>
            </div>

            <!-- Step 4: Configure & Run -->
            <div id="step-4" class="wizard-step">
                <h2>Step 4: Scan Configuration</h2>
                <div class="breadcrumbs" id="bc-step-4">GitLab <span>&gt;</span> <span id="bc-group-name-4">Group</span> <span>&gt;</span> Projects Selected <span>&gt;</span> <strong>Configure</strong></div>
                
                <button class="secondary" onclick="prevStep(3)">&larr; Back</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Scan Mode</label>
                    <select id="scanMode">
                        <option value="full">Full Analysis (Code + Metadata)</option>
                        <option value="metadata">Metadata Only (Fast - Owner, Certs, Docs)</option>
                    </select>
                </div>
                
                <div id="scan-review">
                    <p><strong>Selected Target:</strong> <span id="review-target-count">0</span> Projects</p>
                    <div id="review-project-list" style="max-height: 150px; overflow-y: auto; background: #fff; border: 1px solid #eee; padding: 10px; margin-bottom: 20px; font-size: 0.9rem; border-radius: 4px;"></div>
                </div>

                <button onclick="startWizardScan()">üöÄ Start Scan</button>
                
                <div id="scan-progress-container" class="progress-bar-container">
                    <div id="scan-progress-bar" class="progress-bar"></div>
                </div>
                <div id="scan-status-text" style="margin-top: 10px; font-style: italic;"></div>
            </div>

            <!-- Step 5: Results -->
            <div id="step-5" class="wizard-step">
                <h2>Step 5: Scan Results</h2>
                <div class="breadcrumbs" id="bc-step-5">GitLab <span>&gt;</span> Group <span>&gt;</span> Projects <span>&gt;</span> Configure <span>&gt;</span> <strong>Results</strong></div>
                
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="color: var(--primary-color);">üéâ Scanning Complete!</h3>
                    <p>Here are the immediate results from your selected projects.</p>
                </div>
                
                <div id="results-container" class="grid-container">
                    <!-- Results injected here -->
                </div>
                
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="switchTab('history')">View Full History</button>
                    <button class="secondary" onclick="location.reload()">Start New Scan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB: QUICK SCAN -->
    <div id="tab-quick" class="tab-content">
        <div class="card">
            <h2>‚ö° Quick Scan</h2>
            <p>Directly scan a single repository without browsing groups.</p>
            
            <div class="form-group">
                <label>GitLab URL or Local Path</label>
                <input type="text" id="quickSource" placeholder="https://gitlab.com/group/project.git or C:/work/repo">
            </div>
            
            <div class="form-group" style="display:flex; gap:20px;">
                <div style="flex:1;">
                     <label>Scan Mode</label>
                     <select id="quickMode">
                         <option value="full">Full Analysis</option>
                         <option value="metadata">Metadata Only</option>
                     </select>
                </div>
            </div>
            
            <button onclick="startQuickScan()">üöÄ Start Discovery</button>
            
            <div id="quick-results-container" style="margin-top: 30px;"></div>
        </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tab-content" style="display:none;">
        <div class="card">
            <h2>‚öôÔ∏è Configuration</h2>
            <p>Configure your global GitLab credentials here. These will be used for all scans.</p>
            
            <div class="form-group">
                <label>GitLab Base URL</label>
                <input type="text" id="setting-url" placeholder="https://gitlab.com">
            </div>
            
            <div class="form-group">
                <label>Personal Access Token</label>
                <input type="password" id="setting-token" placeholder="glpat-...">
            </div>
            
            <button onclick="saveSettings()">üíæ Save Configuration</button>
            <span id="save-msg" style="margin-left:10px; color:green; display:none;">Saved!</span>
        </div>
    </div>

    <!-- TAB: CORRELATION -->
    <div id="tab-correlation" class="tab-content" style="display:none;">
        <div class="card">
            <h2>Traffic Correlation Engine</h2>
            <p>Paste network traffic logs (IPs, Hostnames, or Domains) to find which Repository they belong to.</p>
            <div class="form-group">
                <textarea id="trafficInput" rows="10" placeholder="192.168.1.50&#10;api.finance.raks.com&#10;payment-service-prod"></textarea>
            </div>
            <button onclick="runCorrelation()">Analyze Traffic</button>
            <div id="correlation-results" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- TAB: HISTORY -->
    <div id="tab-history" class="tab-content" style="display:none;">
        <div class="card">
            <h2>Scan History</h2>
            
             <div class="stats-container" style="display:flex; gap:20px; align-items:center; margin-bottom: 20px;">
                <div class="stat-card" style="background:#eee; padding:10px; border-radius:4px;">
                    <div class="value" id="total-scans" style="font-weight:bold;font-size:1.2rem;">0</div>
                    <div class="label" style="font-size:0.8rem;">Total Scans</div>
                </div>
                <div class="stat-card" style="background:#eee; padding:10px; border-radius:4px;">
                    <div class="value" id="ignored-count" style="font-weight:bold;font-size:1.2rem;">0</div>
                    <div class="label" style="font-size:0.8rem;">Ignored Items</div>
                </div>
            </div>

            <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="secondary" onclick="exportWorkspace()">üíæ Export Workspace</button>
                <button class="secondary" onclick="document.getElementById('import-file').click()">üìÇ Import Workspace</button>
                <input type="file" id="import-file" style="display: none;" onchange="importWorkspace(this)">
            </div>

            <button onclick="loadHistory()">üîÑ Refresh List</button>
            <table id="history-table" style="width:100%; border-collapse:collapse; margin-top:1rem;">
                <thead>
                    <tr style="background:#f9f9f9; border-bottom:2px solid var(--primary-color);">
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">SCAN ID</th>
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">TYPE</th>
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">SOURCE</th>
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">DATE</th>
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">RESULTS</th>
                        <th style="padding:12px; text-align:left; color:var(--primary-color);">ACTIONS</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
 
 </div>
 
 <!-- Modals -->
 <div id="resultsModal" class="modal">
     <div class="modal-content">
         <span class="close-btn" onclick="document.getElementById('resultsModal').style.display='none'">&times;</span>
         <h2 id="modalTitle">Scan Results</h2>
         <div id="modalBody"></div>
         <button onclick="document.getElementById('resultsModal').style.display='none'" style="margin-top:20px;">Close</button>
     </div>
 </div>

 <div id="loading-overlay">
    <div class="loading-content">
        <div class="spinner"></div>
        <h2 style="color: var(--primary-color);">Processing...</h2>
        <p id="loading-text" style="color: #666;">Please wait...</p>
    </div>
 </div>
 
 <script>
     let currentStep = 1;
     let selectedGroup = null;
     let selectedProjects = [];
     
     // --- UI Controls ---
     function switchTab(tabName) {
         document.querySelectorAll('.tab-content').forEach(d => d.style.display = 'none');
         document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
         document.getElementById('tab-' + tabName).style.display = 'block';
         event.currentTarget.classList.add('active');
         if(tabName === 'history') loadHistory();
         
         // If moving to discovery, update display
         if(tabName === 'discovery') {
            document.getElementById('disp-gitlab-url').innerText = localStorage.getItem('apiguard_url') || 'https://gitlab.com';
         }
         // If moving to settings, populate
         if(tabName === 'settings') {
            document.getElementById('setting-url').value = localStorage.getItem('apiguard_url') || 'https://gitlab.com';
            document.getElementById('setting-token').value = localStorage.getItem('apiguard_token') || '';
         }
     }

     function setViewMode(mode) {
         const grid = document.getElementById('projects-grid');
         if(mode === 'list') grid.classList.add('list-view');
         else grid.classList.remove('list-view');
     }

     function showStep(step) {
         document.querySelectorAll('.wizard-step').forEach(d => d.classList.remove('active'));
         document.getElementById('step-' + step).classList.add('active');
         currentStep = step;
     }
     function nextStep(step) { 
         if(step === 4) populateReviewList();
         showStep(step); 
     }
     function prevStep(step) { showStep(step); }
     
     function populateReviewList() {
        const container = document.getElementById('review-project-list');
        if(!container) return;
        container.innerHTML = '';
        selectedProjects.forEach(p => {
             const div = document.createElement('div');
             div.style.padding = '4px 0';
             div.style.borderBottom = '1px solid #f9f9f9';
             div.innerText = '‚Ä¢ ' + p.name;
             container.appendChild(div);
        });
     }

     // --- API Utils ---
     function getApiPath(endpoint) {
        return window.location.pathname.includes('apiguard') 
            ? '/apiguard/apidiscovery/api' + endpoint 
            : '/api' + endpoint; // local fallback
     }
     
     // --- Settings Logic ---
     function saveSettings() {
        const url = document.getElementById('setting-url').value;
        const token = document.getElementById('setting-token').value;
        localStorage.setItem('apiguard_url', url);
        localStorage.setItem('apiguard_token', token);
        
        const msg = document.getElementById('save-msg');
        msg.style.display = 'inline';
        setTimeout(() => msg.style.display = 'none', 2000);
     }
     
     function getSettings() {
        const url = localStorage.getItem('apiguard_url') || 'https://gitlab.com';
        const token = localStorage.getItem('apiguard_token');
        if(!token) {
            alert("Please configure your Access Token in the Settings tab first.");
            switchTab('settings');
            throw new Error("Missing Token"); // Stop execution
        }
        return { url, token };
     }

     // --- Wizard Flow ---
     async function fetchGroups() {
         const { url, token } = getSettings();

         showLoading("Connecting to GitLab...");

         try {
             const res = await fetch(`${getApiPath('/gitlab/groups')}?token=${encodeURIComponent(token)}&baseUrl=${encodeURIComponent(url)}`);
             if(!res.ok) throw new Error("Failed to fetch groups. Check Token/Network.");
             const groups = await res.json();
             
             const grid = document.getElementById('groups-grid');
             grid.innerHTML = '';
             groups.forEach(g => {
                 const div = document.createElement('div');
                 div.className = 'grid-item';
                 div.innerHTML = `<h3>${g.name}</h3><p>${g.full_path}</p>`;
                 div.onclick = () => selectGroup(g);
                 grid.appendChild(div);
             });
             nextStep(2);
         } catch(e) {
             console.error(e);
             alert("Error: " + e.message);
         } finally {
             hideLoading();
         }
     }

     function manualGroupSelect() {
         const groupName = document.getElementById('manualGroupInput').value;
         if(!groupName) return alert("Enter a group name");
         selectGroup({ id: groupName, name: groupName, full_path: groupName });
     }
 
     async function selectGroup(group) {
         selectedGroup = group;
         // Update Breadcrumbs
         document.getElementById('bc-group-name').innerText = group.name;
         document.getElementById('bc-group-name-4').innerText = group.name;
         
         const token = document.getElementById('gitlabToken').value;

         showLoading(`Fetching projects for ${group.name}...`);

         try {
             const res = await fetch(`${getApiPath('/gitlab/projects')}?token=${encodeURIComponent(token)}&groupId=${group.id}`);
             const projects = await res.json();
             
             const grid = document.getElementById('projects-grid');
             grid.innerHTML = '';
             selectedProjects = [];
             
             if(projects.length === 0) grid.innerHTML = '<p>No projects found.</p>';

             projects.forEach(p => {
                 const div = document.createElement('div');
                 div.className = 'grid-item';
                 div.innerHTML = `
                     <div>
                        <h3>${p.name}</h3>
                        <p>${p.path_with_namespace || p.web_url}</p>
                     </div>
                     <button class="ignore-btn" onclick="event.stopPropagation(); ignoreItem('${p.http_url_to_repo}', this)">üö´ Ignore</button>
                 `;
                 div.dataset.id = p.id;
                 div.onclick = () => toggleProjectSelection(div, p);
                 grid.appendChild(div);
             });
             nextStep(3);
         } catch(e) {
             alert("Error fetching projects: " + e.message);
         } finally {
             hideLoading();
         }
     }
 
     function toggleProjectSelection(el, project) {
         if(el.classList.contains('selected')) {
             el.classList.remove('selected');
             selectedProjects = selectedProjects.filter(p => p.id !== project.id);
         } else {
             el.classList.add('selected');
             selectedProjects.push(project);
         }
         
         // Update selected count display if needed (added a badge logic or bottom bar could be cool)
         document.getElementById('review-target-count').innerText = selectedProjects.length;
     }
     
     function selectAllProjects() {
         document.querySelectorAll('#projects-grid .grid-item').forEach(el => {
            if (!el.classList.contains('selected')) el.click();
         });
     }
     
     function deselectAllProjects() {
         document.querySelectorAll('#projects-grid .grid-item').forEach(el => {
            if (el.classList.contains('selected')) el.click();
         });
     }
 
     async function startWizardScan() {
         if(selectedProjects.length === 0) return alert("No projects selected!");
         const token = document.getElementById('gitlabToken').value;
         const scanMode = document.getElementById('scanMode').value;
         
         showLoading("Initiating scans for " + selectedProjects.length + " projects...");
         const resultsContainer = document.getElementById('results-container');
         resultsContainer.innerHTML = '';
         
         const scanPromises = selectedProjects.map(async (proj) => {
             try {
                 // 1. Start Scan
                 const res = await fetch(getApiPath('/scan'), {
                     method: 'POST',
                     body: JSON.stringify({ 
                         source: proj.http_url_to_repo, 
                         token: token,
                         group: selectedGroup.name,
                         mode: scanMode
                     })
                 });
                 const data = await res.json(); // { scanId: ... }
                 if(data.error) throw new Error(data.error);
                 if(!data.scanId) throw new Error("No Scan ID returned (Unknown Backend Error)");
                 
                 // 2. Poll for Completion
                 return await pollScanProgress(data.scanId, proj.name);
                 
             } catch(e) {
                 console.error(e);
                 return { error: e.message, repoName: proj.name, technology: 'Error' };
             }
         });
 
         try {
             // Flatten results in case one scan returned multiple reports
             const rawResults = await Promise.all(scanPromises);
             const results = rawResults.flat();
             
             // Render Results
             results.forEach(r => {
                 let badge = r.error 
                    ? '<span class="badge" style="background:red">Failed</span>'
                    : `<span class="badge ${ (r.technology||'').toLowerCase().includes('mule') ? 'mule' : 'spring' }">${r.technology||'Unknown'}</span>`;
                 
                 const div = document.createElement('div');
                 div.className = 'grid-item';
                 div.style.cursor = 'default';
                 div.innerHTML = `
                     <h3>${badge} ${r.repoName}</h3>
                     ${r.error ? `<p style="color:red">${r.error}</p>` : `<p>Score: <strong>${r.governanceScore}/100</strong></p>`}
                     ${r.metadata ? `<p style="font-size:0.8rem">Owner: ${r.metadata.owner || 'N/A'}</p>` : ''}
                 `;
                 resultsContainer.appendChild(div);
             });
             
             hideLoading();
             nextStep(5); // Show Results Step
             
         } catch(e) {
             hideLoading();
             alert("Global Scan Error: " + e.message);
         }
     }
     
     async function startQuickScan() {
         const source = document.getElementById('quickSource').value;
         const { token } = getSettings(); // Uses global token
         const mode = document.getElementById('quickMode').value;
         
         if(!source) return alert("Please enter a URL or Path");
         
         showLoading("Starting Quick Scan...");
         const container = document.getElementById('quick-results-container');
         container.innerHTML = '';
         
         try {
             // 1. Start Scan
             const res = await fetch(getApiPath('/scan'), {
                 method: 'POST',
                 body: JSON.stringify({ 
                     source: source, 
                     token: token,
                     group: "QuickScan",
                     mode: mode
                 })
             });
             const data = await res.json();
             if(data.error) throw new Error(data.error);
             if(!data.scanId) throw new Error("No Scan ID returned");
             
             // 2. Poll
             const results = await pollScanProgress(data.scanId, source);
             const resultsArray = Array.isArray(results) ? results : [results]; // Ensure array
             
             // CRITICAL: Inject scanFolder from backend response into each result
             // The backend returns scanFolder in the progress object, we need to fetch it
             const progressRes = await fetch(getApiPath(`/progress?scanId=${data.scanId}`));
             const finalProgress = await progressRes.json();
             if(finalProgress.scanFolder) {
                 resultsArray.forEach(r => r.scanFolder = finalProgress.scanFolder);
             }

             // 3. Render
             
             // Sort: API Service first
             // Sort: API Service first, then Confidence (High to Low)
             resultsArray.sort((a,b) => {
                const isAMule = (a.classification === 'API Service');
                const isBMule = (b.classification === 'API Service');
                if(isAMule && !isBMule) return -1;
                if(!isAMule && isBMule) return 1;
                
                // Secondary: Confidence
                const sA = parseFloat(a.confidenceScore || a.governanceScore || 0);
                const sB = parseFloat(b.confidenceScore || b.governanceScore || 0);
                return sB - sA;
             });
             
             // Save for index-based access
             window.lastScanResults = resultsArray;

             // Calculate Stats
             const total = resultsArray.length;
             const identified = resultsArray.filter(r => r.confidenceScore > 0 || r.technology !== 'Unknown').length;
             const avgConf = Math.round(resultsArray.reduce((acc, r) => acc + (r.confidenceScore||0), 0) / (total||1));
             
             container.innerHTML = `
                <!-- Summary Cards -->
                <div style="display:flex; gap:20px; margin-bottom:20px;">
                    <div class="card" style="flex:1; text-align:center; padding:15px; border:2px solid var(--primary-color); margin:0;">
                         <div style="font-size:2rem; font-weight:bold; color:var(--primary-color);">${total}</div>
                         <div style="font-size:0.9rem; color:#666;">Total Repositories</div>
                    </div>
                    <div class="card" style="flex:1; text-align:center; padding:15px; border:2px solid var(--primary-color); margin:0;">
                         <div style="font-size:2rem; font-weight:bold; color:var(--primary-color);">${identified}</div>
                         <div style="font-size:0.9rem; color:#666;">Identified APIs</div>
                    </div>
                    <div class="card" style="flex:1; text-align:center; padding:15px; border:2px solid var(--primary-color); margin:0;">
                         <div style="font-size:2rem; font-weight:bold; color:var(--primary-color);">${avgConf}%</div>
                         <div style="font-size:0.9rem; color:#666;">Avg Confidence</div>
                    </div>
                </div>

                <h3 style="color:var(--primary-color)">Discovery Results (${total} Projects):</h3>
             `;
             
             let tableHtml = `
                <table style="width:100%; background:white; border-radius:8px; overflow:hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 2px solid var(--primary-color) !important;">
                    <tr style="background:#f9f9f9; text-transform:uppercase; font-size:0.85rem; color:var(--primary-color); border-bottom: 2px solid var(--primary-color) !important; font-weight:bold;">
                        <th style="padding:15px; color:var(--primary-color);">Repository</th>
                        <th style="color:var(--primary-color);">Technology</th>
                        <th style="color:var(--primary-color);">Classification</th>
                        <th style="color:var(--primary-color);">Confidence</th>
                        <th style="color:var(--primary-color);">Actions</th>
                    </tr>
             `;
             
             resultsArray.forEach((r, i) => {
                 const tech = r.technology || 'Unknown';
                 const isMule = tech.toLowerCase().includes('mule');
                 const score = r.confidenceScore || (r.governanceScore ? '100%' : '0%');
                 
                 // Classification Colors
                 let classStyle = 'background:#f5f5f5; color:#616161;'; // Default/Unknown
                 const cls = r.classification || (isMule ? 'API Service' : 'Standalone / Library');
                 
                 if(cls === 'API Service') classStyle = 'background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;'; // Green (Light)
                 else if(cls.includes('Standalone') || cls.includes('Library')) classStyle = 'background:#fff3e0; color:#ef6c00; border:1px solid #ffe0b2;'; // Orange
                 else if(cls.includes('Potential')) classStyle = 'background:#e3f2fd; color:#1565c0; border:1px solid #bbdefb;'; // Blue
                 
                 // Technology Colors
                 // Unknown types should not be green. Using gray/neutral.
                 let techStyle = '';
                 if(tech === 'Unknown' || tech === 'Unknown / Generic') {
                     techStyle = 'background:#f5f5f5; color:#757575; border:1px solid #e0e0e0; font-weight:normal;';
                 } else if(isMule) {
                     techStyle = 'background:#00a1df; color:white;';
                 } else {
                     techStyle = 'background:#6db33f; color:white;';
                 }

                 const scanId = r.scanId || r.scanFolder || data.scanId;
                 
                                   // Prepare evidence and indicators
                  const evidence = r.evidence || [];
                  const indicators = r.indicators || [];
                  const metadata = r.metadata || {};
                  
                  tableHtml += `
                     <tr id="row-${i}" style="border-bottom:1px solid #eee;">
                         <td style="padding:15px;">
                             <strong style="font-size:1rem; display:block; margin-bottom:4px;">${r.repoName}</strong>
                             <a href="${r.url || source}" target="_blank" style="color:#999; text-decoration:none; font-size:0.85rem;">${(r.url || source).substring(0, 50)}...</a>
                         </td>
                         <td><span class="badge" style="${techStyle}">${tech}</span></td>
                         <td><span style="padding:4px 8px; border-radius:4px; font-size:0.85rem; font-weight:500; ${classStyle}">${cls}</span></td>
                         <td style="color:green; font-weight:bold;">${score}</td>
                         <td>
                             <button class="small" onclick="toggleDetails(${i})" style="background:var(--primary-color);">Details</button>
                         </td>
                     </tr>
                     <tr id="detail-${i}" style="display:none;">
                         <td colspan="5" style="padding:0; background:#f9f9f9;">
                             <div style="padding:20px; border-left:4px solid var(--primary-color);">
                                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem;">
                                     <!-- Column 1: Identification & Capabilities -->
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üîç Identification & Capabilities</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             <strong>Evidence:</strong>
                                             <ul style="margin-top:0.5rem; padding-left:1.2rem;">
                                                 ${evidence.length > 0 ? evidence.map(e => `<li>${e}</li>`).join('') : '<li style="color:#999;">No evidence files detected</li>'}
                                             </ul>
                                             <strong style="margin-top:1rem; display:block;">Capabilities:</strong>
                                             <ul style="margin-top:0.5rem; padding-left:1.2rem;">
                                                 ${indicators.length > 0 ? indicators.map(ind => `<li>${ind}</li>`).join('') : '<li style="color:#999;">No API signatures found</li>'}
                                             </ul>
                                         </div>
                                     </div>
                                     
                                     <!-- Column 2: Governance Standards -->
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üìä Governance Standards</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             ${renderGovernanceCheck(metadata, 'Governance: Standards', 'RESTful Architecture')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Documentation', 'API Documentation')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Gateway', 'API Gateway Managed')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Security', 'Security Enforcement')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Versioning', 'Semantic Versioning')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Logging', 'Centralized Logging')}
                                         </div>
                                     </div>
                                     
                                     <!-- Column 3: Risk & Settings -->
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üî• Risk & Settings</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             ${renderOtherMetadata(metadata)}
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </td>
                     </tr>
                  `;
             });
             
             tableHtml += '</table>';
             container.innerHTML += tableHtml;
             
         } catch(e) {
             alert("Quick Scan Failed: " + e.message);
         } finally {
             hideLoading();
         }
     }

     async function pollScanProgress(scanId, projName) {
         // Show detailed progress UI
         const overlayContent = document.querySelector('#loading-overlay .loading-content');
         
         return new Promise((resolve) => {
             const interval = setInterval(async () => {
                 try {
                     const res = await fetch(getApiPath(`/progress?scanId=${scanId}`));
                     const progress = await res.json();
                     
                     // Update UI
                     const percent = progress.complete ? 100 : (progress.percent || 0);
                     const status = progress.message || 'Processing...';
                     
                     overlayContent.innerHTML = `
                        <div class="spinner"></div>
                        <h3 style="color:var(--primary-color)">Scanning ${projName}...</h3>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${percent}%"></div>
                        </div>
                        <p style="margin-top:5px; color:#666;">${status} (${percent}%)</p>
                     `;
                     
                     if (progress.complete) {
                         clearInterval(interval);
                         // Fetch Final Report
                         try {
                             const vRes = await fetch(`${getApiPath('/scans/view')}?scanName=${progress.scanFolder}`);
                             const reports = await vRes.json();
                             resolve(reports); // Return FULL array
                         } catch(e) {
                             resolve([{ repoName: projName, error: "Failed to load report: " + e.message }]);
                         }
                     }
                 } catch (e) {
                     console.error("Poll error", e);
                     // Don't stop polling on transient network error, but if many fail...
                 }
             }, 1000); // Poll every 2s
         });
     }
 
     // --- Correlation & History ---
     async function runCorrelation() {
         const input = document.getElementById('trafficInput').value;
         if(!input.trim()) return alert("Enter some traffic data");
         
         try {
             const res = await fetch(getApiPath('/correlate'), { method: 'POST', body: input });
             const results = await res.json();
             
             const container = document.getElementById('correlation-results');
             if(results.length === 0) {
                 container.innerHTML = "<h3>No matches found in scanned repositories.</h3>";
                 return;
             }
             
             let html = "<h3>Correlation Matches:</h3><table><tr><th>Traffic Item</th><th>Matched Repo</th><th>Confidence</th></tr>";
             results.forEach(r => {
                 html += `<tr><td>${r.traffic_item}</td><td><b>${r.matched_repo}</b></td><td>${r.confidence}</td></tr>`;
             });
             html += "</table>";
             container.innerHTML = html;
         } catch (e) { alert("Correlation error: " + e); }
     }
 
     async function ignoreItem(url, btnElement) {
         if(!confirm("Ignore this item?")) return;
         await fetch(getApiPath('/ignore'), { method: 'POST', body: url });
         // Visual removal
         if(btnElement) {
           const card = btnElement.closest('.grid-item');
           if(card) {
               card.style.opacity = '0.5';
               card.style.pointerEvents = 'none';
               // If selected, deselect
               if(card.classList.contains('selected')) card.click();
           }
         }
     }
 
     async function loadHistory() {
         try {
             showLoading("Loading History...");
             const res = await fetch(getApiPath('/scans/list'));
             if(!res.ok) throw new Error("API Error");
             const list = await res.json();
             
             const tbody = document.querySelector('#history-table tbody');
             tbody.innerHTML = '';
             
             if(list.length === 0) {
                 tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">No scans found. Run a scan to get started.</td></tr>';
                 document.getElementById('total-scans').innerText = '0';
                 hideLoading();
                 return;
             }
 
             // Sort by date (newest first)
             list.sort((a, b) => b.lastModified - a.lastModified);
             
             // Load scan details for each
             for (const item of list) {
                 const scanInfo = await getScanInfo(item.name);
                 const date = new Date(item.lastModified).toLocaleString();
                 
                 const tr = document.createElement('tr');
                 tr.style.borderBottom = '1px solid #eee';
                 tr.innerHTML = `
                     <td><strong>${item.name}</strong></td>
                     <td><span class="badge" style="background:${scanInfo.typeColor}; color:white; padding:4px 8px; border-radius:12px; font-size:0.8rem;">${scanInfo.type}</span></td>
                     <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${scanInfo.source}">${scanInfo.source}</td>
                     <td>${date}</td>
                     <td><strong>${scanInfo.count}</strong> repositories</td>
                     <td>
                         <button class="small" onclick="viewHistoryScan('${item.name}')" style="background:var(--primary-color); margin-right:5px;">View Results</button>
                         <button class="small" onclick="deleteScan('${item.name}')" style="background:#d32f2f;">Delete</button>
                     </td>
                 `;
                 tbody.appendChild(tr);
             }
 
             document.getElementById('total-scans').innerText = list.length;
             
             // Ignored stats
             try {
                 const iRes = await fetch(getApiPath('/ignore'));
                 const ignored = await iRes.json();
                 document.getElementById('ignored-count').innerText = ignored.length || 0;
             } catch(e) {
                 document.getElementById('ignored-count').innerText = '0';
             }
         } catch(e) {
             console.error("Load History Failed", e);
             document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="6" style="text-align:center; color:#d32f2f;">Error loading history. Ensure backend is running.</td></tr>';
         } finally {
            hideLoading();
         }
     }
 
     // Get scan information (type, source, count)
     async function getScanInfo(scanName) {
         try {
             const res = await fetch(getApiPath(`/scans/view?scanName=${scanName}`));
             const reports = await res.json();
             const arr = Array.isArray(reports) ? reports : [reports];
             
             if (arr.length === 1) {
                 return {
                     type: 'Quick Scan',
                     typeColor: '#00a1df',
                     source: arr[0].url || arr[0].repoPath || 'Local',
                     count: 1
                 };
             } else {
                 // Extract group/project from first result
                 const firstUrl = arr[0]?.url || '';
                 let source = 'Multiple repositories';
                 if (firstUrl.includes('gitlab.com')) {
                     const parts = firstUrl.split('/');
                     source = parts.slice(0, -1).join('/');
                 }
                 return {
                     type: 'API Discovery',
                     typeColor: '#663399',
                     source: source,
                     count: arr.length
                 };
             }
         } catch (e) {
             return { type: 'Unknown', typeColor: '#999', source: 'N/A', count: 0 };
         }
     }
     
     // View historical scan results
     async function viewHistoryScan(scanName) {
         try {
             showLoading('Loading scan results...');
             
             const res = await fetch(getApiPath(`/scans/view?scanName=${scanName}`));
             const reports = await res.json();
             const arr = Array.isArray(reports) ? reports : [reports];
             
             // Inject scanFolder for Details button
             arr.forEach(r => r.scanFolder = scanName);
             
             // Store in global variable
             window.lastScanResults = arr;
             
             // Render results in Quick Scan results container
             const container = document.getElementById('quick-results-container');
             if (!container) {
                 hideLoading();
                 throw new Error('Results container not found');
             }
             
             // Build results HTML (reuse Quick Scan rendering logic)
             let tableHtml = `
                 <h3 style="color:var(--primary-color); margin-top:2rem;">üìä Scan: ${scanName}</h3>
                 <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
                     <div style="background:white; padding:1.5rem; border-radius:8px; border:2px solid var(--primary-color); text-align:center;">
                         <div style="font-size:2rem; font-weight:bold; color:var(--primary-color);">${arr.length}</div>
                         <div style="color:#666; margin-top:0.5rem;">Total Repositories</div>
                     </div>
                     <div style="background:white; padding:1.5rem; border-radius:8px; border:2px solid var(--primary-color); text-align:center;">
                         <div style="font-size:2rem; font-weight:bold; color:var(--primary-color);">${arr.filter(r => r.classification === 'API Service').length}</div>
                         <div style="color:#666; margin-top:0.5rem;">Identified APIs</div>
                     </div>
                     <div style="background:white; padding:1.5rem; border-radius:8px; border:2px solid var(--primary-color); text-align:center;">
                         <div style="font-size:2rem; font-weight:bold; color:#28a745;">${Math.round(arr.reduce((sum, r) => sum + (parseFloat(r.confidenceScore || r.governanceScore || 0)), 0) / arr.length)}%</div>
                         <div style="color:#666; margin-top:0.5rem;">Avg Confidence</div>
                     </div>
                 </div>
                 <h3 style="color:var(--primary-color);">Discovery Results</h3>
                 <table style="width:100%; border-collapse:collapse; margin-top:1rem; border:2px solid var(--primary-color) !important;">
                     <thead>
                         <tr style="background:#f9f9f9; border-bottom:2px solid var(--primary-color) !important;">
                             <th style="padding:12px; text-align:left; color:var(--primary-color);">REPOSITORY</th>
                             <th style="padding:12px; text-align:left; color:var(--primary-color);">TECHNOLOGY</th>
                             <th style="padding:12px; text-align:left; color:var(--primary-color);">CLASSIFICATION</th>
                             <th style="padding:12px; text-align:left; color:var(--primary-color);">CONFIDENCE</th>
                             <th style="padding:12px; text-align:left; color:var(--primary-color);">ACTIONS</th>
                         </tr>
                     </thead>
                     <tbody>
             `;
             
             // Render each result row (same as Quick Scan)
             arr.forEach((r, i) => {
                 const tech = r.technology || 'Unknown';
                 const isMule = tech.toLowerCase().includes('mule');
                 const score = r.confidenceScore || r.governanceScore || 0;
                 
                 let classStyle = 'background:#f5f5f5; color:#616161;';
                 const cls = r.classification || (isMule ? 'API Service' : 'Standalone / Library');
                 
                 if(cls === 'API Service') classStyle = 'background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9;';
                 else if(cls.includes('Standalone') || cls.includes('Library')) classStyle = 'background:#fff3e0; color:#ef6c00; border:1px solid #ffe0b2;';
                 
                 let techStyle = '';
                 if(tech === 'Unknown' || tech === 'Unknown / Generic') {
                     techStyle = 'background:#f5f5f5; color:#757575; border:1px solid #e0e0e0; font-weight:normal;';
                 } else if(isMule) {
                     techStyle = 'background:#00a1df; color:white;';
                 } else {
                     techStyle = 'background:#6db33f; color:white;';
                 }
                 
                 const evidence = r.evidence || [];
                 const indicators = r.indicators || [];
                 const metadata = r.metadata || {};
                 
                 tableHtml += `
                     <tr id="row-${i}" style="border-bottom:1px solid #eee;">
                         <td style="padding:15px;">
                             <strong style="font-size:1rem; display:block; margin-bottom:4px;">${r.repoName}</strong>
                             <a href="${r.url || ''}" target="_blank" style="color:#999; text-decoration:none; font-size:0.85rem;">${(r.url || '').substring(0, 50)}...</a>
                         </td>
                         <td><span class="badge" style="${techStyle}">${tech}</span></td>
                         <td><span style="padding:4px 8px; border-radius:4px; font-size:0.85rem; font-weight:500; ${classStyle}">${cls}</span></td>
                         <td style="color:green; font-weight:bold;">${score}</td>
                         <td>
                             <button class="small" onclick="toggleDetails(${i})" style="background:var(--primary-color);">Details</button>
                         </td>
                     </tr>
                     <tr id="detail-${i}" style="display:none;">
                         <td colspan="5" style="padding:0; background:#f9f9f9;">
                             <div style="padding:20px; border-left:4px solid var(--primary-color);">
                                 <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 2rem;">
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üîç Identification & Capabilities</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             <strong>Evidence:</strong>
                                             <ul style="margin-top:0.5rem; padding-left:1.2rem;">
                                                 ${evidence.length > 0 ? evidence.map(e => `<li>${e}</li>`).join('') : '<li style="color:#999;">No evidence files detected</li>'}
                                             </ul>
                                             <strong style="margin-top:1rem; display:block;">Capabilities:</strong>
                                             <ul style="margin-top:0.5rem; padding-left:1.2rem;">
                                                 ${indicators.length > 0 ? indicators.map(ind => `<li>${ind}</li>`).join('') : '<li style="color:#999;">No API signatures found</li>'}
                                             </ul>
                                         </div>
                                     </div>
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üìä Governance Standards</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             ${renderGovernanceCheck(metadata, 'Governance: Standards', 'RESTful Architecture')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Documentation', 'API Documentation')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Gateway', 'API Gateway Managed')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Security', 'Security Enforcement')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Versioning', 'Semantic Versioning')}
                                             ${renderGovernanceCheck(metadata, 'Governance: Logging', 'Centralized Logging')}
                                         </div>
                                     </div>
                                     <div>
                                         <h4 style="margin-top:0; color: var(--primary-color);">üî• Risk & Settings</h4>
                                         <div style="background:white; padding:1rem; border-radius:8px; border:1px solid #eee;">
                                             ${renderOtherMetadata(metadata)}
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </td>
                     </tr>
                 `;
             });
             
             tableHtml += '</tbody></table>';
             container.innerHTML = tableHtml;
             
             // Hide loading before switching tabs
             hideLoading();
             
             // Switch to Quick Scan tab to show results
             switchTab('quick');
         } catch (e) {
             hideLoading();
             alert('Failed to load scan: ' + e.message);
         }
     }
     
     // Delete scan
     async function deleteScan(scanName) {
         if (!confirm(`Are you sure you want to delete scan "${scanName}"?\n\nThis action cannot be undone.`)) return;
         
         try {
             showLoading('Deleting scan...');
             
             const res = await fetch(getApiPath(`/scans/delete?scanName=${scanName}`), {
                 method: 'POST'
             });
             
             if (res.ok) {
                 alert('Scan deleted successfully');
                 loadHistory(); // Refresh list
             } else {
                 throw new Error('Delete failed');
             }
             
             hideLoading();
         } catch (e) {
             hideLoading();
             alert('Failed to delete scan: ' + e.message);
         }
     }
 
     
     // Toggle inline details display
     function toggleDetails(index) {
         const detailRow = document.getElementById(`detail-${index}`);
         if (detailRow) {
             detailRow.style.display = detailRow.style.display === 'table-row' ? 'none' : 'table-row';
         }
     }
     
     // Render governance check with status indicator
     function renderGovernanceCheck(metadata, key, label) {
         const exists = metadata && metadata[key];
         const statusIcon = exists ? '‚úì' : '‚úó';
         const statusColor = exists ? '#28a745' : '#dc3545';
         const statusText = exists ? metadata[key] : 'Not Detected';
         return `
             <div style="display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid #f0f0f0;">
                 <span style="font-weight:600; color:#555;">${label}</span>
                 <div style="font-size:0.85rem; color:${statusColor};">${statusIcon} ${statusText}</div>
             </div>
         `;
     }
     
     // Render other metadata (Risk & Settings)
     function renderOtherMetadata(metadata) {
         if (!metadata) return '<p style="color:#999;">No additional metadata available</p>';
         
         let html = '<ul style="margin:0; padding-left:1.2rem; list-style:none;">';
         for (const [key, value] of Object.entries(metadata)) {
             if (key.startsWith('Governance:')) continue; // Skip governance items
             
             let color = '#333';
             if (key.includes('Risk') && !value.includes('Safe')) color = '#dc3545'; // Red for Risk
             if (value.includes('Safe') || value.includes('Best Practice')) color = '#28a745'; // Green for Safe
             
             html += `<li style="margin-bottom:0.5rem;"><strong>${key}:</strong> <span style="color:${color}">${value}</span></li>`;
         }
         html += '</ul>';
         return html;
     }
     
     async function viewScan(scanName, filterRepoName) {
         console.log("DEBUG: viewScan called", { scanName, filterRepoName });
         showLoading("Loading Report...");
         try {
             const res = await fetch(`${getApiPath('/scans/view')}?scanName=${scanName}`);
             let reports = await res.json();
             
             // Ensure reports is an array
             if (reports && !Array.isArray(reports)) {
                 if (reports.error) throw new Error(reports.error);
                 reports = [reports]; 
             }
             if (!reports) reports = [];
             
             const modal = document.getElementById('resultsModal');
             const body = document.getElementById('modalBody');
             body.innerHTML = '';
             
             // If filterRepoName is provided, find that specific report
             const displayReports = filterRepoName ? reports.filter(r => r.repoName === filterRepoName) : reports;
             const targetReports = displayReports.length > 0 ? displayReports : reports; // Fallback to all if filter misses

             targetReports.forEach(r => {
                let techBadge = `<span class="badge ${r.technology.toLowerCase().includes('mule') ? 'mule' : 'spring'}">${r.technology}</span>`;
                body.innerHTML += `<div class="card" style="margin-bottom:10px; padding:10px; border:1px solid #ddd;">
                     <h3>${techBadge} ${r.repoName || 'Unknown Repo'}</h3>
                     <p><strong>Score:</strong> ${r.governanceScore}/100</p>
                     ${r.metadata ? '<p><strong>Metadata:</strong> <pre style="background:#eee;padding:5px;overflow:auto;">' + JSON.stringify(r.metadata, null, 2) + '</pre></p>' : ''}
                </div>`;
             });
             
             modal.style.display = 'flex';
         } catch(e) {
             alert("Load failed: " + e);
         } finally {
             hideLoading();
         }
     }
 
     // Export/Import
     async function exportWorkspace() {
         const res = await fetch(getApiPath('/state'));
         const json = await res.json();
         const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json, null, 2));
         const anchor = document.createElement('a');
         anchor.href = dataStr;
         anchor.download = "apidiscovery_workspace.json";
         document.body.appendChild(anchor);
         anchor.click();
         anchor.remove();
     }
     
     async function importWorkspace(input) {
         const file = input.files[0];
         if(!file) return;
         const reader = new FileReader();
         reader.onload = async function(e) {
             const json = e.target.result;
             await fetch(getApiPath('/state'), { method: 'POST', body: json });
             location.reload();
         };
         reader.readAsText(file);
     }
     
     // UI Helper
     function showLoading(msg) {
        document.getElementById('loading-text').innerText = msg;
        document.getElementById('loading-overlay').style.display = 'flex';
     }
     function hideLoading() {
        document.getElementById('loading-overlay').style.display = 'none';
     }

     window.onclick = function(event) {
          if (event.target == document.getElementById('resultsModal')) {
              document.getElementById('resultsModal').style.display = "none";
          }
      }
      // Override helpers for robustness
      function showLoading(msg) {
         const el = document.getElementById('loading-text');
         if(el) el.innerText = msg;
         else console.warn("ShowLoading: Missing loading-text");
         const ov = document.getElementById('loading-overlay');
         if(ov) ov.style.display = 'flex';
      }
      function hideLoading() {
         const ov = document.getElementById('loading-overlay');
         if(ov) ov.style.display = 'none';
      }
 </script>
 </body>
 </html>
